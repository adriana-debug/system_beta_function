<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script src="https://unpkg.com/feather-icons"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Roboto', 'sans-serif'] },
          colors: {
            // Updated brand and dark mode colors from campaign.html
            'brand-accent': '#CBEB33', 
            'brand-dark': '#B5D12F',   
            'bg-dark': '#0f172a',      
            'text-dark': '#f1f5f9',    
            'card-dark': '#1e293b',    
            'border-dark': '#334155',  
            'danger': '#ef4444',
            'bg-light': '#f8fafc',
            'text-light': '#1e293b'
          },
          boxShadow: {
            'brand-shadow': '0 8px 30px rgba(203, 235, 51, 0.4)',
          }
        }
      }
    }
  </script>

  <style>
    /* Styling for the KPI cards to match the modern look */
    .kpi-card { 
      transition: all 0.3s ease; 
      transform: translateY(0);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    }
    .kpi-card:hover { 
      transform: translateY(-6px); 
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); 
    }
    .dark .kpi-card {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
    }
    .dark .kpi-card:hover {
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 8px 10px -6px rgba(0, 0, 0, 0.4);
    }

    /* New style for the Heatmap squares */
    .heatmap-cell {
        padding: 0;
        line-height: 0;
    }
    .heatmap-square {
        display: block;
        height: 1rem; /* Adjust size as needed */
        width: 1rem;
        margin: auto;
        /* Remove gap for 'no space in between' effect */
    }
    
    .material-symbols-outlined { 
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48; 
    }
    
    /* Ensure the body starts in dark mode for the unified theme experience */
    body {
        @apply dark;
    }

    @media (min-width: 1280px) { .max-w-9xl { max-width: 1440px; } }
  </style>
</head>

<body class="min-h-screen bg-bg-light dark:bg-bg-dark text-text-light dark:text-text-dark font-sans transition-colors duration-500">

  <header class="flex flex-col md:flex-row items-start md:items-center gap-4 bg-white dark:bg-card-dark p-4 shadow sticky top-0 z-30 border-b border-gray-200 dark:border-border-dark">
    
    <div class="flex items-center gap-3 w-full md:w-auto pb-2 md:pb-0 border-b md:border-b-0 border-gray-100 dark:border-border-dark">
      <img src="dmi_logo.jpg" alt="Logo" class="w-8 h-8 rounded-full object-cover shadow-sm">
      <h1 id="pageTitle" class="text-xl font-extrabold text-gray-900 dark:text-text-dark">Attendance Dashboard</h1>
      
      <button id="themeToggle" aria-label="Toggle dark mode" class="md:hidden ml-auto p-2 rounded-full bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition-all duration-200">
        <span id="themeIcon" class="material-symbols-outlined text-xl">light_mode</span>
      </button>
    </div>

    <div class="flex-1 flex items-center justify-start">
      <div class="w-full max-w-3xl flex gap-3 items-center">
        <div class="relative flex-1 min-w-[120px]">
          <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-base">calendar_month</span>
          <select id="monthSelector" class="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-200 dark:border-border-dark shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-accent bg-white dark:bg-card-dark dark:text-text-dark text-sm transition-colors duration-300">
            <option value="" disabled>Select Month</option>
            <option value="1">January</option><option value="2">February</option><option value="3">March</option>
            <option value="4">April</option><option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option><option value="9">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
        </div>

        <div class="relative w-48">
          <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-base">groups</span>
          <select id="rosterSelector" class="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-200 dark:border-border-dark shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-accent bg-white dark:bg-card-dark dark:text-text-dark text-sm transition-colors duration-300">
            <option value="">All Teams</option>
          </select>
        </div>

        <button id="refreshBtn" title="Reload" class="p-2 rounded-xl bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition shadow-sm">
          <i class="material-symbols-outlined text-lg">refresh</i>
        </button>
      </div>
    </div>
    
    <div class="hidden md:block ml-auto">
      <button id="themeToggleDesktop" aria-label="Toggle dark mode" class="p-2 rounded-full bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition-all duration-200">
        <span id="themeIconDesktop" class="material-symbols-outlined text-xl">light_mode</span>
      </button>
    </div>
  </header>

  <main class="max-w-9xl mx-auto px-4 md:px-6 py-6">

    <div class="grid grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div class="bg-white dark:bg-card-dark rounded-2xl p-6 kpi-card border border-gray-200 dark:border-border-dark">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">Present</h2>
          <i data-feather="user-check" class="text-green-500"></i>
        </div>
        <p id="kpi-present" class="text-3xl font-extrabold mt-4 text-green-600 dark:text-green-400">0</p>
      </div>

      <div class="bg-white dark:bg-card-dark rounded-2xl p-6 kpi-card border border-gray-200 dark:border-border-dark">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">Absent</h2>
          <i data-feather="user-x" class="text-red-500"></i>
        </div>
        <p id="kpi-absent" class="text-3xl font-extrabold mt-4 text-red-600 dark:text-red-400">0</p>
      </div>

      <div class="bg-white dark:bg-card-dark rounded-2xl p-6 kpi-card border border-gray-200 dark:border-border-dark">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">Tardiness</h2>
          <i data-feather="clock" class="text-yellow-500"></i>
        </div>
        <p id="kpi-tardy" class="text-3xl font-extrabold mt-4 text-yellow-600 dark:text-yellow-400">0</p>
      </div>

      <div class="bg-white dark:bg-card-dark rounded-2xl p-6 kpi-card border border-gray-200 dark:border-border-dark">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">Planned Leave</h2>
          <i data-feather="activity" class="text-blue-500"></i>
        </div>
        <p id="kpi-leave" class="text-3xl font-extrabold mt-4 text-blue-600 dark:text-blue-400">0</p>
      </div>

      <div class="bg-white dark:bg-card-dark rounded-2xl p-6 kpi-card border border-gray-200 dark:border-border-dark">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">Attendance Score</h2>
          <i data-feather="pie-chart" class="text-brand-accent"></i>
        </div>
        <p id="kpi-score" class="text-3xl font-extrabold mt-4 text-brand-accent">0%</p>
      </div>
    </div>

    <div id="loading-spinner" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/30 dark:bg-black/50 transition-opacity duration-300">
      <div class="bg-white dark:bg-card-dark rounded-xl p-6 flex items-center gap-4 shadow-2xl">
        <svg class="animate-spin h-8 w-8 text-brand-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <div class="text-sm text-gray-700 dark:text-text-dark">Loading attendance dataâ€¦</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-6 gap-6 mb-8">
      <section class="lg:col-span-4 bg-white dark:bg-card-dark rounded-2xl p-6 border border-gray-200 dark:border-border-dark shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-gray-800 dark:text-text-dark">Team Attendance Summary</h3>
          <div class="text-sm text-gray-500 dark:text-gray-400">Monthly Aggregation</div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="table-head bg-gray-50 dark:bg-border-dark">
              <tr class="text-xs text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                <th class="px-4 py-3 text-left">Campaign / Team</th>
                <th class="px-4 py-3 text-center">Present</th>
                <th class="px-4 py-3 text-center">Late</th>
                <th class="px-4 py-3 text-center">Half Day</th>
                <th class="px-4 py-3 text-center">Absent</th>
                <th class="px-4 py-3 text-center">Score</th>
              </tr>
            </thead>
            <tbody id="campaign-summary-body" class="divide-y divide-gray-100 dark:divide-border-dark"></tbody>
          </table>
        </div>
      </section>

      <aside class="lg:col-span-2 bg-white dark:bg-card-dark rounded-2xl p-6 border border-gray-200 dark:border-border-dark shadow-sm">
        <h3 class="text-xl font-semibold text-gray-800 dark:text-text-dark mb-4">Legend</h3>
        <div class="grid grid-cols-2 gap-3 text-sm text-gray-700 dark:text-gray-300">
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#38761D] rounded-sm"></span><span>P â€“ Present</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#EF4444] rounded-sm"></span><span>A â€“ Absent</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#9CA3AF] rounded-sm"></span><span>Off â€“ Day Off</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#F59E0B] rounded-sm"></span><span>L â€“ Late</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#0000FF] rounded-sm"></span><span>VL â€“ Vac. Leave</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#8E7CC3] rounded-sm"></span><span>T â€“ Training</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#00FFFF] rounded-sm"></span><span>SUS â€“ Suspended</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#00FF00] rounded-sm"></span><span>HD â€“ Half Day</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#FACC15] rounded-sm"></span><span>L15 â€“ Late 15m</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#FB923C] rounded-sm"></span><span>L30 â€“ Late 30m</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#F97316] rounded-sm"></span><span>L45 â€“ Late 45m</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#EA580C] rounded-sm"></span><span>L60 â€“ Late 60m</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#6FA8DC] rounded-sm"></span><span>SL â€“ Sick Leave</span></div>
        </div>
      </aside>
    </div>

    <section class="mb-12">
      <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-text-dark">Daily Attendance Heatmap</h2>
      <div id="campaign-feed" class="space-y-6">
        </div>
    </section>

    <footer class="py-6 text-center text-sm text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-border-dark">
      &copy; 2025 Digital Minds BPO. All rights reserved.
    </footer>
  </main>

  <script>
    feather.replace();

    const BASE_URL = "https://script.google.com/macros/s/AKfycbxrwq6w72om22yz5zkHyDO-fhPxqlPBzlUsIjExrI3ZOB1J__Um1NlRJbih-_wFwihAhg/exec";

    // Status colors remain the same, but the shapes are now squares/blocks via CSS
    const statusColors = {
      P: "bg-[#38761D]", A: "bg-[#EF4444]", Off: "bg-[#9CA3AF]",
      L: "bg-[#F59E0B]", VL: "bg-[#0000FF]", T: "bg-[#8E7CC3]",
      SUS: "bg-[#00FFFF]", HD: "bg-[#00FF00]", L15: "bg-[#FACC15]",
      L30: "bg-[#FB923C]", L45: "bg-[#F97316]", L60: "bg-[#EA580C]",
      SL: "bg-[#6FA8DC]", NA: "bg-gray-200 dark:bg-gray-700" // Default for missing data
    };
    
    // --- API and Data Fetching ---

    async function loadClusters() {
      try {
        const res = await fetch(BASE_URL + "?api=clusters");
        const clusters = await res.json();
        const select = document.getElementById("rosterSelector");
        select.innerHTML = `<option value="">All Teams</option>`;
        clusters.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          select.appendChild(opt);
        });
      } catch (err) { console.error("Failed to load clusters:", err); }
    }

    async function loadAll() {
      const spinner = document.getElementById("loading-spinner");
      spinner.classList.remove("hidden"); // Show spinner

      const monthVal = document.getElementById("monthSelector").value;
      const clusterVal = document.getElementById("rosterSelector").value;

      try {
        // Fetch Summary Data
        const params = new URLSearchParams({ api:"summary", month:monthVal, cluster:clusterVal });
        const summary = await (await fetch(BASE_URL + "?" + params.toString())).json();
        renderKPIs(summary);
        renderCampaignSummary(summary);

        // Fetch Calendar/Heatmap Data
        const calParams = new URLSearchParams({ api:"calendars", month:monthVal, cluster:clusterVal });
        const calData = await (await fetch(BASE_URL + "?" + calParams.toString())).json();
        renderCalendars(calData);
        
      } catch (err) {
        console.error("Data loading failed:", err);
        // Optionally show a user-friendly error message here
      } finally {
        spinner.classList.add("hidden"); // Hide spinner
      }
    }
    
    // --- Rendering Functions ---

    function calculateEmployeeStats(statuses) {
        const stats = { P: 0, A: 0, L: 0, VL: 0, HD: 0, total: 0 };
        
        statuses.forEach(s => {
            if (s === 'P') stats.P++;
            else if (s === 'A') stats.A++;
            else if (s === 'VL' || s === 'SL' || s === 'T' || s === 'SUS') stats.VL++; // Count all planned/non-A leave under 'Planned Leave' for the summary table
            else if (s === 'HD') stats.HD++;
            else if (s.startsWith('L') && s !== 'VL') stats.L++; // Count any late status as one late day
            
            // Count total working/scheduled days (P, A, L*, HD) for score calculation
            if (s === 'P' || s === 'A' || s === 'HD' || s.startsWith('L') && s !== 'VL') {
                stats.total++;
            }
        });
        
        const score = stats.total > 0 ? ((stats.P / stats.total) * 100).toFixed(1) : "0.0";
        stats.score = score + "%";
        return stats;
    }

    function renderKPIs(summary) {
      const present = summary.overall.P || 0;
      const absent = summary.overall.A || 0;
      const halfDay = summary.overall.HD || 0;
      const late = (summary.overall.L || 0) + (summary.overall.L15 || 0) + (summary.overall.L30 || 0) + (summary.overall.L45 || 0) + (summary.overall.L60 || 0);
      
      // VL, SL, T, SUS are grouped under 'Planned Leave'
      const plannedLeave = (summary.overall.VL || 0) + (summary.overall.SL || 0) + (summary.overall.T || 0) + (summary.overall.SUS || 0);
      
      const totalForScore = present + absent + halfDay + late; // The base for attendance score usually excludes planned leaves and day-offs, only considering scheduled days where a status (P, L, HD, A) is expected.
      
      document.getElementById("kpi-present").textContent = present;
      document.getElementById("kpi-absent").textContent = absent;
      document.getElementById("kpi-tardy").textContent = late;
      document.getElementById("kpi-leave").textContent = plannedLeave;
      
      document.getElementById("kpi-score").textContent =
        (totalForScore > 0 ? ((present / totalForScore) * 100).toFixed(1) : 0) + "%";
    }

    function renderCampaignSummary(summary) {
      const tbody = document.getElementById("campaign-summary-body");
      tbody.innerHTML = "";
      const campaigns = summary.campaigns || {};

      Object.entries(campaigns).forEach(([campaign, stats]) => {
        // Group all late types
        const totalLate = (stats.L || 0) + (stats.L15 || 0) + (stats.L30 || 0) + (stats.L45 || 0) + (stats.L60 || 0);
        // Calculate total scheduled days (P, L*, HD, A)
        const totalScheduled = (stats.P || 0) + totalLate + (stats.HD || 0) + (stats.A || 0);
        
        const score = totalScheduled > 0 ? ((stats.P / totalScheduled) * 100).toFixed(1) + "%" : "0.0%";

        const row = `
          <tr class="hover:bg-gray-50 dark:hover:bg-border-dark/50 transition-colors">
            <td class="px-4 py-3 font-medium text-gray-800 dark:text-text-dark">${campaign}</td>
            <td class="px-4 py-3 text-center text-green-600 dark:text-green-400">${stats.P || 0}</td>
            <td class="px-4 py-3 text-center text-yellow-600 dark:text-yellow-400">${totalLate}</td>
            <td class="px-4 py-3 text-center text-blue-600 dark:text-blue-400">${stats.HD || 0}</td>
            <td class="px-4 py-3 text-center text-red-600 dark:text-red-400">${stats.A || 0}</td>
            <td class="px-4 py-3 text-center font-bold text-brand-accent">${score}</td>
          </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    function renderCalendars(data) {
      const feed = document.getElementById("campaign-feed");
      feed.innerHTML = "";

      Object.entries(data).forEach(([campaign, employees]) => {
        let employeeRows = '';
        
        Object.entries(employees).forEach(([name, statuses]) => {
            const stats = calculateEmployeeStats(statuses);
            
            // Start Employee Row
            let statusCells = '';
            statuses.forEach((s) => {
              const colorClass = statusColors[s] || statusColors['NA'];
              statusCells += `<td class="heatmap-cell h-4 w-4"><div class="heatmap-square ${colorClass}"></div></td>`;
            });
            
            // Employee Row with summary added to the right
            employeeRows += `
                <tr class="border-t border-gray-100 dark:border-border-dark text-center text-xs hover:bg-gray-50 dark:hover:bg-border-dark/50 transition-colors">
                    <td class="sticky left-0 bg-white dark:bg-card-dark px-3 py-2 text-left font-medium text-gray-700 dark:text-text-dark text-sm border-r dark:border-border-dark whitespace-nowrap">${name}</td>
                    
                    ${statusCells}
                    
                    <td class="sticky right-0 bg-gray-50 dark:bg-card-dark/80 px-3 py-2 text-right font-bold text-sm border-l dark:border-border-dark whitespace-nowrap">
                        <span class="text-green-500 mr-2">${stats.P} P</span>
                        <span class="text-red-500 mr-2">${stats.A} A</span>
                        <span class="text-yellow-500 mr-2">${stats.L} L</span>
                        <span class="text-blue-500 mr-2">${stats.VL} VL</span>
                        <span class="text-brand-accent font-extrabold">${stats.score}</span>
                    </td>
                </tr>`;
        });
        
        // Build the full table for the campaign
        const tableHtml = `
          <div class="bg-white dark:bg-card-dark border border-gray-200 dark:border-border-dark rounded-2xl shadow-lg overflow-x-auto relative">
            <div class="p-4 border-b border-gray-200 dark:border-border-dark flex justify-between items-center sticky left-0 z-10 bg-white dark:bg-card-dark">
              <h3 class="text-lg font-semibold text-gray-800 dark:text-text-dark">${campaign}</h3>
            </div>
            
            <table class="min-w-full text-xs border-collapse">
              <thead class="table-head bg-gray-50 dark:bg-border-dark sticky top-0 z-10 shadow-sm">
                <tr class="text-gray-600 dark:text-gray-300 uppercase">
                  <th class="sticky left-0 bg-gray-50 dark:bg-border-dark px-3 py-2 text-left w-[150px] border-r dark:border-border-dark">Employee</th>`;
        
        // Day Headers
        for (let d = 1; d <= 31; d++) {
            tableHtml += `<th class="px-1 py-2 text-center">${d}</th>`;
        }
        
        tableHtml += `
                  <th class="sticky right-0 bg-gray-50 dark:bg-border-dark px-3 py-2 text-right w-[200px] border-l dark:border-border-dark">Stats (P A L VL Score)</th>
                </tr>
              </thead>
              <tbody>
                ${employeeRows}
              </tbody>
            </table>
          </div>`;
        feed.insertAdjacentHTML("beforeend", tableHtml);
      });
    }

    // === Default filter (current month + Admin) ===
    function setDefaultFilters() {
      const now = new Date();
      const month = now.getMonth() + 1;
      const monthSelector = document.getElementById("monthSelector");
      monthSelector.value = month;

      const rosterSelector = document.getElementById("rosterSelector");
      rosterSelector.value = "Admin"; // Set to a default value if needed, otherwise leave blank for 'All Teams'
    }

    // === Dark Mode Toggle ===
    const toggleMobile = document.getElementById("themeToggle");
    const toggleDesktop = document.getElementById("themeToggleDesktop");
    
    function updateThemeIcon(isDark) {
        const iconName = isDark ? "light_mode" : "dark_mode";
        document.getElementById("themeIcon").textContent = iconName;
        document.getElementById("themeIconDesktop").textContent = iconName;
    }

    function toggleTheme() {
        const isDark = document.body.classList.toggle("dark");
        updateThemeIcon(isDark);
        localStorage.setItem("theme", isDark ? "dark" : "light");
    }
    
    toggleMobile.addEventListener("click", toggleTheme);
    toggleDesktop.addEventListener("click", toggleTheme);

    // Initial theme setup (set to dark by default)
    document.body.classList.add("dark");
    updateThemeIcon(true);
    
    // === Event Listeners ===
    document.getElementById("refreshBtn").addEventListener("click", loadAll);
    document.getElementById("monthSelector").addEventListener("change", loadAll);
    document.getElementById("rosterSelector").addEventListener("change", loadAll);

    // === Initialize ===
    window.addEventListener("DOMContentLoaded", async () => {
      await loadClusters();
      setDefaultFilters();
      loadAll();
    });
  </script>
</body>
</html>