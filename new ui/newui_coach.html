<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employee Performance & Disciplinary Logs</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'sans-serif'],
          },
          colors: {
            'google-blue': '#4285F4',
            'brand-accent': '#CBEB33',
            'brand-dark': '#B5D12F',
            'bg-dark': '#0f172a',
            'text-dark': '#f1f5f9',
            'card-dark': '#1e293b',
            'border-dark': '#334155',
            'danger': '#ef4444',
          }
        }
      }
    }

    // Generate DocID based on current modal/form values (used by UI)
    function generateDocIdForForm() {
      try {
        const docType = document.getElementById('documentType') ? document.getElementById('documentType').value : 'Coaching Log';
        const campaign = document.getElementById('campaign') ? document.getElementById('campaign').value : '';
        const dateVal = document.getElementById('coachingDate') ? document.getElementById('coachingDate').value : '';
        const candidate = {
          DocumentType: docType,
          Campaign: campaign,
          Date: dateVal
        };
        return generateReferenceId(candidate);
      } catch (error) {
        console.error('Failed to generate DocID for form:', error);
        return '';
      }
    }

    // Attach generate button if present
    const genBtn = document.getElementById('generateDocIdBtn');
    if (genBtn) {
      genBtn.addEventListener('click', () => {
        const doc = generateDocIdForForm();
        if (doc) {
          const display = document.getElementById('docIdDisplay');
          const hidden = document.getElementById('docId');
          if (display) display.value = doc;
          if (hidden) hidden.value = doc;
        }
      });
    }

    // Copy Doc ID to clipboard (used by table buttons)
    function copyDocIdToClipboard(id) {
      if (!id) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(id).then(() => {
          showToast('Doc ID copied to clipboard', 'success');
        }).catch((err) => {
          console.error('Clipboard write failed:', err);
          showToast('Failed to copy Doc ID', 'error');
        });
      } else {
        // Fallback
        const tmp = document.createElement('input');
        document.body.appendChild(tmp);
        tmp.value = id;
        tmp.select();
        document.execCommand('copy');
        document.body.removeChild(tmp);
        showToast('Doc ID copied to clipboard', 'success');
      }
    }
  </script>
  <style>
    :root {
      --page-bg: #f5f7fb;
      --card-bg: #ffffff;
      --card-border: #e5e7eb;
      --card-shadow: 0 20px 60px rgba(15, 23, 42, 0.06);
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-strong: #1d4ed8;
      --accent-soft: #e3edff;
      --pill: #f3f4f6;
    }

    @page {
      size: 8.5in 14in;
      margin: 1in 0.5in 0.5in 0.5in;
    }

    .animate-spin-slow {
      animation: spin 2.5s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Enhanced loader provided by user */
    .loader {
      width: 64px;
      height: 64px;
      position: relative;
      animation: rotate 1.5s ease-in infinite alternate;
      display: inline-block;
    }
    .loader::before {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      color: currentColor;
      background: currentColor;
      width: 64px;
      height: 32px;
      border-radius: 0 0 50px 50px;
    }
    .loader::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 10%;
      background: #FFF;
      width: 8px;
      height: 64px;
      transform-origin: 4px 32px; /* center of the white bar */
      animation: rotate 1.2s linear infinite alternate-reverse;
    }

    @keyframes rotate {
      100% { transform: rotate(360deg)}
    }

    /* Smaller loader for compact contexts */
    .loader.small {
      width: 40px;
      height: 40px;
    }
    .loader.small::before { width: 40px; height: 20px; }
    .loader.small::after { width: 6px; height: 40px; top: 8%; left: 50%; transform-origin: 3px 20px; }

    .oldschool-loader {
      display: grid;
      grid-template-columns: repeat(4, 10px);
      gap: 6px;
      align-items: end;
      justify-content: center;
      height: 28px;
    }

    .oldschool-loader span {
      display: block;
      width: 10px;
      height: 10px;
      background: #2563eb;
      border-radius: 3px;
      animation: bounce 0.8s infinite ease-in-out;
    }

    .oldschool-loader span:nth-child(2) { animation-delay: 0.1s; }
    .oldschool-loader span:nth-child(3) { animation-delay: 0.2s; }
    .oldschool-loader span:nth-child(4) { animation-delay: 0.3s; }

    @keyframes bounce {
      0%, 100% { height: 10px; opacity: 0.6; transform: translateY(0); }
      50% { height: 24px; opacity: 1; transform: translateY(-6px); }
    }

    .modal {
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      #printContainer, #printContainer * {
        visibility: visible;
      }
      #printContainer {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      .no-print {
        display: none !important;
      }
      @page {
        size: 8.5in 11in;
        margin: 0.5in;
      }
      .print-document {
        box-shadow: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
      }
      img {
        max-width: 100% !important;
        max-height: 40px !important;
        height: auto !important;
      }
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .toast {
      background: #065f46;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      pointer-events: auto;
      font-size: 14px;
    }

    .toast.success { background: #065f46; }
    .toast.error { background: #7f1d1d; }
    .toast.warning { background: #78350f; }

    .confirm-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .confirm-modal {
      background: white;
      color: #111827;
      border-radius: 10px;
      width: 460px;
      max-width: 90%;
      padding: 18px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
    }

    .confirm-modal h3 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .confirm-modal p {
      margin: 0 0 14px;
      color: #374151;
    }

    .confirm-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .confirm-btn {
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .confirm-btn.primary {
      background: #065f46;
      color: white;
    }

    .confirm-btn.ghost {
      background: #f3f4f6;
      color: #111827;
    }

    .dark .confirm-modal {
      background: #1e293b;
      color: #f1f5f9;
    }

    .dark .confirm-modal p {
      color: #cbd5e1;
    }

    body {
      background: var(--page-bg);
      color: #0f172a;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      letter-spacing: -0.01em;
      font-size: 14px;
    }

    .page-hero {
      background: #fff;
      border: 1px solid #dcdde1;
      border-radius: 14px;
      padding: 16px 18px;
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .page-hero .title-wrap {
      display: flex;
      gap: 14px;
      align-items: center;
    }

    .logo-pill {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: linear-gradient(180deg, #ffffff 0%, #e5e7eb 100%);
      color: #111827;
      display: grid;
      place-items: center;
      font-weight: 700;
      letter-spacing: -0.02em;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.9), 0 8px 18px rgba(0, 0, 0, 0.08);
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }

    .hero-title {
      margin: 2px 0 2px;
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
    }

    .hero-subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .kpi-card {
      background: #fff;
      border: 1px solid #dcdde1;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.05);
    }

    .kpi-label {
      margin: 0;
      font-size: 12px;
      letter-spacing: 0.02em;
      color: #6b7280;
      text-transform: uppercase;
    }

    .kpi-value {
      margin: 2px 0 0;
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
    }

    .kpi-meta {
      margin: 2px 0 0;
      font-size: 12px;
      color: #9ca3af;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-left: auto;
      flex-wrap: wrap;
    }

    .primary-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 11px 16px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 10px 28px rgba(37, 99, 235, 0.18);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .primary-btn:hover {
      background: var(--primary-strong);
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(37, 99, 235, 0.28);
    }

    .ghost-icon {
      border: none;
      background: transparent;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: #111827;
      transition: color 0.2s ease, transform 0.2s ease;
    }

    .ghost-icon:hover {
      color: var(--primary);
      transform: translateY(-1px);
    }

    .surface {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.05);
    }

    .tabs-card {
      padding: 14px 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 20px;
    }

    .tab-button {
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: var(--pill);
      color: #0f172a;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .tab-button:hover {
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.14);
      background: #fff;
    }

    .tab-button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.26);
    }

    .tab-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .chip {
      background: var(--pill);
      border: 1px solid var(--card-border);
      padding: 9px 14px;
      border-radius: 12px;
      color: #1f2937;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06);
    }

    .chip:hover {
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: 0 12px 26px rgba(37, 99, 235, 0.16);
      background: #fff;
    }

    .layout-toggle {
      display: inline-flex;
      gap: 8px;
      background: #f8fafc;
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 6px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
    }

    .layout-toggle .chip {
      border: none;
      background: transparent;
      padding: 8px 10px;
      box-shadow: none;
    }

    .layout-toggle .chip.active {
      background: #fff;
      color: var(--primary);
      border: 1px solid var(--card-border);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    .controls-card {
      padding: 10px 12px;
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
      overflow-x: auto;
      scrollbar-width: thin;
    }

    .search-field {
      flex: 1 1 320px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f9fafb;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 7px 10px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .search-field input {
      width: 100%;
      border: none;
      background: transparent;
      outline: none;
      font-size: 15px;
      color: #0f172a;
    }

    .search-field input::placeholder {
      color: #9ca3af;
    }

    .control-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .select-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f9fafb;
      border: 1px solid #d1d5db;
      padding: 7px 9px;
      border-radius: 10px;
      font-weight: 600;
      color: #1f2937;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .pill-select {
      border: none;
      background: transparent;
      outline: none;
      font-weight: 600;
      color: #111827;
      padding: 6px 4px;
    }

    .pill-select option {
      font-weight: 500;
    }

    .table-card {
      margin-top: 16px;
      overflow: hidden;
      padding: 0;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 720px;
      background: #fff;
    }

    .data-table thead th {
      background: #eceff3;
      color: #111827;
      font-size: 11.5px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-weight: 700;
      padding: 9px 9px;
      border-bottom: 1px solid #d1d5db;
    }

    .data-table tbody tr {
      border-bottom: 1px solid #e5e7eb;
      transition: background 0.12s ease;
    }

    .data-table tbody tr:hover {
      background: #f4f6f9;
    }

    .data-table tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .data-table td {
      padding: 9px 9px;
      font-size: 13px;
      color: #111827;
    }

    .dark body {
      background: #0f172a;
      color: #e2e8f0;
    }

    .dark .page-hero,
    .dark .surface {
      background: #1e293b;
      border-color: #334155;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.3);
    }

    .dark .hero-title {
      color: #e5e7eb;
    }

    .dark .kpi-card {
      background: #0f172a;
      border-color: #334155;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
    }

    .dark .kpi-value {
      color: #e5e7eb;
    }

    .dark .kpi-meta,
    .dark .kpi-label {
      color: #cbd5e1;
    }

    .dark .hero-subtitle,
    .dark .eyebrow {
      color: #cbd5e1;
    }

    .dark .logo-pill {
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      color: #e2e8f0;
    }

    .dark .primary-btn {
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.36);
    }

    .dark .ghost-icon {
      background: #0f172a;
      border-color: #334155;
      color: #e5e7eb;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.45);
    }

    .dark .tabs-card,
    .dark .controls-card {
      background: #1e293b;
    }

    .dark .tab-button {
      background: #0f172a;
      color: #e2e8f0;
      border-color: #334155;
    }

    .dark .tab-button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      box-shadow: 0 12px 28px rgba(37, 99, 235, 0.36);
    }

    .dark .chip {
      background: #0f172a;
      color: #e2e8f0;
      border-color: #334155;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
    }

    .dark .chip:hover {
      color: #bfdbfe;
      border-color: var(--primary);
    }

    .dark .select-wrap {
      background: #0f172a;
      border-color: #334155;
      color: #e2e8f0;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
    }

    .dark .pill-select {
      color: #e2e8f0;
    }

    .dark .layout-toggle {
      background: #0f172a;
      border-color: #334155;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }

    .dark .layout-toggle .chip.active {
      background: #1e293b;
      color: #bfdbfe;
    }

    .dark .search-field {
      background: #0f172a;
      border-color: #334155;
    }

    .dark .search-field input {
      color: #e2e8f0;
    }

    .dark .data-table thead th {
      background: #0f172a;
      color: #cbd5e1;
      border-color: #334155;
    }

    .dark .data-table tbody tr {
      border-color: #334155;
    }

    .dark .data-table tbody tr:nth-child(even) {
      background: #111827;
    }

    .dark .data-table td {
      color: #e2e8f0;
    }
  </style>
</head>

<body class="min-h-screen text-gray-800 font-sans dark:bg-bg-dark dark:text-text-dark">

  <header class="page-hero">
    <div class="title-wrap">
      <div class="logo-pill"><i class="fa-solid fa-clipboard-check"></i></div>
      <div>
        <p class="eyebrow">Performance & Coaching</p>
        <h1 class="hero-title">Coaching Logs</h1>
        <p class="hero-subtitle">Track coaching entries, acknowledgements, and signatures in one place.</p>
      </div>
    </div>
    <div class="header-actions">
      <button id="newCoachingBtn" class="primary-btn">
        <i class="fa-solid fa-plus"></i>
        New Coaching Log
      </button>
      <button id="themeToggle" class="ghost-icon" aria-label="Toggle Dark Mode"></button>
    </div>
  </header>

  <main id="mainContent" class="max-w-[1600px] mx-auto p-6 lg:p-10 space-y-4">
    <section class="kpi-grid">
      <div class="kpi-card">
        <p class="kpi-label">Total Logs</p>
        <p class="kpi-value" id="kpiTotal">--</p>
        <p class="kpi-meta">All coaching records</p>
      </div>
      <div class="kpi-card">
        <p class="kpi-label">Pending Ack</p>
        <p class="kpi-value" id="kpiPending">--</p>
        <p class="kpi-meta">Awaiting acknowledgement</p>
      </div>
      <div class="kpi-card">
        <p class="kpi-label">Signed Today</p>
        <p class="kpi-value" id="kpiToday">--</p>
        <p class="kpi-meta">New signatures</p>
      </div>
      <div class="kpi-card">
        <p class="kpi-label">Warnings</p>
        <p class="kpi-value" id="kpiWarnings">--</p>
        <p class="kpi-meta">Verbal/Written/Final</p>
      </div>
    </section>

    <div class="surface controls-card">
      <div class="search-field">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" id="coachingSearch" onkeyup="handleCoachingSearch()" placeholder="Search employees, supervisors, or document type..." />
      </div>
      <div class="control-actions">
        <label class="select-wrap">
          <span><i class="fa-solid fa-filter"></i> Doc Type</span>
          <select id="filterDocType" class="pill-select">
            <option value="all">All document types</option>
            <option value="Coaching Log">Coaching Log</option>
            <option value="Verbal Warning">Verbal Warning</option>
            <option value="Written Warning">Written Warning</option>
            <option value="Final Warning">Final Warning</option>
            <option value="4th Written Warning">4th Written Warning</option>
            <option value="1 Day Suspension">1 Day Suspension</option>
            <option value="3 Day Suspension">3 Day Suspension</option>
            <option value="Dismissal">Dismissal</option>
            <option value="Incident Report">Incident Report</option>
            <option value="Notice to Explain">Notice to Explain</option>
          </select>
        </label>
        <label class="select-wrap">
          <span><i class="fa-solid fa-briefcase"></i> Campaign</span>
          <select id="filterCampaign" class="pill-select">
            <option value="all">All campaigns</option>
          </select>
        </label>
        <label class="select-wrap">
          <span><i class="fa-solid fa-circle-check"></i> Ack</span>
          <select id="filterAck" class="pill-select">
            <option value="all">All</option>
            <option value="Yes">Acknowledged</option>
            <option value="Draft">Draft</option>
            <option value="No">Not acknowledged</option>
          </select>
        </label>
        <label class="select-wrap">
          <span><i class="fa-solid fa-arrow-up-wide-short"></i> Sort</span>
          <select id="sortBy" class="pill-select">
            <option value="date_desc">Newest first</option>
            <option value="date_asc">Oldest first</option>
            <option value="employee_asc">Employee A → Z</option>
            <option value="employee_desc">Employee Z → A</option>
          </select>
        </label>
        <a id="pipBtn" href="https://script.google.com/macros/s/AKfycbyWehC257U1Hx7EmcfSbDwZmabYx0txoxoeK2oyl5Z8VN65U6-zComsRpszRVfzLm6b/exec" target="_blank" class="chip no-underline">
          <i class="fas fa-arrow-up-right-from-square"></i> PIP
        </a>
      </div>
    </div>

    <div class="surface table-card relative">

      <div id="coachingLoadingSpinner" class="hidden absolute inset-0 bg-white/90 dark:bg-card-dark/90 backdrop-blur-sm flex justify-center items-center z-40">
          <div class="flex flex-col items-center">
            <span class="loader text-brand-accent"></span>
            <p id="coachingLoadingText" class="mt-3 text-lg text-gray-700 dark:text-text-dark font-medium">Loading records...</p>
          </div>
      </div>

      <div class="table-wrapper">
        <table class="data-table text-sm">
          <thead>
            <tr>
              <th class="text-left">Doc ID</th>
              <th class="text-left">Date</th>
              <th class="text-left">Campaign</th>
              <th class="text-left">Document Type</th>
              <th class="text-left">Supervisor</th>
              <th class="text-left">Employee</th>
              <th class="text-left">Emp #</th>
              <th class="text-center">Ack</th>
              <th class="text-center">Signature</th>
              <th class="text-center">Form</th>
              <th class="text-center">Evidence</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="coachingTable" class="text-gray-700 dark:text-gray-300">
            <tr>
              <td colspan="12" class="text-center py-6 text-gray-500 dark:text-gray-400">Loading records...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Global Loading Spinner (covers the full browser viewport) -->
  <div id="globalLoadingSpinner" class="hidden fixed inset-0 bg-black/35 backdrop-blur-sm flex justify-center items-center z-[9990] pointer-events-auto">
      <div class="flex flex-col items-center pointer-events-auto bg-white/98 dark:bg-card-dark/95 rounded-xl p-6 shadow-2xl border border-gray-200 dark:border-border-dark">
        <div class="oldschool-loader">
          <span></span><span></span><span></span><span></span>
        </div>
        <p id="globalLoadingText" class="mt-4 text-base text-gray-700 dark:text-text-dark font-semibold tracking-tight">Loading records...</p>
      </div>
  </div>

  <div id="confirmModalBackdrop" class="confirm-modal-backdrop" style="display:none;" role="dialog" aria-modal="true">
    <div class="confirm-modal" role="document">
      <h3 id="confirmModalTitle">Confirm</h3>
      <p id="confirmModalMessage">Are you sure?</p>
      <div class="confirm-actions">
        <button id="confirmCancelBtn" class="confirm-btn ghost">Cancel</button>
        <button id="confirmOkBtn" class="confirm-btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Paper View Modal -->
  <div id="paperViewModal" class="modal hidden fixed inset-0 z-[100] bg-gray-100 overflow-y-auto" role="dialog" aria-modal="true">
    <header class="no-print flex items-center gap-4 bg-white dark:bg-card-dark p-4 shadow-md sticky top-0 z-30 border-b border-gray-100 dark:border-border-dark">
      <button id="backBtn" class="inline-flex items-center p-2 rounded-full text-gray-800 dark:text-text-dark bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition-all duration-300 transform hover:scale-105">
        <i class="fas fa-arrow-left text-xl"></i>
      </button>
      <img src="https://digitalmindsbpo.com/storage/2018/11/cropped-dm-favicon.png" alt="Digital Minds BPO Logo" class="h-14 object-contain" onerror="this.style.display='none'" />
      <h1 class="text-2xl font-extrabold text-gray-900 dark:text-text-dark">Document Preview</h1>
      <button id="printDashboard" class="ml-auto inline-flex items-center p-2 rounded-full text-gray-800 dark:text-text-dark bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition-all duration-300 transform hover:scale-105">
        <i class="fas fa-print text-xl"></i>
      </button>
    </header>

    <div class="min-h-screen p-4 lg:p-8">
      <div id="paperDocument" class="print-document max-w-4xl mx-auto bg-white shadow-2xl rounded-lg p-12 text-base leading-relaxed"></div>
      <div id="paperViewSpinner" class="hidden absolute inset-0 bg-white/80 dark:bg-card-dark/80 flex justify-center items-center z-[10000] rounded-lg">
        <div class="flex flex-col items-center">
          <span class="loader text-brand-accent"></span>
          <p id="paperLoadingText" class="mt-3 text-lg text-gray-700 dark:text-text-dark font-medium">Preparing document preview...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="coachingModal" class="modal hidden fixed inset-0 z-[100] bg-black bg-opacity-50 flex items-center justify-center opacity-0 scale-95" role="dialog" aria-modal="true">
    <div class="bg-white dark:bg-card-dark rounded-xl shadow-3xl w-full max-w-4xl transform transition-all p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-border-dark">
        <h3 id="modalTitle" class="text-2xl font-extrabold text-gray-900 dark:text-text-dark">New Record</h3>
        <button id="coachingCloseBtn" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-text-dark dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-border-dark transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="coachingForm">
        <input type="hidden" id="rowIndex" />
        <input type="hidden" id="docId" name="DocID" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="coachingDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label>
            <input type="date" id="coachingDate" name="Date" required
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
          </div>
          <div>
            <label for="documentType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Document Type</label>
            <select id="documentType" name="DocumentType" required onchange="handleDocumentTypeChange()"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
              <option value="Coaching Log">Coaching Session</option>
              <option value="Verbal Warning">Verbal Warning</option>
              <option value="Written Warning">Written Warning Letter</option>
              <option value="Final Warning">Final Written Warning Letter</option>
              <option value="4th Written Warning">4th Written Warning</option>
              <option value="1 Day Suspension">1-Day Suspension</option>
              <option value="3 Day Suspension">3-Day Suspension</option>
              <option value="Dismissal">Dismissal</option>
              <option value="Incident Report">Incident Report</option>
              <option value="Notice to Explain">Notice to Explain (NTE)</option>
            </select>
          </div>
          <div class="relative">
            <label for="docIdDisplay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Document ID</label>
            <div class="flex gap-2 items-center">
              <input type="text" id="docIdDisplay" name="DocID"
                class="flex-1 p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition font-mono" placeholder="Leave blank to auto-generate or type to override">
              <button type="button" id="generateDocIdBtn" title="Auto-generate Doc ID" class="inline-flex items-center px-3 py-2 rounded-md bg-gray-100 hover:bg-gray-200 dark:bg-border-dark dark:hover:bg-gray-700 text-sm text-gray-700 dark:text-gray-200">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Auto-generated to match Google Sheet sequence. You can override if needed.</p>
          </div>
          <div>
            <label for="campaign" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Campaign</label>
            <select id="campaign" name="Campaign" required onchange="handleCampaignChange()"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
              <option value="">Select Campaign...</option>
            </select>
          </div>
          <div>
            <label for="coach" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Supervisor/Coach</label>
            <input type="text" id="coach" name="Coach" required
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
          </div>
          <div>
            <label for="employee" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employee Name</label>
            <input type="text" id="employee" name="Employee" required
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
          </div>
          <div>
            <label for="employeeNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employee Number</label>
            <input type="text" id="employeeNumber" name="EmployeeNumber" required
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
          </div>
          <div id="positionField">
            <label for="position" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Position</label>
            <input type="text" id="position" name="Position"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
          </div>
          <div id="departmentField" class="hidden md:col-span-2">
            <label for="department" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Department</label>
            <input type="text" id="department" name="Department"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
          </div>
          <div id="subjectField" class="hidden md:col-span-2">
            <label for="subject" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject / Violations</label>
            <textarea id="subject" name="Subject" rows="2"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition"></textarea>
          </div>
          <div id="dateOfIncidentField" class="hidden">
            <label for="dateOfIncident" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date of Incident</label>
            <input type="date" id="dateOfIncident" name="DateOfIncident"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
          </div>
          <div id="placeOfIncidentField" class="hidden">
            <label for="placeOfIncident" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Place of Incident</label>
            <input type="text" id="placeOfIncident" name="PlaceOfIncident"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
          </div>
          <div id="witnessNameField" class="hidden">
            <label for="witnessName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Witness Name</label>
            <input type="text" id="witnessName" name="WitnessName"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
          </div>
          <div id="witnessPositionField" class="hidden">
            <label for="witnessPosition" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Witness Position</label>
            <input type="text" id="witnessPosition" name="WitnessPosition"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
          </div>
        </div>
        <div class="mt-4">
          <label for="performance" id="performanceLabel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Narration of Incident</label>
          <textarea id="performance" name="Performance" rows="4" required
            class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition"></textarea>
        </div>
        <div class="mt-4" id="coachingProvidedContainer">
          <label for="coachingProvided" id="coachingProvidedLabel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Coaching / Corrective Action Provided</label>
          <textarea id="coachingProvided" name="CoachingProvided" rows="3"
            class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition"></textarea>
        </div>
        <div class="mt-4" id="actionPlanContainer">
          <label for="actionPlan" id="actionPlanLabel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Action Plan / Expected Improvement</label>
          <textarea id="actionPlan" name="ActionPlan" rows="3"
            class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition"></textarea>
        </div>

        <!-- Signature Pads -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Employee Signature</label>
            <div class="border-2 border-gray-300 dark:border-border-dark rounded-lg p-3 bg-white dark:bg-card-dark">
              <canvas id="signaturePad" class="w-full h-56 bg-white dark:bg-bg-dark border border-gray-200 dark:border-border-dark rounded" style="touch-action: none; cursor: crosshair;"></canvas>
              <button type="button" id="clearSignature"
                class="mt-2 px-4 py-2 rounded bg-gray-100 hover:bg-gray-200 dark:bg-border-dark dark:hover:bg-gray-700 text-sm font-medium transition w-full">
                <i class="fas fa-eraser mr-1"></i> Clear
              </button>
              <div class="mt-3 flex items-center gap-2">
                <label for="employeeSignatureDate" class="text-sm text-gray-600 dark:text-gray-300">Date</label>
                <input type="date" id="employeeSignatureDate" name="EmployeeSignatureDate" readonly class="p-2 border border-gray-200 rounded bg-gray-50 dark:bg-bg-dark dark:border-border-dark dark:text-text-dark" />
              </div>
            </div>
            <input type="hidden" id="signedImage" name="SignedImage" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Supervisor Signature</label>
            <div class="border-2 border-gray-300 dark:border-border-dark rounded-lg p-3 bg-white dark:bg-card-dark">
              <canvas id="supervisorSignaturePad" class="w-full h-56 bg-white dark:bg-bg-dark border border-gray-200 dark:border-border-dark rounded" style="touch-action: none; cursor: crosshair;"></canvas>
              <button type="button" id="clearSupervisorSignature"
                class="mt-2 px-4 py-2 rounded bg-gray-100 hover:bg-gray-200 dark:bg-border-dark dark:hover:bg-gray-700 text-sm font-medium transition w-full">
                <i class="fas fa-eraser mr-1"></i> Clear
              </button>
              <div class="mt-3 flex items-center gap-2">
                <label for="supervisorSignatureDate" class="text-sm text-gray-600 dark:text-gray-300">Date</label>
                <input type="date" id="supervisorSignatureDate" name="SupervisorSignatureDate" readonly class="p-2 border border-gray-200 rounded bg-gray-50 dark:bg-bg-dark dark:border-border-dark dark:text-text-dark" />
              </div>
            </div>
            <input type="hidden" id="supervisorSignedImage" name="SupervisorSignedImage" />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <label for="acknowledge" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Acknowledged</label>
            <select id="acknowledge" name="Acknowledge" required
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
              <option value="">Select...</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
              <option value="Draft">Draft</option>
            </select>
          </div>
          <div>
            <label for="signedForm" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Signed Form Link</label>
            <input type="url" id="signedForm" name="SignedForm"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition"
              placeholder="https://...">
          </div>
          <div>
            <label for="evidence" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Evidence Link</label>
            <input type="url" id="evidence" name="Evidence"
              class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition"
              placeholder="https://...">
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="cancelBtn"
            class="px-6 py-3 rounded-full border border-gray-300 dark:border-border-dark text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-border-dark transition">
            Cancel
          </button>
          <button type="submit" id="submitBtn"
            class="inline-flex items-center bg-google-blue hover:bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg font-bold transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-save mr-2"></i> <span id="submitBtnText">Save Record</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="printContainer" style="display: none;"></div>

  <script>
    const COACHING_API_URL = "https://script.google.com/macros/s/AKfycbxSh0CXKZmUrmL433ZaT0EgfLQbOwa_Nn1yYBKiF0npJXrHjDppGjaOa5GadAHfom7X/exec";
    const LOGO_URL = "https://digitalmindsbpo.com/storage/2021/11/cropped-Digital_Minds_Logo_Original.png";
    let allCoachingLogs = [];
    let campaignsList = []; // Store campaign data from Google Sheet
    let isEditMode = false;
    let currentViewLog = null;
    let signaturePad = null;
    let supervisorSignaturePad = null;
    let currentSearchQuery = '';
    function updateKpis(logs) {
      const safeLogs = Array.isArray(logs) ? logs : [];
      const totalEl = document.getElementById('kpiTotal');
      const pendingEl = document.getElementById('kpiPending');
      const todayEl = document.getElementById('kpiToday');
      const warnEl = document.getElementById('kpiWarnings');

      const total = safeLogs.length;
      const pending = safeLogs.filter(l => (l.Acknowledge || '').toLowerCase() !== 'yes').length;
      const todayStr = new Date().toISOString().slice(0, 10);
      const todaySigned = safeLogs.filter(l => {
        if (!l.Date) return false;
        const d = new Date(l.Date);
        if (isNaN(d.getTime())) return false;
        return d.toISOString().slice(0, 10) === todayStr;
      }).length;
      const warningTypes = ['verbal warning', 'written warning', 'final warning', '4th written warning', '1 day suspension', '3 day suspension', 'dismissal'];
      const warnings = safeLogs.filter(l => warningTypes.includes(String(l.DocumentType || '').toLowerCase())).length;

      if (totalEl) totalEl.textContent = total;
      if (pendingEl) pendingEl.textContent = pending;
      if (todayEl) todayEl.textContent = todaySigned;
      if (warnEl) warnEl.textContent = warnings;
    }
    function sendEmail(rowIndex) {
      const log = allCoachingLogs.find(l => l.rowIndex === rowIndex);
      if (!log) {
        showToast('Could not find that record.', 'warning');
        return;
      }
      // Placeholder: hook backend email logic here
      showToast(`Email trigger queued for ${log.Employee || 'employee'}.`, 'success');
    }

    // Dark Mode
    const themeToggle = document.getElementById('themeToggle');
    function updateThemeIcon(isDark) {
      themeToggle.innerHTML = isDark
        ? '<span class="material-symbols-outlined text-xl">light_mode</span>'
        : '<span class="material-symbols-outlined text-xl">dark_mode</span>';
    }

    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateThemeIcon(isDark);
    }

    themeToggle.addEventListener('click', toggleTheme);

    const storedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialDark = storedTheme === 'dark' || (storedTheme === null && prefersDark);
    if (initialDark) {
      document.body.classList.add('dark');
    }
    updateThemeIcon(initialDark);

    // Load Campaigns from Google Sheet
    async function loadCampaigns() {
      try {
        const fetchUrl = COACHING_API_URL + '?action=getCampaigns&t=' + Date.now();
        const res = await fetch(fetchUrl);

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const apiData = await res.json();

        if (apiData.error) {
          throw new Error(apiData.error);
        }

        campaignsList = Array.isArray(apiData) ? apiData : apiData.data || [];
        
        // Populate campaign dropdown
        const campaignSelect = document.getElementById('campaign');
        if (campaignSelect) {
          campaignSelect.innerHTML = '<option value="">Select Campaign...</option>';
          campaignsList.forEach(campaign => {
            const option = document.createElement('option');
            option.value = campaign.CampaignName;
            option.textContent = `${campaign.CampaignName} (${campaign.PseudoName})`;
            campaignSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error("Error loading campaigns:", error);
        showToast('Failed to load campaigns: ' + error.message, 'error');
      }
    }

    // Handle campaign change
    function handleCampaignChange() {
      const campaign = document.getElementById('campaign').value;
      const department = document.getElementById('department');
      
      // Auto-fill department with campaign name if department is empty
      if (department && !department.value) {
        department.value = campaign;
      }
    }

    // Loading spinners
    function showCoachingLoading(text = 'Loading records...') {
      const spinner = document.getElementById('coachingLoadingSpinner');
      const loadingText = document.getElementById('coachingLoadingText');
      if (spinner && loadingText) {
        loadingText.textContent = text;
        spinner.classList.remove('hidden');
      }
    }

    function hideCoachingLoading() {
      const spinner = document.getElementById('coachingLoadingSpinner');
      if (spinner) {
        spinner.classList.add('hidden');
      }
    }

    function showGlobalLoading(text = 'Loading...') {
      const spinner = document.getElementById('globalLoadingSpinner');
      const loadingText = document.getElementById('globalLoadingText');
      if (spinner && loadingText) {
        loadingText.textContent = text;
        spinner.classList.remove('hidden');
      }
    }

    function hideGlobalLoading() {
      const spinner = document.getElementById('globalLoadingSpinner');
      if (spinner) {
        spinner.classList.add('hidden');
      }
    }

    function showPaperViewLoading(text = 'Preparing document preview...') {
      const spinner = document.getElementById('paperViewSpinner');
      const loadingText = document.getElementById('paperLoadingText');
      if (spinner && loadingText) {
        loadingText.textContent = text;
        spinner.classList.remove('hidden');
      }
    }

    function hidePaperViewLoading() {
      const spinner = document.getElementById('paperViewSpinner');
      if (spinner) {
        spinner.classList.add('hidden');
      }
    }

    // Format Date
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Generate Reference ID with campaign-based coding system
    // Generate Reference ID following the exact algorithm used by the Google Apps Script
    function generateReferenceId(log) {
      // If DocID is already set on the log, return it directly
      if (log.DocID && String(log.DocID).trim().length > 0) return String(log.DocID).trim();

      const dateObj = log.Date ? new Date(log.Date) : new Date();
      const year = String(dateObj.getFullYear()).slice(-2);
      const month = String(dateObj.getMonth() + 1).padStart(2, '0');

      const typePrefix = {
        'Coaching Log': 'CS',
        'Verbal Warning': 'VW',
        'Written Warning': 'WW',
        'Final Warning': 'FW',
        '4th Written Warning': '4W',
        '1 Day Suspension': '1S',
        '3 Day Suspension': '3S',
        'Dismissal': 'DM',
        'Incident Report': 'IR',
        'Notice to Explain': 'NTE'
      };
      const prefix = typePrefix[log.DocumentType] || 'DOC';

      // Find campaign pseudo name (case-insensitive) from campaignsList
      let campaignCode = 'UNK';
      if (log.Campaign) {
        const campaignLookup = campaignsList.find(c => (c.CampaignName || '').toLowerCase() === String(log.Campaign || '').toLowerCase());
        if (campaignLookup && campaignLookup.PseudoName) {
          campaignCode = String(campaignLookup.PseudoName).trim() || String(log.Campaign).replace(/\s+/g, '');
        } else {
          campaignCode = String(log.Campaign).replace(/\s+/g, '') || 'UNK';
        }
      }

      const yyMM = year + month;
      const escapeForRegex = (s) => s.replace(/[\\/\^$*+?.()|[\]{}]/g, '\\$&');
      const pattern = '^DMI-' + prefix + '-' + escapeForRegex(campaignCode) + '-' + yyMM + '-(\\d+)$';
      const re = new RegExp(pattern, 'i');

      // Find max sequence from existing DocIDs in allCoachingLogs
      let maxSeq = 0;
      if (Array.isArray(allCoachingLogs)) {
        for (const r of allCoachingLogs) {
          if (!r || !r.DocID) continue;
          const raw = String(r.DocID).trim();
          const m = raw.match(re);
          if (m && m[1]) {
            const n = parseInt(m[1], 10);
            if (!isNaN(n) && n > maxSeq) maxSeq = n;
          }
        }
      }

      const next = maxSeq + 1;
      const seqStr = ('0000' + next).slice(-4);
      const result = 'DMI-' + prefix + '-' + campaignCode + '-' + yyMM + '-' + seqStr;
      return result;
    }

    // Get Document Type Badge Color
    function getDocTypeColor(docType) {
      const colors = {
        'Coaching Log': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
        'Verbal Warning': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
        'Written Warning': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
        'Final Warning': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
        '4th Written Warning': 'bg-red-200 text-red-900 dark:bg-red-800 dark:text-red-100',
        '1 Day Suspension': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
        '3 Day Suspension': 'bg-purple-200 text-purple-900 dark:bg-purple-800 dark:text-purple-100',
        'Dismissal': 'bg-gray-900 text-white dark:bg-gray-800 dark:text-gray-100',
        'Incident Report': 'bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-200',
        'Notice to Explain': 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200'
      };
      return colors[docType] || 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
    }

    // Generate Warning/Suspension Document HTML
    function generateWarningHTML(log, referenceId) {
      const dateFormatted = log.Date ? new Date(log.Date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
      const docType = log.DocumentType || 'Written Warning';
      const violations = log.Performance || log.Subject || '';
      const coaching = log.CoachingProvided || '';
      const actionPlan = log.ActionPlan || '';
      
      const suspensionInfo = {
        '1 Day Suspension': '1 (one) working day',
        '3 Day Suspension': '3 (three) working days',
      };
      
      const suspensionDays = suspensionInfo[docType] || '';
      
      const docTitle = docType === 'Verbal Warning' ? 'Verbal Warning' : `${docType} Letter`;

      const violationsHeading = docType === 'Verbal Warning' ? 'Type of Violation / Incident' : 'Violations / Performance Issues';
      const coachingHeading = docType === 'Verbal Warning' ? 'Details of the Incident' : 'Corrective Action / Details';
      const actionHeading = docType === 'Verbal Warning' ? 'Employee Statement / Action Plan' : 'Expected Actions/Expectations';

      return `
        <div style="font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; color: #222; margin: 0; line-height: 1.3; padding: 40px 30px 30px 30px; background: white;">
          <img src="${LOGO_URL}" alt="Digital Minds Logo" style="display: block; margin: 0 auto 15px auto; max-width: 120px; height: auto;" />
          
          <h1 style="text-align: center; font-size: 16px; text-transform: uppercase; margin-bottom: 10px; color: #222; letter-spacing: 0.5px; font-weight: bold;">${docTitle}</h1>
          
          <div style="text-align: right; margin-bottom: 15px; font-size: 11px; display:flex; gap:8px; align-items:center; justify-content:flex-end;">
            <div>
              <strong>Reference Code:</strong> <span style="color: #b30000; font-weight: bold;">${referenceId}</span>
            </div>
            <div>
              <button onclick="copyDocIdToClipboard('${referenceId}')" title="Copy Reference Code" style="border: none; background: transparent; color: #333; padding: 6px; cursor: pointer;">
                <i style="color:#b30000" class="fas fa-copy"></i>
              </button>
            </div>
            <br>
            <strong>Date Issued:</strong> ${dateFormatted}
          </div>

          <div style="margin-bottom: 20px; line-height: 1.6; font-size: 11px;">
            <p style="margin: 0 0 8px 0;">Dear Mr./Ms. ${log.Employee || ''},</p>
          </div>

          <div style="margin-bottom: 15px; text-align: center; font-weight: bold; color: #b30000; font-size: 12px; text-transform: uppercase;">
            ${docType}
          </div>

          <table style="width:100%; border-collapse: collapse; margin-bottom: 15px; table-layout: fixed;">
            <tr>
              <td style="padding: 6px; border: 1px solid #999; background: #e8e8e8; font-weight: bold; width: 30%;">Employee:</td>
              <td style="padding: 6px; border: 1px solid #999;">${log.Employee || ''}</td>
            </tr>
            <tr>
              <td style="padding: 6px; border: 1px solid #999; background: #e8e8e8; font-weight: bold;">Employee No.:</td>
              <td style="padding: 6px; border: 1px solid #999;">${log.EmployeeNumber || ''}</td>
            </tr>
            <tr>
              <td style="padding: 6px; border: 1px solid #999; background: #e8e8e8; font-weight: bold;">Position:</td>
              <td style="padding: 6px; border: 1px solid #999;">${log.Position || ''}</td>
            </tr>
            <tr>
              <td style="padding: 6px; border: 1px solid #999; background: #e8e8e8; font-weight: bold;">Department:</td>
              <td style="padding: 6px; border: 1px solid #999;">${log.Department || ''}</td>
            </tr>
            <tr>
              <td style="padding: 6px; border: 1px solid #999; background: #e8e8e8; font-weight: bold;">Supervisor:</td>
              <td style="padding: 6px; border: 1px solid #999;">${log.Coach || ''}</td>
            </tr>
          </table>

          <div style="margin-bottom: 12px;">
            <strong style="font-size: 11px;">${violationsHeading}:</strong>
            <div style="border: 0.5px solid #d1cfcf; min-height: 60px; padding: 8px; background: #fafafa; white-space: pre-wrap; margin-top: 4px;">
              ${violations}
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <strong style="font-size: 11px;">${coachingHeading}:</strong>
            <div style="border: 0.5px solid #d1cfcf; min-height: 60px; padding: 8px; background: #fafafa; white-space: pre-wrap; margin-top: 4px;">
              ${coaching}
            </div>
          </div>

          <div style="margin-bottom: 15px; font-size: 11px; line-height: 1.5;">
            <p style="margin: 0 0 8px 0;"><strong>${actionHeading}:</strong></p>
            <div style="border: 0.5px solid #d1cfcf; min-height: 60px; padding: 8px; background: #fafafa; white-space: pre-wrap;">
              ${actionPlan}
            </div>
          </div>

          ${suspensionDays ? `
            <div style="margin-bottom: 15px; background: #fffacd; border-left: 4px solid #b30000; padding: 10px; font-weight: bold; color: #b30000;">
              SUSPENSION PERIOD: ${suspensionDays}
            </div>
          ` : ''}

          ${docType === 'Dismissal' ? `
            <div style="margin-bottom: 15px; background: #ffe4e4; border-left: 4px solid #b30000; padding: 10px; font-weight: bold; color: #b30000; text-align: center;">
              NOTICE OF TERMINATION OF EMPLOYMENT
            </div>
          ` : ''}

          ${docType === 'Verbal Warning' ? `
            <div style="margin-bottom: 15px; font-size: 11px; line-height: 1.5; font-style: italic; color: #555;">
              <p style="margin: 0;">This verbal warning serves as an official record of counseling. Continued non-compliance or repeated violations may result in further disciplinary action, up to and including formal written warnings or termination.</p>
            </div>
          ` : `
            <div style="margin-bottom: 15px; font-size: 11px; line-height: 1.5; font-style: italic; color: #555;">
              <p style="margin: 0;">Please be advised that continued non-compliance or repeated violations may result in further disciplinary action, up to and including termination of employment, in accordance with company policies and applicable labor laws.</p>
            </div>
          `}

          <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #999;">
            <table style="width:100%; table-layout: fixed; border-collapse: collapse;">
              <tr>
                <td style="text-align: center; vertical-align: bottom; padding: 40px 15px 8px 15px; width: 50%;">
                  ${(log.SupervisorSignedImage && log.SupervisorSignedImage.length > 20)
                    ? `<img src="${log.SupervisorSignedImage}" alt="Supervisor Signature" style="max-height: 80px; max-width: 150px; display: block; margin: 0 auto 8px; border-bottom: 2px solid #000; padding-bottom: 8px;" />`
                    : `<div style="height: 60px; border-bottom: 2px solid #000; margin-bottom: 8px;"></div>`
                  }
                  <div style="font-weight: bold; font-size: 12px; margin-bottom: 2px;">${log.Coach || ''}</div>
                  <div style="font-size: 11px; color: #555;">Supervisor/Manager</div>
                </td>
                <td style="text-align: center; vertical-align: bottom; padding: 40px 15px 8px 15px; width: 50%;">
                  ${(log.SignedImage && log.SignedImage.length > 20)
                    ? `<img src="${log.SignedImage}" alt="Employee Signature" style="max-height: 80px; max-width: 150px; display: block; margin: 0 auto 8px; border-bottom: 2px solid #000; padding-bottom: 8px;" />`
                    : `<div style="height: 60px; border-bottom: 2px solid #000; margin-bottom: 8px;"></div>`
                  }
                  <div style="font-weight: bold; font-size: 12px; margin-bottom: 2px;">${log.Employee || ''}</div>
                  <div style="font-size: 11px; color: #555;">Employee Signature</div>
                </td>
              </tr>
              <tr>
                <td style="text-align: center; padding: 6px 15px 0 15px; font-size: 11px;">Date: ${dateFormatted}</td>
                <td style="text-align: center; padding: 6px 15px 0 15px; font-size: 11px;">Date: ${dateFormatted}</td>
              </tr>
            </table>
          </div>

          <div style="margin-top: 20px; font-size: 9px; display: flex; justify-content: space-between; color: #444; border-top: 1px solid #999; padding-top: 10px;">
            <div><strong>Reference Code:</strong> <span style="color:#b30000;font-weight:bold;">${referenceId}</span></div>
            <div>Digital Minds BPO Services Inc. | Confidential</div>
          </div>
        </div>
      `;
    }

    // Generate Incident Report Document HTML
    function generateIncidentReportHTML(log, referenceId) {
      const dateFormatted = log.Date ? new Date(log.Date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
      const dateOfIncident = log.DateOfIncident || '';
      const placeOfIncident = log.PlaceOfIncident || '';
      const narration = log.Performance || '';
      
      return `
        <div style="font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; color: #222; margin: 0; line-height: 1.2; padding: 40px 30px 30px 30px; background: white;">
          <img src="${LOGO_URL}" alt="Digital Minds Logo" style="display: block; margin: 0 auto 15px auto; max-width: 120px; height: auto;" />
          
          <h1 style="text-align: center; font-size: 18px; text-transform: uppercase; margin-bottom: 15px; color: #222; letter-spacing: 1px;">Incident Report</h1>
          
          <div style="text-align: right; margin-bottom: 15px; font-size: 12px;">
            <strong style="color: #333;">IR Reference Code:</strong> <span style="color: #b30000; font-weight: bold;">${referenceId}</span>
          </div>

          <table style="width:100%; border-collapse: collapse; margin-bottom: 15px; table-layout: fixed;">
            <tr>
              <td style="padding: 8px; width: 50%; text-align: left;">Employee Name: ${log.Employee || ''}</td>
              <td style="padding: 8px; width: 50%; text-align: left;">Employee No.: ${log.EmployeeNumber || ''}</td>
            </tr>
            <tr>
              <td style="padding: 8px; width: 50%; text-align: left;">Date Issued: ${dateFormatted}</td>
              <td style="padding: 8px; width: 50%; text-align: left;">Supervisor: ${log.Coach || ''}</td>
            </tr>
            <tr>
              <td style="padding: 8px; width: 50%; text-align: left;">Position: ${log.Position || ''}</td>
              <td style="padding: 8px; width: 50%; text-align: left;">Department: ${log.Department || ''}</td>
            </tr>
            <tr>
              <td style="padding: 8px; width: 50%; text-align: left;">Date of Incident: ${dateOfIncident}</td>
              <td style="padding: 8px; width: 50%; text-align: left;">Place of Incident: ${placeOfIncident}</td>
            </tr>
          </table>

          <i style="font-size: 10px;">(Kindly provide a proof as exhibits in a separate sheet)</i>
          <div style="border: 0.5px solid #d1cfcf; min-height: 150px; width: 100%; padding: 10px; box-sizing: border-box; white-space: pre-wrap; margin-bottom: 15px;">
            <b>Narration of Incident:</b><br><br>${narration}
          </div>

          <table style="width:100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed;">
            <tr>
              <td style="padding: 12px; width: 50%; text-align: center; font-weight: bold;">Witnesses:</td>
              <td style="padding: 12px; width: 50%; text-align: center; font-weight: bold;">Prepared By:</td>
            </tr>
            <tr>
              <td style="padding: 12px; text-align: center;">Name: ${log.WitnessName || '_________________'}</td>
              <td style="padding: 12px; text-align: center;">Name: ${log.Coach || ''}</td>
            </tr>
            <tr>
              <td style="padding: 12px; text-align: center;">Position: ${log.WitnessPosition || '_________________'}</td>
              <td style="padding: 12px; text-align: center;">Position: Supervisor</td>
            </tr>
            <tr>
              <td style="padding: 20px; text-align: center; vertical-align: bottom;">
                ${log.SignedImage && log.SignedImage.length > 20 
                  ? `<img src="${log.SignedImage}" style="max-height: 90px; max-width: 150px; display: block; margin: 0 auto 8px; border-bottom: 2px solid #000; padding-bottom: 8px;" />` 
                  : `<div style="height: 70px; border-bottom: 2px solid #000; margin-bottom: 8px;"></div>`}
                <div style="font-size: 11px; margin-top: 4px;">Signature</div>
              </td>
              <td style="padding: 20px; text-align: center; vertical-align: bottom;">
                ${log.SupervisorSignedImage && log.SupervisorSignedImage.length > 20 
                  ? `<img src="${log.SupervisorSignedImage}" style="max-height: 90px; max-width: 150px; display: block; margin: 0 auto 8px; border-bottom: 2px solid #000; padding-bottom: 8px;" />` 
                  : `<div style="height: 70px; border-bottom: 2px solid #000; margin-bottom: 8px;"></div>`}
                <div style="font-size: 11px; margin-top: 4px;">Signature</div>
              </td>
            </tr>
            <tr>
              <td style="padding: 8px; text-align: left;">Date: ${dateFormatted}</td>
              <td style="padding: 8px; text-align: left;">Date: ${dateFormatted}</td>
            </tr>
          </table>

          <div style="margin-top: 20px; font-size: 9px; display: flex; justify-content: space-between; color: #444; gap:8px; align-items:center;">
            <div style="display:flex;gap:6px;align-items:center"><strong>IR Code:</strong> <span style="color:#b30000;font-weight:bold;">${referenceId}</span></div>
            <div><button onclick="copyDocIdToClipboard('${referenceId}')" title="Copy IR Code" style="border: none; background: transparent; padding: 6px; cursor: pointer; color:#b30000"><i class="fas fa-copy"></i></button></div>
            <div>Digital Minds BPO Services Inc. | Confidential</div>
          </div>
        </div>
      `;
    }

    // Generate NTE Document HTML (matching the template exactly)
    function generateNTEHTML(log, referenceId) {
      const dateFormatted = log.Date ? new Date(log.Date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
      const violations = log.Subject || log.Performance || '';
      
      return `
        <div style="font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; color: #222; margin: 0; line-height: 1.2; padding: 40px 30px 30px 30px; background: white;">
          <img src="${LOGO_URL}" alt="Digital Minds Logo" style="display: block; margin: 0 auto 15px auto; max-width: 120px; height: auto;" />
          
          <h1 style="text-align: center; font-size: 18px; text-transform: uppercase; margin-bottom: 15px; color: #222; letter-spacing: 1px;">Notice to Explain</h1>
          
          <div style="text-align: right; margin-bottom: 15px; font-size: 12px;">
            <strong style="color: #333;">NTE Reference Code:</strong> <span style="color: #b30000; font-weight: bold;">${referenceId}</span>
          </div>

          <table style="width:100%; border-collapse: collapse;">
            <tr>
              <td style="white-space: nowrap; font-weight: bold; padding-right: 10px; padding-bottom: 8px;">Employee Name:</td>
              <td style="white-space: nowrap; padding-right: 30px; padding-bottom: 8px;">${log.Employee || ''}</td>
            </tr>
            <tr>
              <td style="white-space: nowrap; font-weight: bold; padding-right: 10px; padding-bottom: 8px;">Date Issued:</td>
              <td style="white-space: nowrap; padding-bottom: 8px;">${dateFormatted}</td>
            </tr>
            <tr>
              <td style="white-space: nowrap; font-weight: bold; padding-right: 10px; padding-bottom: 8px;">Position:</td>
              <td style="white-space: nowrap; padding-bottom: 8px;" colspan="3">${log.Position || ''} / ${log.Department || ''}</td>
            </tr>
          </table>

          <div style="padding: 10px 0; margin-bottom: 15px; font-size: 11px; line-height: 1.4; white-space: pre-wrap;">
Dear Mr./Ms. ${log.Employee || ''},

This Notice is being issued to require you to explain in writing why no disciplinary action should be imposed on you for the following incident(s):

<b>${violations}</b>

You are hereby directed to submit your <b>written explanation</b> regarding the above-mentioned matters within <b><span style="color: red;">five (5) working days</span></b> from receipt of this Notice. You may also submit any supporting evidence to substantiate your explanation.

You may be invited to attend an administrative hearing to ensure that due process is observed, in accordance with existing labor laws.

Failure to submit your <b>written explanation</b> within the prescribed period will be considered a <b>waiver of your right to be heard,</b> and the Company shall proceed to evaluate the case based on the information available.

Please be advised that, depending on the outcome of the investigation, you may be subject to disciplinary action, up to and including termination of employment, in accordance with company policies and the <b>Labor Code of the Philippines.</b>
          </div>

          <div style="margin-bottom:15px; text-align:left; font-weight: normal;">
            <div style="margin-top:4px; font-size: 12px;">
              ${log.SupervisorSignedImage && log.SupervisorSignedImage.length > 20 
                ? `<img src="${log.SupervisorSignedImage}" style="max-height: 90px; max-width: 220px; display: block; margin-bottom: 8px; border-bottom: 2px solid #000; padding-bottom: 8px;" /><br>` 
                : `<div style="height: 70px; border-bottom: 2px solid #000; margin-bottom: 8px;"></div>`}
              <strong>${log.Coach || ''}</strong>'s Signature Over Printed Name
            </div>
          </div>

          <div style="text-align: center; font-weight: bold; margin: 15px 0; font-size: 12px;">
            ACKNOWLEDGMENT OF RECEIPT OF THE NOTICE TO EXPLAIN
          </div>

          <div style="padding: 12px 0; margin-bottom: 15px; font-size: 12px; line-height: 1.5;">
I, ${log.Employee || ''}, confirm that I have received the Notice to Explain dated ${dateFormatted} and that I am given a period of <b>five (5) working days</b> from today to submit my <b>written explanation</b>.
          </div>

          <div style="margin-top: 30px;">
            <div style="margin-bottom: 12px; font-weight: bold; font-size: 12px;">Date and Time of Receipt:</div>
            <div style="margin-top: 30px;">
              ${log.SignedImage && log.SignedImage.length > 20 
                ? `<img src="${log.SignedImage}" style="max-height: 90px; max-width: 220px; display: block; margin-bottom: 8px; border-bottom: 2px solid #000; padding-bottom: 8px;" /><br>` 
                : `<div style="height: 70px; border-bottom: 2px solid #000; margin-bottom: 8px;"></div>`}
              <strong>${log.Employee || ''}</strong>'s Signature Over Printed Name
            </div>
          </div>

          <div style="margin-top: 20px; font-size: 9px; display: flex; justify-content: space-between; color: #444; gap:8px; align-items:center;">
            <div style="display:flex;gap:6px;align-items:center"><strong>NTE Code:</strong> <span style="color:#b30000;font-weight:bold;">${referenceId}</span></div>
            <div><button onclick="copyDocIdToClipboard('${referenceId}')" title="Copy NTE Code" style="border: none; background: transparent; padding: 6px; cursor: pointer; color:#b30000"><i class="fas fa-copy"></i></button></div>
            <div>Digital Minds BPO Services Inc. | Confidential</div>
          </div>
        </div>
      `;
    }

    // Generate default document HTML for other types
    function generateDefaultHTML(log, referenceId) {
      const dateFormatted = log.Date ? new Date(log.Date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
      const docType = log.DocumentType || 'Coaching Log';
      
      return `
        <div style="font-family: 'Segoe UI', Arial, sans-serif; font-size: 12px; color: #222; margin: 0; padding: 24px 20px; background: white; max-width: 900px; margin: 0 auto;">
          <div style="text-align: center; margin-bottom: 18px;">
            <img src="${LOGO_URL}" alt="Digital Minds BPO" style="height: 48px; width: auto; display: block; margin: 0 auto 10px; object-fit: contain;" />
            <h1 style="font-size: 15px; text-transform: uppercase; font-weight: 700; margin: 0; letter-spacing: 0.6px;">${docType}</h1>
            <div style="height: 8px"></div>
            <div style="width: 100%; max-width: 260px; margin: 12px auto 0; height: 2px; background: linear-gradient(90deg, #b30000, #333); opacity: 0.15;"></div>
          </div>

          <div style="margin-bottom: 20px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <tr>
                <td style="padding: 6px; border: 1px solid #999; background: #e8e8e8; font-weight: bold; width: 25%;">Employee:</td>
                <td style="padding: 6px; border: 1px solid #999;">${log.Employee || ''}</td>
                <td style="padding: 6px; border: 1px solid #999; background: #e8e8e8; font-weight: bold; width: 25%;">Position:</td>
                <td style="padding: 6px; border: 1px solid #999;">${log.Position || ''}</td>
              </tr>
              <tr>
                <td style="padding: 6px; border: 1px solid #999; background: #e8e8e8; font-weight: bold;">Department:</td>
                <td style="padding: 6px; border: 1px solid #999;">${log.Department || ''}</td>
                <td style="padding: 6px; border: 1px solid #999; background: #e8e8e8; font-weight: bold;">Date:</td>
                <td style="padding: 6px; border: 1px solid #999;">${dateFormatted}</td>
              </tr>
              <tr>
                <td style="padding: 6px; border: 1px solid #999; background: #e8e8e8; font-weight: bold;">Supervisor:</td>
                <td colspan="3" style="padding: 6px; border: 1px solid #999;">${log.Coach || ''}</td>
              </tr>
            </table>
          </div>

          <div style="margin-bottom: 15px;">
            <h3 style="font-size: 11px; font-weight: bold; text-transform: uppercase; margin: 12px 0 6px 0; border-left: 3px solid #333; padding-left: 6px;">Performance Issue / Behavior Observed</h3>
            <div style="border: 1px solid #999; padding: 8px; background: #fafafa; min-height: 45px; white-space: pre-wrap; line-height: 1.4;">${log.Performance || ''}</div>
          </div>

          <div style="margin-bottom: 15px;">
            <h3 style="font-size: 11px; font-weight: bold; text-transform: uppercase; margin: 12px 0 6px 0; border-left: 3px solid #333; padding-left: 6px;">Coaching / Corrective Action</h3>
            <div style="border: 1px solid #999; padding: 8px; background: #fafafa; min-height: 45px; white-space: pre-wrap; line-height: 1.4;">${log.CoachingProvided || ''}</div>
          </div>

          <div style="margin-bottom: 20px;">
            <h3 style="font-size: 11px; font-weight: bold; text-transform: uppercase; margin: 12px 0 6px 0; border-left: 3px solid #333; padding-left: 6px;">Action Plan / Expected Improvement</h3>
            <div style="border: 1px solid #999; padding: 8px; background: #fafafa; min-height: 45px; white-space: pre-wrap; line-height: 1.4;">${log.ActionPlan || ''}</div>
          </div>

          <div style="margin-top: 30px; border-top: 2px solid #333; padding-top: 20px;">
            <h3 style="text-align: center; font-size: 12px; font-weight: bold; text-transform: uppercase; margin-bottom: 15px;">Acknowledgment</h3>
            <p style="margin: 0 0 25px 0; font-size: 12px; line-height: 1.6; text-align: center;">I confirm that the contents of this document have been explained to me.</p>

            <table style="width: 100%; table-layout: fixed; border-collapse: collapse;">
              <tr>
                <td style="text-align: center; vertical-align: bottom; padding: 40px 15px 10px 15px; width: 50%;">
                  ${(log.SignedImage && log.SignedImage.length > 20)
                    ? `<img src="${log.SignedImage}" alt="Employee Signature" style="max-height: 100px; max-width: 140px; display: block; margin: 0 auto 8px; border-bottom: 2px solid #000; padding-bottom: 8px;" />`
                    : `<div style="height: 70px; border-bottom: 2px solid #000; margin-bottom: 8px;"></div>`
                  }
                  <div style="font-weight: bold; font-size: 12px; margin-top: 6px;">${log.Employee || ''}</div>
                  <div style="font-size: 11px; color: #555; margin-top: 2px;">Employee Signature</div>
                </td>
                <td style="text-align: center; vertical-align: bottom; padding: 40px 15px 10px 15px; width: 50%;">
                  ${(log.SupervisorSignedImage && log.SupervisorSignedImage.length > 20)
                    ? `<img src="${log.SupervisorSignedImage}" alt="Supervisor Signature" style="max-height: 100px; max-width: 140px; display: block; margin: 0 auto 8px; border-bottom: 2px solid #000; padding-bottom: 8px;" />`
                    : `<div style="height: 70px; border-bottom: 2px solid #000; margin-bottom: 8px;"></div>`
                  }
                  <div style="font-weight: bold; font-size: 12px; margin-top: 6px;">${log.Coach || ''}</div>
                  <div style="font-size: 11px; color: #555; margin-top: 2px;">Supervisor Signature</div>
                </td>
              </tr>
            </table>
          </div>

          <div style="margin-top: 25px; padding-top: 12px; border-top: 1px solid #999; font-size: 11px; color: #666; text-align: center;">
            <div style="display:flex;align-items:center;justify-content:center;gap:6px;margin:0;">
              <strong>Reference ID:</strong> <span style="color:#b30000;font-weight:bold;">${referenceId}</span>
              <button onclick="copyDocIdToClipboard('${referenceId}')" title="Copy Reference ID" style="border:none;background:transparent;padding:4px;cursor:pointer;color:#b30000"><i class="fas fa-copy"></i></button>
            </div>
            <p style="margin: 4px 0 0 0;">Digital Minds BPO Services Inc. | Confidential</p>
          </div>
        </div>
      `;
    }

    // Generate Paper Document HTML
    function generatePaperHTML(log) {
      const referenceId = generateReferenceId(log);
      const docType = log.DocumentType || 'Coaching Log';

      if (docType === 'Incident Report') {
        return generateIncidentReportHTML(log, referenceId);
      }
      
      if (docType === 'Notice to Explain') {
        return generateNTEHTML(log, referenceId);
      }

      if (['Verbal Warning', 'Written Warning', 'Final Warning', '4th Written Warning', '1 Day Suspension', '3 Day Suspension', 'Dismissal'].includes(docType)) {
        return generateWarningHTML(log, referenceId);
      }

      return generateDefaultHTML(log, referenceId);
    }

    // View Log
    function viewLog(rowIndex) {
      const log = allCoachingLogs.find(l => l.rowIndex === rowIndex);
      if (!log) return;
      // Show preview modal with a paper view spinner while rendering
      const paperViewModal = document.getElementById('paperViewModal');
      const paperDocument = document.getElementById('paperDocument');
      currentViewLog = log;
      paperViewModal.classList.remove('hidden');
      showPaperViewLoading('Preparing document preview...');
      // Give a tick for UI to update before heavy generation (if any)
      setTimeout(() => {
        paperDocument.innerHTML = generatePaperHTML(log);
        hidePaperViewLoading();
      }, 40);
    }

    // Render Table
    function renderCoachingTable(logsToRender) {
      const table = document.getElementById("coachingTable");
      table.innerHTML = "";

      if (!Array.isArray(logsToRender) || logsToRender.length === 0) {
        table.innerHTML = `<tr><td colspan="12" class="text-center py-6 text-gray-500 dark:text-gray-400">No records found.</td></tr>`;
        return;
      }

      logsToRender.forEach(log => {
        const signedFormLink = log.SignedForm && log.SignedForm.length > 5 && log.SignedForm !== '#' ? log.SignedForm : "#";
        const evidenceLink = log.Evidence && log.Evidence.length > 5 && log.Evidence !== '#' ? log.Evidence : "#";
        const hasSignature = log.SignedImage && log.SignedImage.length > 20;
        const docType = log.DocumentType || 'Coaching Log';
        const docTypeColor = getDocTypeColor(docType);
        const campaign = log.Campaign || 'N/A';
        const referenceId = (log.DocID && String(log.DocID).length > 0) ? log.DocID : generateReferenceId(log);

        table.innerHTML += `
          <tr class="hover:bg-gray-50 dark:hover:bg-card-dark transition duration-150">
            <td class="px-4 py-3 whitespace-nowrap font-medium text-sm text-gray-900 dark:text-text-dark">
              <div class="flex items-center gap-2">
                <span class="font-mono">${referenceId}</span>
                <button title="Copy Doc ID" onclick="copyDocIdToClipboard('${referenceId}')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">${formatDate(log.Date)}</td>
            <td class="px-4 py-3 font-medium text-sm">${campaign}</td>
            <td class="px-4 py-3">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${docTypeColor}">
                ${docType}
              </span>
            </td>
            <td class="px-4 py-3">${log.Coach || "N/A"}</td>
            <td class="px-4 py-3 font-medium text-gray-900 dark:text-text-dark">${log.Employee || "N/A"}</td>
            <td class="px-4 py-3">${log.EmployeeNumber || "N/A"}</td>
            <td class="px-4 py-3 text-center">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold
                ${log.Acknowledge === 'Yes'
                  ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
                  : log.Acknowledge === 'Draft'
                    ? 'bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                    : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                ${log.Acknowledge || "N/A"}
              </span>
            </td>
            <td class="px-4 py-3 text-center">
              ${hasSignature
                ? '<i class="fas fa-check-circle text-green-600 dark:text-green-400" title="Signature present"></i>'
                : '<i class="fas fa-times-circle text-gray-400" title="No signature"></i>'}
            </td>
            <td class="px-4 py-3 text-center">
              <a href="${signedFormLink}" target="_blank" 
                class="${signedFormLink === '#' ? 'text-gray-400 cursor-default' : 'text-google-blue hover:text-blue-600'}" 
                title="${signedFormLink === '#' ? 'No form' : 'View signed form'}">
                <i class="fas fa-file-signature"></i>
              </a>
            </td>
            <td class="px-4 py-3 text-center">
              <a href="${evidenceLink}" target="_blank" 
                class="${evidenceLink === '#' ? 'text-gray-400 cursor-default' : 'text-google-blue hover:text-blue-600'}" 
                title="${evidenceLink === '#' ? 'No evidence' : 'View evidence'}">
                <i class="fas fa-paperclip"></i>
              </a>
            </td>
            <td class="px-4 py-3 text-center whitespace-nowrap">
              <button onclick="viewLog(${log.rowIndex})" class="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 mr-2" title="View Document">
                <i class="fas fa-eye"></i>
              </button>
              <button onclick="editLog(${log.rowIndex})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-2" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteLog(${log.rowIndex})" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 mr-2" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
              <button onclick="sendEmail(${log.rowIndex})" class="text-green-700 hover:text-green-800 dark:text-green-300" title="Email employee">
                <i class="fas fa-envelope"></i>
              </button>
            </td>
          </tr>`;
      });
    }

    // Filtering + Sorting
    function applyFiltersAndSort() {
      const filterSelect = document.getElementById('filterDocType');
      const campaignSelect = document.getElementById('filterCampaign');
      const ackSelect = document.getElementById('filterAck');
      const sortSelect = document.getElementById('sortBy');
      const filterValue = filterSelect ? filterSelect.value.toLowerCase() : 'all';
      const campaignValue = campaignSelect ? campaignSelect.value.toLowerCase() : 'all';
      const ackValue = ackSelect ? ackSelect.value.toLowerCase() : 'all';
      const sortValue = sortSelect ? sortSelect.value : 'date_desc';

      let logs = Array.isArray(allCoachingLogs) ? [...allCoachingLogs] : [];

      if (currentSearchQuery) {
        logs = logs.filter(log => {
          return (log.Employee && log.Employee.toLowerCase().includes(currentSearchQuery)) ||
            (log.Coach && log.Coach.toLowerCase().includes(currentSearchQuery)) ||
            (log.Campaign && log.Campaign.toLowerCase().includes(currentSearchQuery)) ||
            (log.Position && log.Position.toLowerCase().includes(currentSearchQuery)) ||
            (log.Performance && log.Performance.toLowerCase().includes(currentSearchQuery)) ||
            (log.DocumentType && log.DocumentType.toLowerCase().includes(currentSearchQuery)) ||
            (log.EmployeeNumber && String(log.EmployeeNumber).toLowerCase().includes(currentSearchQuery)) ||
            (log.DocID && String(log.DocID).toLowerCase().includes(currentSearchQuery));
        });
      }

      if (filterValue !== 'all') {
        logs = logs.filter(log => (log.DocumentType || '').toLowerCase() === filterValue);
      }

      if (campaignValue !== 'all') {
        logs = logs.filter(log => (log.Campaign || '').toLowerCase() === campaignValue);
      }

      if (ackValue !== 'all') {
        logs = logs.filter(log => (log.Acknowledge || '').toLowerCase() === ackValue);
      }

      function dateValue(log) {
        const d = log && log.Date ? new Date(log.Date) : null;
        return d && !isNaN(d.getTime()) ? d.getTime() : 0;
      }

      function docSeq(log) {
        if (!log || !log.DocID) return 0;
        const m = String(log.DocID).match(/-(\d+)$/);
        return m && m[1] ? parseInt(m[1], 10) || 0 : 0;
      }

      logs.sort((a, b) => {
        const dateDiffDesc = dateValue(b) - dateValue(a);
        const dateDiffAsc = dateValue(a) - dateValue(b);

        switch (sortValue) {
          case 'date_asc':
            return dateDiffAsc !== 0 ? dateDiffAsc : docSeq(a) - docSeq(b);
          case 'employee_asc':
            return String(a.Employee || '').localeCompare(String(b.Employee || ''), undefined, { sensitivity: 'base' });
          case 'employee_desc':
            return String(b.Employee || '').localeCompare(String(a.Employee || ''), undefined, { sensitivity: 'base' });
          case 'date_desc':
          default:
            return dateDiffDesc !== 0 ? dateDiffDesc : docSeq(b) - docSeq(a);
        }
      });

      updateKpis(logs);
      renderCoachingTable(logs);
    }

    // Search
    function handleCoachingSearch() {
      currentSearchQuery = document.getElementById('coachingSearch').value.toLowerCase().trim();
      applyFiltersAndSort();
    }

    const filterDocType = document.getElementById('filterDocType');
    const filterCampaign = document.getElementById('filterCampaign');
    const filterAck = document.getElementById('filterAck');
    const sortBy = document.getElementById('sortBy');

    function populateCampaignFilterOptions(logs) {
      const select = document.getElementById('filterCampaign');
      if (!select) return;
      const safeLogs = Array.isArray(logs) ? logs : [];
      const unique = Array.from(new Set(safeLogs.map(l => l.Campaign).filter(Boolean)))
        .sort((a, b) => String(a).localeCompare(String(b)));
      const existingValue = select.value || 'all';
      select.innerHTML = '<option value="all">All campaigns</option>';
      unique.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
      if (existingValue && Array.from(select.options).some(o => o.value === existingValue)) {
        select.value = existingValue;
      }
    }
    if (filterDocType) filterDocType.addEventListener('change', applyFiltersAndSort);
    if (filterCampaign) filterCampaign.addEventListener('change', applyFiltersAndSort);
    if (filterAck) filterAck.addEventListener('change', applyFiltersAndSort);
    if (sortBy) sortBy.addEventListener('change', applyFiltersAndSort);

    // Load Data
    async function loadCoachingLogs() {
      // Use global spinner for loading the list so it's visible regardless of layout
      showGlobalLoading('Loading records...');

      try {
        const fetchUrl = COACHING_API_URL + '?action=getCoachingData&t=' + Date.now();
        const res = await fetch(fetchUrl);

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const apiData = await res.json();

        if (apiData.error) {
          throw new Error(apiData.error);
        }

        allCoachingLogs = Array.isArray(apiData) ? apiData : apiData.data || [];
        populateCampaignFilterOptions(allCoachingLogs);
        updateKpis(allCoachingLogs);

        applyFiltersAndSort();

      } catch (error) {
        console.error("Error loading records:", error);
        const errorMessage = `Failed to load records. (Error: ${error.message})`;
        document.getElementById("coachingTable").innerHTML = `<tr><td colspan="12" class="text-center py-6 text-danger font-semibold dark:text-red-400">${errorMessage}</td></tr>`;
      }
      hideGlobalLoading();
    }

    // Modal Functions
    const coachingModal = document.getElementById('coachingModal');

    function openModal(modal) {
      modal.classList.remove('hidden');
      void modal.offsetWidth;
      modal.classList.add('opacity-100', 'scale-100');
    }

    function closeModal(modal) {
      modal.classList.remove('opacity-100', 'scale-100');
      modal.classList.add('opacity-0', 'scale-95');
      setTimeout(() => modal.classList.add('hidden'), 300);
    }

    document.getElementById('newCoachingBtn').addEventListener('click', (e) => {
      e.preventDefault();
      isEditMode = false;
      document.getElementById('modalTitle').textContent = 'New Record';
      document.getElementById('submitBtnText').textContent = 'Save Record';
      document.getElementById('coachingForm').reset();
      document.getElementById('docIdDisplay').value = '';
      const signedInput = document.getElementById('signedImage');
      if (signedInput) signedInput.value = '';
      const supervisorSignedInput = document.getElementById('supervisorSignedImage');
      if (supervisorSignedInput) supervisorSignedInput.value = '';
      handleDocumentTypeChange();
      // Update signature date fields to match coaching date
      const coachingDateInput = document.getElementById('coachingDate');
      const empSigDate = document.getElementById('employeeSignatureDate');
      const supSigDate = document.getElementById('supervisorSignatureDate');
      if (empSigDate) empSigDate.value = coachingDateInput.value || '';
      if (supSigDate) supSigDate.value = coachingDateInput.value || '';
      openModal(coachingModal);
      setTimeout(() => initSignaturePad(), 50);
    });

    // Handle document type change
    function handleDocumentTypeChange() {
      const docType = document.getElementById('documentType').value;
      const positionField = document.getElementById('positionField');
      const departmentField = document.getElementById('departmentField');
      const subjectField = document.getElementById('subjectField');
      const dateOfIncidentField = document.getElementById('dateOfIncidentField');
      const placeOfIncidentField = document.getElementById('placeOfIncidentField');
      const witnessNameField = document.getElementById('witnessNameField');
      const witnessPositionField = document.getElementById('witnessPositionField');
      const performanceLabel = document.getElementById('performanceLabel');
      const coachingProvidedLabel = document.getElementById('coachingProvidedLabel');
      const coachingProvidedContainer = document.getElementById('coachingProvidedContainer');
      const actionPlanLabel = document.getElementById('actionPlanLabel');
      const actionPlanContainer = document.getElementById('actionPlanContainer');
      const coachingProvidedField = document.getElementById('coachingProvided');
      const actionPlanField = document.getElementById('actionPlan');
      const performanceField = document.getElementById('performance');

      // Reset visibility (keep Position visible for all document types)
      // positionField intentionally left visible for Coaching Session and other types
      departmentField.classList.add('hidden');
      subjectField.classList.add('hidden');
      dateOfIncidentField.classList.add('hidden');
      placeOfIncidentField.classList.add('hidden');
      witnessNameField.classList.add('hidden');
      witnessPositionField.classList.add('hidden');
      coachingProvidedContainer.classList.remove('hidden');
      actionPlanContainer.classList.remove('hidden');
      coachingProvidedField.required = true;
      actionPlanField.required = true;
      performanceField.required = true;

      if (docType === 'Incident Report') {
        positionField.classList.remove('hidden');
        departmentField.classList.remove('hidden');
        dateOfIncidentField.classList.remove('hidden');
        placeOfIncidentField.classList.remove('hidden');
        witnessNameField.classList.remove('hidden');
        witnessPositionField.classList.remove('hidden');
        performanceLabel.textContent = 'Narration of Incident';
        coachingProvidedContainer.classList.add('hidden');
        actionPlanContainer.classList.add('hidden');
        coachingProvidedField.required = false;
        actionPlanField.required = false;
      } else if (docType === 'Notice to Explain') {
        positionField.classList.remove('hidden');
        departmentField.classList.remove('hidden');
        subjectField.classList.remove('hidden');
        performanceLabel.textContent = 'Details / Incident Description';
        coachingProvidedLabel.textContent = 'Explanation Required';
        actionPlanLabel.textContent = 'Possible Consequences';
      } else if (['Written Warning', 'Final Warning', '4th Written Warning', '1 Day Suspension', '3 Day Suspension', 'Dismissal'].includes(docType)) {
        positionField.classList.remove('hidden');
        departmentField.classList.remove('hidden');
        performanceLabel.textContent = 'Violations / Performance Issues';
        coachingProvidedLabel.textContent = 'Corrective Action / Details';
        actionPlanLabel.textContent = 'Expected Actions / Expectations';
      } else if (docType === 'Verbal Warning') {
        positionField.classList.remove('hidden');
        departmentField.classList.remove('hidden');
        performanceLabel.textContent = 'Type of Violation / Incident';
        coachingProvidedLabel.textContent = 'Details of the Incident';
        actionPlanLabel.textContent = 'Employee Statement / Action Plan';
      } else {
        performanceLabel.textContent = 'Performance Issue / Behavior Observed';
        coachingProvidedLabel.textContent = 'Coaching / Corrective Action Provided';
        actionPlanLabel.textContent = 'Action Plan / Expected Improvement';
      }
    }

    coachingModal.addEventListener('click', (e) => {
      if (e.target === coachingModal || e.target.closest('#coachingCloseBtn')) {
        closeModal(coachingModal);
      }
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
      closeModal(coachingModal);
    });

    // Edit Log
    function editLog(rowIndex) {
      const log = allCoachingLogs.find(l => l.rowIndex === rowIndex);
      if (!log) return;

      isEditMode = true;
      document.getElementById('modalTitle').textContent = 'Edit Record';
      document.getElementById('submitBtnText').textContent = 'Update Record';

      document.getElementById('rowIndex').value = log.rowIndex;
      document.getElementById('docId').value = log.DocID || '';
      document.getElementById('docIdDisplay').value = log.DocID || '';
      document.getElementById('coachingDate').value = log.Date ? new Date(log.Date).toISOString().split('T')[0] : '';
      document.getElementById('documentType').value = log.DocumentType || 'Coaching Log';
      document.getElementById('campaign').value = log.Campaign || '';
      document.getElementById('coach').value = log.Coach || '';
      document.getElementById('employee').value = log.Employee || '';
      document.getElementById('employeeNumber').value = log.EmployeeNumber || '';
      document.getElementById('position').value = log.Position || '';
      document.getElementById('department').value = log.Department || '';
      document.getElementById('subject').value = log.Subject || '';
      document.getElementById('dateOfIncident').value = log.DateOfIncident ? new Date(log.DateOfIncident).toISOString().split('T')[0] : '';
      document.getElementById('placeOfIncident').value = log.PlaceOfIncident || '';
      document.getElementById('witnessName').value = log.WitnessName || '';
      document.getElementById('witnessPosition').value = log.WitnessPosition || '';
      document.getElementById('performance').value = log.Performance || '';
      document.getElementById('coachingProvided').value = log.CoachingProvided || '';
      document.getElementById('actionPlan').value = log.ActionPlan || '';
      document.getElementById('acknowledge').value = log.Acknowledge || '';
      document.getElementById('signedForm').value = log.SignedForm || '';
      document.getElementById('evidence').value = log.Evidence || '';

      const signedInput = document.getElementById('signedImage');
      if (signedInput) signedInput.value = log.SignedImage || '';

      const supervisorSignedInput = document.getElementById('supervisorSignedImage');
      if (supervisorSignedInput) supervisorSignedInput.value = log.SupervisorSignedImage || '';

      // Populate signature date fields based on coaching date
      const empSigDate = document.getElementById('employeeSignatureDate');
      const supSigDate = document.getElementById('supervisorSignatureDate');
      if (empSigDate) empSigDate.value = document.getElementById('coachingDate').value || '';
      if (supSigDate) supSigDate.value = document.getElementById('coachingDate').value || '';

      handleDocumentTypeChange();
      openModal(coachingModal);
      setTimeout(() => initSignaturePad(), 50);
    }

    // Delete Log
    async function deleteLog(rowIndex) {
      const confirmed = await showConfirm(
        'Delete Record',
        'Are you sure you want to delete this record? This action cannot be undone.'
      );

      if (!confirmed) return;

      showGlobalLoading('Deleting...');

      try {
        const res = await fetch(COACHING_API_URL + '?action=deleteCoachingRecord&rowIndex=' + rowIndex);
        const result = await res.json();

        if (result.error) {
          throw new Error(result.error);
        }

        showToast('Record deleted successfully!', 'success');
        hideGlobalLoading();
        await loadCoachingLogs();
      } catch (error) {
        console.error('Error deleting record:', error);
        showToast('Failed to delete record: ' + error.message, 'error');
        hideGlobalLoading();
      }
    }

    // Form Submission
    async function submitCoachingForm(e) {
      e.preventDefault();
      const form = e.target;
      const submitButton = document.getElementById('submitBtn');
      const originalButtonHtml = submitButton.innerHTML;

      // Validate campaign selection
      const campaign = document.getElementById('campaign').value;
      if (!campaign) {
        showToast('Please select a campaign', 'error');
        return;
      }

      // Auto-fill department with campaign if blank
      const departmentField = document.getElementById('department');
      if (departmentField && !departmentField.value) {
        departmentField.value = campaign;
      }

      submitButton.innerHTML = '<span class="loader small mr-2" style="display:inline-block; vertical-align:middle;"></span> Saving...';

      // Sync visible Doc ID into hidden Doc ID field so backend receives any user override
      const docDisplayEl = document.getElementById('docIdDisplay');
      const hiddenDocEl = document.getElementById('docId');
      if (docDisplayEl && hiddenDocEl) {
        const displayVal = docDisplayEl.value ? docDisplayEl.value.trim() : '';
        if (displayVal) {
          hiddenDocEl.value = displayVal;
        } else {
          // If both blank, auto-generate DocID to match spreadsheet behavior
          const computed = generateDocIdForForm();
          hiddenDocEl.value = computed || '';
          if (docDisplayEl && computed) docDisplayEl.value = computed;
        }
      }

      let employeeSignature = '';
      let supervisorSignature = '';

      if (signaturePad && !signaturePad.isEmpty()) {
        employeeSignature = signaturePad.toDataURL('image/png');
      }
      if (supervisorSignaturePad && !supervisorSignaturePad.isEmpty()) {
        supervisorSignature = supervisorSignaturePad.toDataURL('image/png');
      }

      const formData = {
        DocID: document.getElementById('docId') ? document.getElementById('docId').value : '',
        Date: document.getElementById('coachingDate').value,
        DocumentType: document.getElementById('documentType').value,
        Campaign: document.getElementById('campaign').value,
        Coach: document.getElementById('coach').value,
        Employee: document.getElementById('employee').value,
        EmployeeNumber: document.getElementById('employeeNumber').value,
        Position: document.getElementById('position').value,
        Department: document.getElementById('department').value,
        Subject: document.getElementById('subject') ? document.getElementById('subject').value : '',
        DateOfIncident: document.getElementById('dateOfIncident') ? document.getElementById('dateOfIncident').value : '',
        PlaceOfIncident: document.getElementById('placeOfIncident') ? document.getElementById('placeOfIncident').value : '',
        WitnessName: document.getElementById('witnessName') ? document.getElementById('witnessName').value : '',
        WitnessPosition: document.getElementById('witnessPosition') ? document.getElementById('witnessPosition').value : '',
        Performance: document.getElementById('performance').value,
        CoachingProvided: document.getElementById('coachingProvided').value,
        ActionPlan: document.getElementById('actionPlan').value,
        Acknowledge: document.getElementById('acknowledge').value,
        SignedForm: document.getElementById('signedForm').value,
        Evidence: document.getElementById('evidence').value,
        SignedImage: employeeSignature || (document.getElementById('signedImage') ? document.getElementById('signedImage').value : ''),
        SupervisorSignedImage: supervisorSignature || (document.getElementById('supervisorSignedImage') ? document.getElementById('supervisorSignedImage').value : '')
      };

      if (isEditMode) {
        formData.rowIndex = document.getElementById('rowIndex').value;
      }

      try {
        // Show a global saving overlay while the form is being submitted to avoid UI flicker
        showGlobalLoading('Saving record...');
        const action = isEditMode ? 'updateCoachingRecord' : 'addCoachingRecord';
        const res = await fetch(COACHING_API_URL + '?action=' + action, {
          method: 'POST',
          body: JSON.stringify(formData)
        });

        const result = await res.json();

        showToast(isEditMode ? 'Record updated successfully!' : 'Record added successfully!', 'success');
        closeModal(coachingModal);
        form.reset();
        await loadCoachingLogs();
      } catch (error) {
        console.error('Error saving record:', error);
        showToast('Failed to save record: ' + error.message, 'error');
      } finally {
        hideGlobalLoading();
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonHtml;
      }
    }

    document.getElementById('coachingForm').addEventListener('submit', submitCoachingForm);
    // Update signature date fields when coaching date changes
    const coachingDateInput = document.getElementById('coachingDate');
    if (coachingDateInput) {
      coachingDateInput.addEventListener('change', () => {
        const empSigDate = document.getElementById('employeeSignatureDate');
        const supSigDate = document.getElementById('supervisorSignatureDate');
        if (empSigDate) empSigDate.value = coachingDateInput.value || '';
        if (supSigDate) supSigDate.value = coachingDateInput.value || '';
      });
    }

    // Signature Pad utilities
    function resizeCanvasForDisplay(canvas) {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const w = canvas.offsetWidth;
      const h = canvas.offsetHeight;
      canvas.width = w * ratio;
      canvas.height = h * ratio;
      canvas.getContext('2d').scale(ratio, ratio);
    }

    function initSignaturePad() {
      const canvas = document.getElementById('signaturePad');
      const signedInput = document.getElementById('signedImage');
      if (canvas) {
        if (signaturePad) {
          try { signaturePad.off && signaturePad.off(); } catch (e) { }
          signaturePad = null;
        }

        resizeCanvasForDisplay(canvas);

        signaturePad = new SignaturePad(canvas, {
          backgroundColor: 'rgba(255,255,255,1)',
          penColor: 'rgb(0, 0, 0)'
        });

        if (signedInput && signedInput.value && signedInput.value.length > 20) {
          try {
            signaturePad.fromDataURL(signedInput.value);
          } catch (e) {
            console.log('Could not load employee signature from data:', e);
            signaturePad.clear();
          }
        } else {
          signaturePad.clear();
        }

        const clearBtn = document.getElementById('clearSignature');
        if (clearBtn) clearBtn.onclick = () => {
          signaturePad.clear();
          if (signedInput) signedInput.value = '';
        };
      }

      const supervisorCanvas = document.getElementById('supervisorSignaturePad');
      const supervisorSignedInput = document.getElementById('supervisorSignedImage');
      if (supervisorCanvas) {
        if (supervisorSignaturePad) {
          try { supervisorSignaturePad.off && supervisorSignaturePad.off(); } catch (e) { }
          supervisorSignaturePad = null;
        }

        resizeCanvasForDisplay(supervisorCanvas);

        supervisorSignaturePad = new SignaturePad(supervisorCanvas, {
          backgroundColor: 'rgba(255,255,255,1)',
          penColor: 'rgb(0, 0, 0)'
        });

        if (supervisorSignedInput && supervisorSignedInput.value && supervisorSignedInput.value.length > 20) {
          try {
            supervisorSignaturePad.fromDataURL(supervisorSignedInput.value);
          } catch (e) {
            console.log('Could not load supervisor signature from data:', e);
            supervisorSignaturePad.clear();
          }
        } else {
          supervisorSignaturePad.clear();
        }

        const clearBtn = document.getElementById('clearSupervisorSignature');
        if (clearBtn) clearBtn.onclick = () => {
          supervisorSignaturePad.clear();
          if (supervisorSignedInput) supervisorSignedInput.value = '';
        };
      }
    }

    // Toast utility
    function showToast(message, type = '') {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      const toast = document.createElement('div');
      toast.className = 'toast ' + (type || '');
      toast.innerHTML = `<div class="content">${message}</div>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.transition = 'opacity 0.25s';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 250);
      }, 3200);
    }

    // Confirm utility
    function showConfirm(title, message) {
      return new Promise(resolve => {
        const backdrop = document.getElementById('confirmModalBackdrop');
        const t = document.getElementById('confirmModalTitle');
        const m = document.getElementById('confirmModalMessage');
        const ok = document.getElementById('confirmOkBtn');
        const cancel = document.getElementById('confirmCancelBtn');
        if (!backdrop || !t || !m || !ok || !cancel) return resolve(false);
        t.textContent = title || 'Confirm';
        m.textContent = message || '';
        backdrop.style.display = 'flex';

        function cleanup() {
          ok.removeEventListener('click', onOk);
          cancel.removeEventListener('click', onCancel);
          backdrop.style.display = 'none';
        }

        function onOk() { cleanup(); resolve(true); }
        function onCancel() { cleanup(); resolve(false); }

        ok.addEventListener('click', onOk);
        cancel.addEventListener('click', onCancel);
      });
    }

    // Print functionality
    function printDashboard() {
      if (!currentViewLog) {
        showToast('Please view a record first before printing.', 'warning');
        return;
      }

      let printContainer = document.getElementById('printContainer');
      if (!printContainer) {
        printContainer = document.createElement('div');
        printContainer.id = 'printContainer';
        document.body.appendChild(printContainer);
      }

      const printHTML = generatePaperHTML(currentViewLog);
      printContainer.innerHTML = printHTML;
      printContainer.style.display = 'block';

      setTimeout(() => {
        window.print();
        setTimeout(() => {
          printContainer.style.display = 'none';
        }, 100);
      }, 100);
    }

    document.getElementById('printDashboard').addEventListener('click', printDashboard);

    document.addEventListener('keydown', function (e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        printDashboard();
      }
    });

    // Paper View Modal Controls
    document.getElementById('backBtn').addEventListener('click', () => {
      document.getElementById('paperViewModal').classList.add('hidden');
      currentViewLog = null;
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadCampaigns();
      loadCoachingLogs();
    });
  </script>
</body>
</html>
