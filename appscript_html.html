<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Applicant Intake Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Roboto', 'sans-serif'],
          },
          colors: {
            'google-blue': '#4285F4',
            'brand-accent': '#CBEB33',
            'brand-dark': '#B5D12F',
            'bg-dark': '#0f172a',
            'text-dark': '#f1f5f9',
            'card-dark': '#1e293b',
            'border-dark': '#334155',
            'danger': '#ef4444',
            'primary-applicant': '#4285F4',
            'secondary-applicant': '#3b82f6',
          }
        }
      }
    }
  </script>
  <style>
    .animate-spin-slow {
        animation: spin 2.5s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .tab-content.active {
      display: block;
    }
    .tab-content {
      display: none;
    }
    .file-upload-input {
        opacity: 0;
        width: 0.1px;
        height: 0.1px;
        position: absolute;
        z-index: -1;
    }
    .file-upload-label {
        cursor: pointer;
        transition: background-color 0.15s ease-in-out;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-800 font-sans dark:bg-bg-dark dark:text-text-dark">

  <header class="flex items-center gap-4 bg-white dark:bg-card-dark p-4 shadow-md sticky top-0 z-30 border-b border-gray-100 dark:border-border-dark">
    <div class="h-10 w-10 bg-primary-applicant rounded-lg flex items-center justify-center">
      <i class="fas fa-building text-white text-xl"></i>
    </div>
    <h1 class="text-2xl font-extrabold text-gray-900 dark:text-text-dark">Applicant Intake Portal</h1>
    <button id="themeToggle"
          class="ml-auto p-2 rounded-full text-gray-800 dark:text-text-dark bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition-all duration-300 transform hover:scale-105"
          aria-label="Toggle Dark Mode">
          <span class="material-symbols-outlined text-xl">dark_mode</span>
    </button>
  </header>

  <main id="mainContent" class="max-w-[1600px] mx-auto p-6 lg:p-10 space-y-6">

    <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
        <div class="flex bg-white dark:bg-card-dark p-2 rounded-xl shadow-lg border border-gray-200 dark:border-border-dark w-full md:w-auto" role="tablist">
            <button id="tabForm" onclick="switchTab('form')"
                    class="tab-btn active inline-flex items-center justify-center flex-1 px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-border-dark dark:hover:bg-card-dark hover:text-primary-applicant dark:hover:text-primary-applicant">
                <i class="fas fa-file-signature mr-2"></i> Job Application Form
            </button>
            <button id="tabData" onclick="switchTab('data')"
                    class="tab-btn inline-flex items-center justify-center flex-1 px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-border-dark hover:text-primary-applicant dark:hover:text-primary-applicant">
                <i class="fas fa-table-list mr-2"></i> Application Data Table
            </button>
        </div>
        <button onclick="exportData()"
                class="inline-flex items-center bg-brand-accent hover:bg-brand-dark text-bg-dark px-4 py-2 rounded-full shadow-lg font-bold transition duration-300 transform hover:scale-[1.03] text-sm w-full md:w-auto">
            <i class="fas fa-download mr-2"></i> Export to CSV
        </button>
    </div>

    <div id="formContent" class="tab-content active">
        <div class="bg-white dark:bg-card-dark rounded-2xl shadow-2xl p-6 lg:p-8">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-text-dark border-b pb-3 mb-6 border-gray-200 dark:border-border-dark">
                <i class="fas fa-user-check text-primary-applicant mr-2"></i> Standardized Job Application
            </h2>
            <form id="applicantForm" class="space-y-6">
                
                <fieldset class="border p-4 rounded-lg border-gray-200 dark:border-border-dark space-y-4">
                    <legend class="text-lg font-semibold px-2 text-primary-applicant">Personal Details</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">First Name</label>
                            <input type="text" id="firstName" name="FirstName" required 
                                class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-primary-applicant focus:border-primary-applicant transition">
                        </div>
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Name</label>
                            <input type="text" id="lastName" name="LastName" required 
                                class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-primary-applicant focus:border-primary-applicant transition">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address</label>
                            <input type="email" id="email" name="Email" required 
                                class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-primary-applicant focus:border-primary-applicant transition">
                        </div>
                    </div>
                </fieldset>

                <fieldset class="border p-4 rounded-lg border-gray-200 dark:border-border-dark space-y-4">
                    <legend class="text-lg font-semibold px-2 text-primary-applicant">Application Details</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="position" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Position Applied For</label>
                            <select id="position" name="Position" required
                                class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-primary-applicant focus:border-primary-applicant transition">
                                <option value="">Select Position...</option>
                                <option value="Customer Service Representative">Customer Service Representative</option>
                                <option value="Team Lead">Team Lead</option>
                                <option value="IT Support Specialist">IT Support Specialist</option>
                                <option value="Finance Analyst">Finance Analyst</option>
                            </select>
                        </div>
                        <div>
                            <label for="source" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">How did you hear about us?</label>
                            <select id="source" name="Source"
                                class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-primary-applicant focus:border-primary-applicant transition">
                                <option value="Website">Company Website</option>
                                <option value="Referral">Employee Referral</option>
                                <option value="JobBoard">Job Board (e.g., Indeed, LinkedIn)</option>
                                <option value="SocialMedia">Social Media</option>
                            </select>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="border p-4 rounded-lg border-gray-200 dark:border-border-dark space-y-4">
                    <legend class="text-lg font-semibold px-2 text-primary-applicant">Upload Documents</legend>
                    <div>
                        <label for="resume" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Resume/CV (PDF or DOCX)</label>
                        <input type="file" id="resume" name="Resume" accept=".pdf,.doc,.docx" class="file-upload-input" onchange="updateFileName(this)">
                        <label for="resume" class="file-upload-label w-full p-3 inline-flex items-center justify-center border-2 border-primary-applicant border-dashed rounded-lg bg-blue-50 dark:bg-blue-900/50 text-primary-applicant hover:bg-blue-100 dark:hover:bg-blue-900 transition">
                            <i class="fas fa-cloud-arrow-up mr-3"></i>
                            <span id="resumeFileName" class="font-medium">Click to upload your Resume/CV</span>
                        </label>
                    </div>
                </fieldset>

                <div class="pt-4 flex justify-end">
                    <button type="submit" id="submitApplicantBtn"
                        class="inline-flex items-center bg-primary-applicant hover:bg-blue-600 text-white px-8 py-3 rounded-full shadow-xl font-bold transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed text-lg">
                        <i class="fas fa-paper-plane mr-2"></i> Submit Application
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="dataContent" class="tab-content">
        <div class="relative bg-white dark:bg-card-dark rounded-2xl shadow-2xl overflow-hidden border border-gray-100 dark:border-border-dark">

            <div id="applicantLoadingSpinner"
                class="hidden absolute inset-0 bg-white/90 dark:bg-card-dark/90 backdrop-blur-sm flex justify-center items-center z-40">
                <div class="flex flex-col items-center">
                    <i class="fas fa-sync-alt fa-3x text-primary-applicant animate-spin-slow"></i>
                    <p id="applicantLoadingText" class="mt-3 text-lg text-gray-700 dark:text-text-dark font-medium">Loading applicant data...</p>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-200 dark:bg-border-dark text-gray-700 dark:text-text-dark uppercase tracking-wider">
                        <tr>
                            <th class="px-4 py-4 text-left font-semibold">Applicant Name</th>
                            <th class="px-4 py-4 text-left font-semibold">Position</th>
                            <th class="px-4 py-4 text-left font-semibold">Date Applied</th>
                            <th class="px-4 py-4 text-left font-semibold">Source</th>
                            <th class="px-4 py-4 text-center font-semibold">Status</th>
                            <th class="px-4 py-4 text-center font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="applicantTable" class="divide-y divide-gray-200 dark:divide-border-dark bg-white dark:bg-card-dark text-gray-700 dark:text-gray-300">
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
                                <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                                <p>No applicants yet. Submit the first application!</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  </main>

  <script>
    // Dark Mode Logic
    const themeToggle = document.getElementById('themeToggle');
    function updateThemeIcon(isDark) {
      themeToggle.innerHTML = isDark 
        ? '<span class="material-symbols-outlined text-xl">light_mode</span>' 
        : '<span class="material-symbols-outlined text-xl">dark_mode</span>';
    }

    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateThemeIcon(isDark);
    }

    themeToggle.addEventListener('click', toggleTheme);

    const storedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialDark = storedTheme === 'dark' || (storedTheme === null && prefersDark);
    if (initialDark) {
      document.body.classList.add('dark');
    }
    updateThemeIcon(initialDark);

    // Tab Switching Logic
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-gray-100', 'dark:bg-border-dark', 'active');
        btn.classList.add('hover:bg-gray-100', 'dark:hover:bg-border-dark');
      });

      document.getElementById(`${tabId}Content`).classList.add('active');
      const activeBtn = document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`);
      if (activeBtn) {
        activeBtn.classList.add('bg-gray-100', 'dark:bg-border-dark', 'active');
        activeBtn.classList.remove('hover:bg-gray-100', 'dark:hover:bg-border-dark');
      }

      if (tabId === 'data') {
        loadApplicants();
      }
    }

    // File name update
    function updateFileName(input) {
      const fileNameDisplay = document.getElementById('resumeFileName');
      if (input.files.length > 0) {
        fileNameDisplay.textContent = input.files[0].name;
      } else {
        fileNameDisplay.textContent = 'Click to upload your Resume/CV';
      }
    }

    // Form Submission
    document.getElementById('applicantForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitButton = document.getElementById('submitApplicantBtn');
      const originalButtonHtml = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';

      const formData = {
        FirstName: document.getElementById('firstName').value,
        LastName: document.getElementById('lastName').value,
        Email: document.getElementById('email').value,
        Position: document.getElementById('position').value,
        Source: document.getElementById('source').value,
        DateApplied: new Date().toISOString().split('T')[0]
      };

      // Handle file upload
      const fileInput = document.getElementById('resume');
      let fileData = null;
      
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        try {
          fileData = await new Promise((resolve, reject) => {
            reader.onload = (e) => {
              const base64 = e.target.result.split(',')[1];
              resolve({
                data: base64,
                filename: file.name,
                mimeType: file.type
              });
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        } catch (error) {
          console.error('File read error:', error);
        }
      }

      // Submit to Google Sheets
      google.script.run
        .withSuccessHandler((response) => {
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonHtml;
          
          if (response.success) {
            alert('Application submitted successfully!');
            document.getElementById('applicantForm').reset();
            document.getElementById('resumeFileName').textContent = 'Click to upload your Resume/CV';
          } else {
            alert('Error: ' + response.message);
          }
        })
        .withFailureHandler((error) => {
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonHtml;
          alert('Submission failed: ' + error.message);
        })
        .submitApplication(formData, fileData);
    });

    // Load Applicants
    function loadApplicants() {
      const spinner = document.getElementById('applicantLoadingSpinner');
      const tableBody = document.getElementById('applicantTable');
      
      spinner.classList.remove('hidden');
      
      google.script.run
        .withSuccessHandler((response) => {
          spinner.classList.add('hidden');
          
          if (response.success) {
            displayApplicants(response.data);
          } else {
            alert('Error loading applicants: ' + response.message);
          }
        })
        .withFailureHandler((error) => {
          spinner.classList.add('hidden');
          alert('Failed to load applicants: ' + error.message);
        })
        .getApplicants();
    }

    // Display Applicants in Table
    function displayApplicants(applicants) {
      const tableBody = document.getElementById('applicantTable');
      
      if (!applicants || applicants.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
              <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
              <p>No applicants yet. Submit the first application!</p>
            </td>
          </tr>
        `;
        return;
      }

      tableBody.innerHTML = applicants.map(applicant => {
        const statusClass = getStatusClass(applicant.status);
        const dateStr = formatDate(applicant.dateApplied);
        
        return `
          <tr class="hover:bg-gray-50 dark:hover:bg-card-dark transition duration-150">
            <td class="px-4 py-3 font-medium text-gray-900 dark:text-text-dark">
              ${applicant.firstName} ${applicant.lastName}
            </td>
            <td class="px-4 py-3">${applicant.position}</td>
            <td class="px-4 py-3">${dateStr}</td>
            <td class="px-4 py-3">${applicant.source}</td>
            <td class="px-4 py-3 text-center">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">
                ${applicant.status}
              </span>
            </td>
            <td class="px-4 py-3 text-center whitespace-nowrap">
              ${applicant.resumeUrl && applicant.resumeUrl !== 'No file uploaded' ? 
                `<a href="${applicant.resumeUrl}" target="_blank" class="text-primary-applicant hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 mr-2" title="View Resume">
                  <i class="fas fa-file-pdf"></i>
                </a>` : 
                `<span class="text-gray-400 mr-2" title="No resume"><i class="fas fa-file-pdf"></i></span>`
              }
              <button onclick="updateStatus('${applicant.id}')" class="text-secondary-applicant hover:text-blue-700 dark:text-blue-300 dark:hover:text-blue-200 mr-2" title="Update Status">
                <i class="fas fa-arrow-right"></i>
              </button>
              <button onclick="deleteApplicant('${applicant.id}')" class="text-danger hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Update Status
    function updateStatus(id) {
      const newStatus = prompt('Enter new status (e.g., "Interview Stage", "Offer Stage", "Hired", "Rejected"):');
      
      if (newStatus) {
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              alert('Status updated successfully!');
              loadApplicants();
            } else {
              alert('Error: ' + response.message);
            }
          })
          .withFailureHandler((error) => {
            alert('Failed to update status: ' + error.message);
          })
          .updateApplicantStatus(id, newStatus);
      }
    }

    // Delete Applicant
    function deleteApplicant(id) {
      if (confirm('Are you sure you want to delete this applicant?')) {
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              alert('Applicant deleted successfully!');
              loadApplicants();
            } else {
              alert('Error: ' + response.message);
            }
          })
          .withFailureHandler((error) => {
            alert('Failed to delete applicant: ' + error.message);
          })
          .deleteApplicant(id);
      }
    }

    // Export to CSV
    function exportData() {
      google.script.run
        .withSuccessHandler((response) => {
          if (response.success) {
            const blob = new Blob([response.data], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `applicants_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
          } else {
            alert('Error exporting data: ' + response.message);
          }
        })
        .withFailureHandler((error) => {
          alert('Export failed: ' + error.message);
        })
        .exportToCSV();
    }

    // Helper Functions
    function getStatusClass(status) {
      const statusMap = {
        'New Applicant': 'bg-primary-applicant/10 text-primary-applicant dark:bg-primary-applicant/30 dark:text-blue-200',
        'Interview Stage': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
        'Offer Stage': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
        'Hired': 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200',
        'Rejected': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
      };
      return statusMap[status] || 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
    }

    function formatDate(date) {
      if (!date) return 'N/A';
      const d = new Date(date);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      switchTab('form');
    });
  </script>
</body>
</html>