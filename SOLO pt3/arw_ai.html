<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ARW Ops Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
</head>

<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="flex justify-between items-center px-8 py-4 bg-white shadow-lg fixed w-full top-0 z-20">
    <h1 class="text-3xl font-extrabold text-slate-800">
      <span class="text-lime-500">ARW</span> Ops Center
    </h1>
    <button id="aiToggle" class="bg-lime-500 hover:bg-lime-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
      <i data-feather="message-circle"></i> Ask AI
    </button>
  </header>

  <!-- Menu Section -->
  <main class="max-w-3xl mx-auto mt-28 p-6">
    <h2 class="text-xl font-bold mb-4 text-slate-700">Department Menu</h2>
    <div id="menuContainer" class="bg-white rounded-xl shadow-lg divide-y border border-slate-200"></div>
  </main>

  <!-- AI Chat Widget -->
  <div id="aiChat"
    class="hidden fixed bottom-6 right-6 bg-white border border-gray-200 shadow-2xl rounded-xl w-80 max-h-[70vh] flex flex-col overflow-hidden z-50">
    <div class="bg-lime-500 text-white px-4 py-3 flex justify-between items-center">
      <span class="font-bold">ARW AI Assistant</span>
      <button id="aiClose" class="text-white hover:text-gray-200 text-lg leading-none">&times;</button>
    </div>
    <div id="aiMessages" class="flex-1 overflow-y-auto p-3 space-y-3 text-sm text-gray-700">
      <div class="bg-gray-100 p-2 rounded-lg">ðŸ‘‹ Hi! I can help you navigate the ARW Ops Center.</div>
    </div>
    <div class="border-t p-2 flex items-center">
      <input id="aiInput" type="text" placeholder="Ask something..."
        class="flex-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-lime-400 focus:outline-none">
      <button id="aiSend" class="ml-2 bg-lime-500 hover:bg-lime-600 text-white px-3 py-2 rounded-lg">
        <i data-feather="send"></i>
      </button>
    </div>
  </div>

  <script>
    feather.replace();

    // âœ… Replace with your Web App deployment URL (ends in /exec)
    const API_URL = "https://script.google.com/macros/s/AKfycbyfHSS83z0O8Buq5YmDWb3fpwv1OoKgXMzQ16Es0SMgxWVXTUX-iIC2vPo0eOKXuY_8/exec";

    // ==============================
    // LOAD MENU
    // ==============================
    async function loadMenu() {
      try {
        const res = await fetch(`${API_URL}?mode=menu`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        renderMenu(data);
      } catch (err) {
        console.error("Menu load error:", err);
        document.getElementById("menuContainer").innerHTML =
          `<p class="text-red-500 p-4">Failed to load menu: ${err.message}</p>`;
      }
    }

    function renderMenu(data) {
      const grouped = {};
      data.forEach(row => {
        const dept = row.Department || "Other";
        if (!grouped[dept]) grouped[dept] = [];
        grouped[dept].push(row);
      });

      const container = document.getElementById("menuContainer");
      container.innerHTML = "";

      Object.entries(grouped).forEach(([dept, items]) => {
        const wrapper = document.createElement("div");
        wrapper.innerHTML = `
          <button class="w-full text-left flex justify-between items-center p-4 hover:bg-gray-50">
            <span class="font-semibold text-slate-800">${dept}</span>
            <i data-feather="chevron-right" class="text-slate-400"></i>
          </button>
          <div class="hidden px-6 pb-4 space-y-3 text-sm text-slate-600"></div>
        `;

        const content = wrapper.querySelector("div");
        items.forEach(it => {
          content.innerHTML += `
            <p>
              <a href="${it.Link || '#'}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-2">
                <i data-feather="link" class="w-4 h-4"></i>${it.Title}
              </a>
            </p>`;
        });

        wrapper.querySelector("button").addEventListener("click", () => {
          const isOpen = !content.classList.contains("hidden");
          document.querySelectorAll("#menuContainer div > div").forEach(div => div.classList.add("hidden"));
          document.querySelectorAll("#menuContainer button i").forEach(icon => icon.setAttribute("data-feather", "chevron-right"));
          if (!isOpen) {
            content.classList.remove("hidden");
            wrapper.querySelector("i").setAttribute("data-feather", "chevron-down");
          }
          feather.replace();
        });

        container.appendChild(wrapper);
      });
      feather.replace();
    }

    // ==============================
    // AI CHAT
    // ==============================
    const aiToggle = document.getElementById("aiToggle");
    const aiChat = document.getElementById("aiChat");
    const aiClose = document.getElementById("aiClose");
    const aiInput = document.getElementById("aiInput");
    const aiSend = document.getElementById("aiSend");
    const aiMessages = document.getElementById("aiMessages");

    aiToggle.onclick = () => { aiChat.classList.remove("hidden"); aiToggle.classList.add("hidden"); };
    aiClose.onclick = () => { aiChat.classList.add("hidden"); aiToggle.classList.remove("hidden"); };
    aiSend.onclick = sendPrompt;
    aiInput.onkeydown = e => { if (e.key === "Enter") sendPrompt(); };

    async function sendPrompt() {
      const prompt = aiInput.value.trim();
      if (!prompt) return;

      aiMessages.innerHTML += `<div class='bg-blue-100 p-2 rounded-lg self-end text-right'>${prompt}</div>`;
      aiInput.value = "";
      aiMessages.innerHTML += `<div class='text-gray-500 text-sm italic'>Thinking...</div>`;
      aiMessages.scrollTop = aiMessages.scrollHeight;

      try {
        const res = await fetch(`${API_URL}?mode=ai`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
          mode: "no-cors", // ðŸ‘ˆ Added for local testing
        });

        // CORS-safe fallback since no-cors blocks JSON parsing
        if (!res || res.type === "opaque") {
          aiMessages.lastElementChild.remove();
          aiMessages.innerHTML += `<div class='bg-gray-100 p-2 rounded-lg'>Response received (check server logs for reply).</div>`;
          return;
        }

        const data = await res.json();
        aiMessages.lastElementChild.remove();
        aiMessages.innerHTML += `<div class='bg-gray-100 p-2 rounded-lg'>${data.reply || data.error || "No response."}</div>`;
        aiMessages.scrollTop = aiMessages.scrollHeight;
      } catch (err) {
        aiMessages.lastElementChild.remove();
        aiMessages.innerHTML += `<div class='text-red-500 p-2 text-sm'>Error: ${err.message}</div>`;
        console.error("AI fetch error:", err);
      }
    }

    // INIT
    window.onload = loadMenu;
  </script>
</body>
</html>
