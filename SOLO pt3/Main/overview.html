<!-- Executive Summary Page -->
<div id="page-overview">
  <!-- Filters -->
  <div class="flex items-center justify-end gap-4 mb-6">
    <div class="flex items-center gap-2 text-sm">
      <div class="relative">
        <select id="monthFilter" class="py-2 pl-3 pr-8 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-brand-accent"></select>
      </div>
      <div class="relative">
        <select id="yearFilter" class="py-2 pl-3 pr-8 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-brand-accent"></select>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
    <div class="kpi-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-4 flex flex-col border-t-4 border-brand-accent">
      <span class="material-symbols-outlined text-2xl text-brand-accent mb-1">groups</span>
      <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Headcount</p>
      <p class="text-xl font-bold mt-1 text-gray-900 dark:text-white" data-kpi="headcount">—</p>
    </div>

    <div class="kpi-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-4 flex flex-col border-t-4 border-green-500">
      <span class="material-symbols-outlined text-2xl text-green-500 mb-1">person_check</span>
      <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Active Agents</p>
      <p class="text-xl font-bold mt-1 text-gray-900 dark:text-white" data-kpi="active">—</p>
    </div>

    <div class="kpi-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-4 flex flex-col border-t-4 border-yellow-400">
      <span class="material-symbols-outlined text-2xl text-yellow-400 mb-1">trending_up</span>
      <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Utilization %</p>
      <p class="text-xl font-bold mt-1 text-gray-900 dark:text-white" data-kpi="utilization">—</p>
    </div>

    <div class="kpi-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-4 flex flex-col border-t-4 border-blue-500">
      <span class="material-symbols-outlined text-2xl text-blue-500 mb-1">person_pin_circle</span>
      <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Attendance %</p>
      <p class="text-xl font-bold mt-1 text-gray-900 dark:text-white" data-kpi="attendanceScore">—</p>
    </div>

    <div class="kpi-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-4 flex flex-col border-t-4 border-red-500">
      <span class="material-symbols-outlined text-2xl text-red-500 mb-1">schedule</span>
      <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Lost Hours</p>
      <p class="text-xl font-bold mt-1 text-gray-900 dark:text-white" data-kpi="lostHours">—</p>
    </div>

    <div class="kpi-card bg-white dark:bg-gray-800 shadow-lg rounded-xl p-4 flex flex-col border-t-4 border-green-500">
      <span class="material-symbols-outlined text-2xl text-green-500 mb-1">work_history</span>
      <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Billed Hours</p>
      <p class="text-xl font-bold mt-1 text-gray-900 dark:text-white" data-kpi="billedHours">—</p>
    </div>
  </div>

  <!-- Data Table -->
  <div class="mt-8 bg-white dark:bg-gray-800 shadow-lg rounded-xl">
    <div class="flex flex-col sm:flex-row items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold mb-2 sm:mb-0 text-gray-900 dark:text-white">Core Metrics and Risk Signals</h3>
      <div class="relative w-full sm:w-64">
        <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 text-xl">search</span>
        <input type="text" id="searchBar" placeholder="Search Campaign or Cluster..." class="w-full py-2 pl-10 pr-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-brand-accent">
      </div>
    </div>

    <div class="table-wrapper">
      <table class="data-table w-full table-auto text-sm text-left">
        <thead class="bg-gray-100 dark:bg-gray-700 uppercase text-xs border-b border-gray-200 dark:border-gray-600">
          <tr id="tableHeaders">
            <th class="px-4 py-2 font-medium text-gray-700 dark:text-gray-300">
              <div class="sortable-header" data-column="Campaign" data-type="string">Campaign<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
            <th class="px-4 py-2 font-medium text-gray-700 dark:text-gray-300">
              <div class="sortable-header" data-column="Cluster" data-type="string">Cluster<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
            <th class="px-4 py-2 font-medium text-right text-gray-700 dark:text-gray-300">
              <div class="sortable-header justify-end" data-column="Headcount" data-type="number">HC<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
            <th class="px-4 py-2 font-medium text-right text-gray-700 dark:text-gray-300">
              <div class="sortable-header justify-end" data-column="Utilization" data-type="number">Util %<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
            <th class="px-4 py-2 font-medium text-right text-gray-700 dark:text-gray-300">
              <div class="sortable-header justify-end" data-column="AttendanceScore" data-type="number">Attend %<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
            <th class="px-4 py-2 font-medium text-right text-gray-700 dark:text-gray-300">
              <div class="sortable-header justify-end" data-column="BilledHours" data-type="number">Billed (hrs)<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
            <th class="px-4 py-2 font-medium text-right text-gray-700 dark:text-gray-300">
              <div class="sortable-header justify-end" data-column="LostHours" data-type="number">Lost (hrs)<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
            <th class="px-4 py-2 font-medium text-right text-gray-700 dark:text-gray-300">
              <div class="sortable-header justify-end" data-column="PTO" data-type="number">PTO (hrs)<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
            <th class="px-4 py-2 font-medium text-right text-gray-700 dark:text-gray-300">
              <div class="sortable-header justify-end" data-column="Overtime" data-type="number">OT (hrs)<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
            <th class="px-4 py-2 font-medium text-right text-gray-700 dark:text-gray-300">
              <div class="sortable-header justify-end" data-column="TurnoverRate" data-type="number">T.O. %<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
            <th class="px-4 py-2 font-medium text-center text-gray-700 dark:text-gray-300">
              <div class="sortable-header justify-center" data-column="Risk" data-type="number">Risk<span class="material-symbols-outlined sort-icon">unfold_more</span></div>
            </th>
          </tr>
        </thead>
        <tbody id="metricsTableBody" class="divide-y divide-gray-100 dark:divide-gray-700">
          <tr><td colspan="11" class="text-center py-4 text-gray-500 dark:text-gray-400">Loading data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Overview page initialization and logic
  (function() {
    const OverviewModule = {
      allCampaignMetrics: [],
      filteredCampaignMetrics: [],
      currentSortColumn: { key: 'Campaign', direction: 'asc' },
      initialized: false,

      init() {
        // Prevent double initialization
        if (this.initialized) {
          console.log('Overview already initialized');
          return;
        }
        
        this.initialized = true;
        this.setupFilters();
        this.setupEventListeners();
        this.fetchData();
      },

      setupFilters() {
        const today = new Date();
        const currentMonth = today.getMonth() + 1;
        const currentYear = today.getFullYear();
        const monthFilter = document.getElementById('monthFilter');
        const yearFilter = document.getElementById('yearFilter');

        if (!monthFilter || !yearFilter) {
          console.error('Filter elements not found');
          return;
        }

        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        monthFilter.innerHTML = monthNames.map((name, index) =>
          `<option value="${index + 1}" ${index + 1 === currentMonth ? 'selected' : ''}>${name}</option>`
        ).join('');

        const startYear = currentYear - 2;
        const endYear = currentYear + 2;
        yearFilter.innerHTML = '';
        for (let year = startYear; year <= endYear; year++) {
          yearFilter.innerHTML += `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`;
        }
      },

      setupEventListeners() {
        const monthFilter = document.getElementById('monthFilter');
        const yearFilter = document.getElementById('yearFilter');
        const searchBar = document.getElementById('searchBar');

        if (monthFilter) {
          monthFilter.addEventListener('change', () => this.fetchData());
        }
        
        if (yearFilter) {
          yearFilter.addEventListener('change', () => this.fetchData());
        }
        
        if (searchBar) {
          searchBar.addEventListener('input', (e) => this.filterData(e.target.value));
        }

        // Sort headers
        document.querySelectorAll('.sortable-header').forEach(header => {
          header.addEventListener('click', () => {
            const columnKey = header.dataset.column;
            const isSameColumn = this.currentSortColumn.key === columnKey;
            let direction = 'asc';
            if (isSameColumn) {
              direction = this.currentSortColumn.direction === 'asc' ? 'desc' : 'asc';
            }
            this.currentSortColumn = { key: columnKey, direction: direction };
            this.applySort();
          });
        });
      },

      async fetchData() {
        if (typeof AppUtils === 'undefined' || typeof AppUtils.showSpinner !== 'function') {
          console.warn('AppUtils not available');
        } else {
          AppUtils.showSpinner();
        }

        const monthFilter = document.getElementById('monthFilter');
        const yearFilter = document.getElementById('yearFilter');
        const tableBody = document.getElementById('metricsTableBody');

        if (!monthFilter || !yearFilter || !tableBody) {
          console.error('Required elements not found');
          return;
        }

        const month = monthFilter.value;
        const year = yearFilter.value;

        tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-gray-500 dark:text-gray-400">Fetching metrics...</td></tr>';

        try {
          // Check if AppConfig exists
          if (typeof AppConfig === 'undefined' || !AppConfig.API || !AppConfig.API.EXEC_SUMMARY) {
            throw new Error('AppConfig.API.EXEC_SUMMARY is not defined');
          }

          // Check if AppUtils.fetchData exists
          if (typeof AppUtils === 'undefined' || typeof AppUtils.fetchData !== 'function') {
            throw new Error('AppUtils.fetchData is not available');
          }

          const url = `${AppConfig.API.EXEC_SUMMARY}?month=${month}&year=${year}`;
          const data = await AppUtils.fetchData(url);

          if (data.error) {
            tableBody.innerHTML = `<tr class="text-center"><td colspan="11" class="py-4 text-red-500 dark:text-red-400">${this.escapeHtml(data.error)}</td></tr>`;
            this.updateKPIs({ headcount: 0, active: 0, lostHours: 0, billedHours: 0, utilization: 'N/A', attendanceScore: 'N/A' });
            return;
          }

          this.allCampaignMetrics = data.rows || [];

          // Calculate lost hours and risk for each campaign
          this.allCampaignMetrics.forEach(r => {
            const util = this.parseValue(r.Utilization);
            const billed = this.parseValue(r.BilledHours);
            const attend = this.parseValue(r.AttendanceScore);
            const turnover = this.parseValue(r.TurnoverRate);

            let lostHours = 0;
            if (util > 0 && billed > 0) {
              const potential = billed / (util / 100);
              lostHours = this.parseValue((potential - billed).toFixed(1));
            }
            r.LostHours = lostHours;

            const isLowUtil = util > 0 && util < 90.0;
            const isLowAttend = attend > 0 && attend < 95.0;
            const isHighTurnover = turnover > 5.0;
            r.Risk = (isLowUtil || isLowAttend || isHighTurnover) ? 1 : 0;
          });

          const searchBar = document.getElementById('searchBar');
          this.filterData(searchBar ? searchBar.value : '');

        } catch (err) {
          console.error('Network or Parsing Error:', err);
          tableBody.innerHTML = `<tr><td colspan="11" class="text-center py-4 text-red-500 dark:text-red-400">Failed to load data: ${this.escapeHtml(err.message)}</td></tr>`;
          this.updateKPIs({ headcount: 0, active: 0, lostHours: 0, billedHours: 0, utilization: 'N/A', attendanceScore: 'N/A' });
        } finally {
          if (typeof AppUtils !== 'undefined' && typeof AppUtils.hideSpinner === 'function') {
            AppUtils.hideSpinner();
          }
        }
      },

      filterData(query) {
        if (!query) {
          this.filteredCampaignMetrics = [...this.allCampaignMetrics];
        } else {
          const lowerQuery = query.toLowerCase();
          this.filteredCampaignMetrics = this.allCampaignMetrics.filter(r =>
            (r.Campaign || '').toLowerCase().includes(lowerQuery) ||
            (r.Cluster || '').toLowerCase().includes(lowerQuery)
          );
        }

        this.recalculateKPIs();
        this.applySort();
      },

      recalculateKPIs() {
        let totalHeadcountInView = 0;
        let activeAgentCount = 0;
        let operationalLostHours = 0;
        let operationalBilledHours = 0;
        let operationalPotentialHours = 0;
        let operationalAttendanceSum = 0;
        let validOperationalAttendanceCount = 0;

        this.filteredCampaignMetrics.forEach(r => {
          const headcount = this.parseValue(r.Headcount);
          totalHeadcountInView += headcount;

          if (r.Cluster !== 'Admin') {
            const billedHours = this.parseValue(r.BilledHours);
            const utilization = this.parseValue(r.Utilization);
            const attendanceScore = this.parseValue(r.AttendanceScore);

            activeAgentCount += headcount;

            let lostHours = 0;
            if (utilization > 0 && billedHours > 0) {
              const potential = billedHours / (utilization / 100);
              lostHours = potential - billedHours;
            }

            operationalBilledHours += billedHours;
            operationalLostHours += lostHours;
            operationalPotentialHours += billedHours + lostHours;

            if (attendanceScore > 0) {
              operationalAttendanceSum += attendanceScore;
              validOperationalAttendanceCount++;
            }
          }
        });

        const filteredUtilization = operationalPotentialHours > 0
          ? ((operationalBilledHours / operationalPotentialHours) * 100).toFixed(1)
          : 'N/A';

        const filteredAttendance = validOperationalAttendanceCount > 0
          ? (operationalAttendanceSum / validOperationalAttendanceCount).toFixed(1)
          : 'N/A';

        this.updateKPIs({
          headcount: totalHeadcountInView,
          active: activeAgentCount,
          lostHours: operationalLostHours,
          billedHours: operationalBilledHours,
          utilization: filteredUtilization,
          attendanceScore: filteredAttendance
        });
      },

      updateKPIs(data) {
        const elements = {
          headcount: document.querySelector('[data-kpi="headcount"]'),
          active: document.querySelector('[data-kpi="active"]'),
          utilization: document.querySelector('[data-kpi="utilization"]'),
          attendanceScore: document.querySelector('[data-kpi="attendanceScore"]'),
          lostHours: document.querySelector('[data-kpi="lostHours"]'),
          billedHours: document.querySelector('[data-kpi="billedHours"]')
        };

        if (elements.headcount) elements.headcount.textContent = this.formatNumber(data.headcount);
        if (elements.active) elements.active.textContent = this.formatNumber(data.active);
        if (elements.utilization) elements.utilization.textContent = this.formatPercent(data.utilization);
        if (elements.attendanceScore) elements.attendanceScore.textContent = this.formatPercent(data.attendanceScore);
        if (elements.lostHours) elements.lostHours.textContent = this.formatHours(data.lostHours);
        if (elements.billedHours) elements.billedHours.textContent = this.formatHours(data.billedHours);
      },

      applySort() {
        const { key, direction } = this.currentSortColumn;
        const activeHeader = document.querySelector(`[data-column="${key}"]`);
        const dataType = activeHeader ? activeHeader.dataset.type : 'string';

        this.filteredCampaignMetrics.sort((a, b) => {
          let valA = a[key];
          let valB = b[key];

          if (dataType === 'number') {
            valA = this.parseValue(valA);
            valB = this.parseValue(valB);
          } else {
            valA = String(valA || '').toLowerCase();
            valB = String(valB || '').toLowerCase();
          }

          let comparison = 0;
          if (valA > valB) comparison = 1;
          else if (valA < valB) comparison = -1;

          return direction === 'asc' ? comparison : comparison * -1;
        });

        this.renderTable();
        this.updateSortIcons();
      },

      renderTable() {
        const tableBody = document.getElementById('metricsTableBody');
        if (!tableBody) return;

        tableBody.innerHTML = '';

        if (!this.filteredCampaignMetrics || this.filteredCampaignMetrics.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-gray-500 dark:text-gray-400">No campaigns match your filter criteria.</td></tr>';
          return;
        }

        this.filteredCampaignMetrics.forEach(r => {
          const billed = this.parseValue(r.BilledHours);
          const ptoHours = this.parseValue(r.PTO);
          const otHours = this.parseValue(r.Overtime);
          const util = this.parseValue(r.Utilization);
          const attend = this.parseValue(r.AttendanceScore);
          const turnover = this.parseValue(r.TurnoverRate);

          const isHighRisk = r.Risk === 1;

          const riskIcon = isHighRisk ? 'warning' : 'check_circle';
          const utilColor = (util > 0 && util < 90) ? 'text-red-500 dark:text-red-400' : 'text-green-500 dark:text-green-400';
          const attendColor = (attend > 0 && attend < 95) ? 'text-yellow-400' : 'text-green-500 dark:text-green-400';
          const turnoverColor = (turnover > 5) ? 'text-red-500 dark:text-red-400' : 'text-green-500 dark:text-green-400';
          const riskColor = isHighRisk ? 'text-red-500 dark:text-red-400' : 'text-green-500 dark:text-green-400';

          const formatNum = (val) => val !== 'N/A' && this.parseValue(val) > 0 ? this.parseValue(val).toFixed(1) : '—';
          const formatPercent = (val) => val !== 'N/A' && this.parseValue(val) > 0 ? this.parseValue(val).toFixed(1) + '%' : '—';

          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100 transition-colors';
          row.innerHTML = `
            <td class="px-4 py-2 font-semibold">${this.escapeHtml(r.Campaign || 'N/A')}</td>
            <td class="px-4 py-2 text-gray-500 dark:text-gray-400">${this.escapeHtml(r.Cluster || '—')}</td>
            <td class="px-4 py-2 text-right">${r.Headcount || '0'}</td>
            <td class="px-4 py-2 text-right ${utilColor}">${formatPercent(r.Utilization)}</td>
            <td class="px-4 py-2 text-right ${attendColor}">${formatPercent(r.AttendanceScore)}</td>
            <td class="px-4 py-2 text-right">${billed > 0 ? formatNum(billed) : '—'}</td>
            <td class="px-4 py-2 text-right">${r.LostHours > 0 ? formatNum(r.LostHours) : '—'}</td>
            <td class="px-4 py-2 text-right">${ptoHours > 0 ? formatNum(ptoHours) : '—'}</td>
            <td class="px-4 py-2 text-right">${otHours > 0 ? formatNum(otHours) : '—'}</td>
            <td class="px-4 py-2 text-right ${turnoverColor}">${formatPercent(r.TurnoverRate)}</td>
            <td class="px-4 py-2 text-center">
              <span class="material-symbols-outlined text-xl ${riskColor}" title="${isHighRisk ? 'Risk Detected' : 'OK'}">${riskIcon}</span>
            </td>
          `;
          tableBody.appendChild(row);
        });
      },

      updateSortIcons() {
        document.querySelectorAll('.sortable-header').forEach(header => {
          const icon = header.querySelector('.sort-icon');
          header.classList.remove('active-sort');
          if (icon) icon.textContent = 'unfold_more';
        });

        const activeHeader = document.querySelector(`[data-column="${this.currentSortColumn.key}"]`);
        if (activeHeader) {
          const icon = activeHeader.querySelector('.sort-icon');
          activeHeader.classList.add('active-sort');
          if (icon) {
            icon.textContent = this.currentSortColumn.direction === 'asc' ? 'arrow_upward' : 'arrow_downward';
          }
        }
      },

      // Utility functions
      parseValue(val) {
        if (typeof AppUtils !== 'undefined' && typeof AppUtils.parseValue === 'function') {
          return AppUtils.parseValue(val);
        }
        const num = parseFloat(val);
        return isNaN(num) ? 0 : num;
      },

      formatNumber(val) {
        if (typeof AppUtils !== 'undefined' && typeof AppUtils.formatNumber === 'function') {
          return AppUtils.formatNumber(val);
        }
        return val.toLocaleString();
      },

      formatPercent(val) {
        if (typeof AppUtils !== 'undefined' && typeof AppUtils.formatPercent === 'function') {
          return AppUtils.formatPercent(val);
        }
        return val === 'N/A' ? 'N/A' : val + '%';
      },

      formatHours(val) {
        if (typeof AppUtils !== 'undefined' && typeof AppUtils.formatHours === 'function') {
          return AppUtils.formatHours(val);
        }
        return val.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 });
      },

      escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
      }
    };

    // Make init function globally accessible
    window.init_overview = function() {
      OverviewModule.init();
    };

    // Auto-initialize if DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('page-overview')) {
          window.init_overview();
        }
      });
    } else {
      if (document.getElementById('page-overview')) {
        window.init_overview();
      }
    }
  })();
</script>