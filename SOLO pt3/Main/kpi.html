<!-- KPI Dashboard Page -->
<div id="page-kpi">
  <!-- Tabs -->
  <div class="border-b border-gray-300">
    <nav class="flex space-x-4">
      <button class="kpi-tab-btn active" data-kpi-tab="reports">Reports</button>
      <button class="kpi-tab-btn" data-kpi-tab="campaigns">Campaigns</button>
      <button class="kpi-tab-btn" data-kpi-tab="looker">Looker Studio</button>
    </nav>
  </div>

  <!-- Reports Tab -->
  <section id="kpi-tab-reports" class="kpi-tab-content mt-6">
    <div class="bg-white rounded-xl shadow p-6 space-y-6">
      <div>
        <h2 class="text-xl font-semibold mb-4">WFM Performance Reports</h2>
        <p class="text-gray-700 mb-4">Access or download client reports directly from Google Drive.</p>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-gray-50">
                <th class="text-left px-4 py-2">Campaign</th>
                <th class="text-left px-4 py-2">Report</th>
                <th class="text-left px-4 py-2">Description</th>
                <th class="text-left px-4 py-2">Google Drive Link</th>
                <th class="text-left px-4 py-2">Download</th>
              </tr>
            </thead>
            <tbody id="reportsTableBody">
              <tr><td colspan="5" class="text-center p-4 text-gray-500">Loading reports...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Campaigns Tab -->
  <section id="kpi-tab-campaigns" class="kpi-tab-content hidden mt-6">
    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="kpi-card bg-white shadow rounded-xl p-4 border-t-4 border-brandPrimary">
        <span class="material-symbols-outlined text-2xl text-brandPrimary mb-1">group_work</span>
        <p class="text-xs font-medium uppercase text-gray-500">Total Campaigns</p>
        <p class="text-xl font-bold mt-1" id="cardCampaigns">—</p>
      </div>

      <div class="kpi-card bg-white shadow rounded-xl p-4 border-t-4 border-brandPrimary">
        <span class="material-symbols-outlined text-2xl text-brandPrimary mb-1">checklist</span>
        <p class="text-xs font-medium uppercase text-gray-500">Total KPIs</p>
        <p class="text-xl font-bold mt-1" id="cardTotalKPI">—</p>
      </div>

      <div class="kpi-card bg-white shadow rounded-xl p-4 border-t-4 border-brandSuccess">
        <span class="material-symbols-outlined text-2xl text-brandSuccess mb-1">task_alt</span>
        <p class="text-xs font-medium uppercase text-gray-500">Passed</p>
        <p class="text-xl font-bold mt-1 text-brandSuccess" id="cardPassed">—</p>
      </div>

      <div class="kpi-card bg-white shadow rounded-xl p-4 border-t-4 border-brandDanger">
        <span class="material-symbols-outlined text-2xl text-brandDanger mb-1">cancel</span>
        <p class="text-xs font-medium uppercase text-gray-500">Failed</p>
        <p class="text-xl font-bold mt-1 text-brandDanger" id="cardFailed">—</p>
      </div>
    </div>

    <!-- KPI Table -->
    <div class="bg-white shadow rounded-xl overflow-x-auto mt-6">
      <h3 class="p-4 text-lg font-semibold border-b border-gray-200">Campaign KPI Targets</h3>
      <div class="overflow-x-auto">
        <table id="kpi-table" class="w-full">
          <thead>
            <tr class="bg-gray-50 text-xs uppercase">
              <th class="px-3 py-2 text-left sticky left-0 bg-gray-50">Campaign</th>
              <th class="px-3 py-2 text-left">KPI</th>
              <th class="px-3 py-2 text-right">Target</th>
              <th class="px-3 py-2 text-right">Threshold</th>
              <th class="px-3 py-2 text-right">Jan</th>
              <th class="px-3 py-2 text-right">Feb</th>
              <th class="px-3 py-2 text-right">Mar</th>
              <th class="px-3 py-2 text-right">Apr</th>
              <th class="px-3 py-2 text-right">May</th>
              <th class="px-3 py-2 text-right">Jun</th>
              <th class="px-3 py-2 text-right">Jul</th>
              <th class="px-3 py-2 text-right">Aug</th>
              <th class="px-3 py-2 text-right">Sep</th>
              <th class="px-3 py-2 text-right">Oct</th>
              <th class="px-3 py-2 text-right">Nov</th>
              <th class="px-3 py-2 text-right">Dec</th>
              <th class="px-3 py-2 text-right text-green-600">Passed</th>
              <th class="px-3 py-2 text-right text-red-600">Failed</th>
            </tr>
          </thead>
          <tbody id="kpiBody">
            <tr><td colspan="18" class="text-center p-4 text-gray-500">Loading data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Chart -->
    <div id="chart-container" class="bg-white shadow rounded-xl p-4 mt-6">
      <h3 class="text-lg font-semibold mb-4">Monthly KPI Trend</h3>
      <div id="chart_div" style="height:400px;"></div>
    </div>
  </section>

  <!-- Looker Studio Tab -->
  <section id="kpi-tab-looker" class="kpi-tab-content hidden mt-6">
    <div class="bg-white border border-gray-100 rounded-xl shadow-md overflow-hidden">
      <iframe width="100%" height="700" src="https://lookerstudio.google.com/embed/reporting/39311ca6-ede9-474f-bb9e-1b225f6b75ec/page/HXaaF" frameborder="0" style="border:0" allowfullscreen sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>
    </div>
  </section>
</div>

<script>
  // KPI Dashboard Module
  (function() {
    const KPIModule = {
      rawKPIData: {},
      googleChartsReady: false,
      initialized: false,
      chartDrawn: false,

      async init() {
        // Prevent double initialization
        if (this.initialized) {
          console.log('KPI already initialized');
          return;
        }
        
        this.initialized = true;

        // Initialize Google Charts
        this.initGoogleCharts();

        this.setupTabs();
        await this.fetchKPIData();
        await this.fetchReportsData();
      },

      initGoogleCharts() {
        // Load Google Charts if not already loaded
        if (typeof google === 'undefined' || typeof google.charts === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://www.gstatic.com/charts/loader.js';
          script.onload = () => {
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(() => {
              this.googleChartsReady = true;
              console.log('Google Charts ready');
            });
          };
          document.head.appendChild(script);
        } else {
          google.charts.load('current', {'packages':['corechart']});
          google.charts.setOnLoadCallback(() => {
            this.googleChartsReady = true;
            console.log('Google Charts ready');
          });
        }
      },

      setupTabs() {
        const tabButtons = document.querySelectorAll('.kpi-tab-btn');
        tabButtons.forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Remove active from all buttons
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const tabName = btn.dataset.kpiTab;
            
            // Hide all tab content
            document.querySelectorAll('.kpi-tab-content').forEach(content => {
              content.classList.add('hidden');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`kpi-tab-${tabName}`);
            if (selectedTab) {
              selectedTab.classList.remove('hidden');
            }
          });
        });
      },

      async fetchReportsData() {
        const tableBody = document.getElementById('reportsTableBody');
        if (!tableBody) return;

        tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">Loading reports...</td></tr>`;

        try {
          // Check if AppUtils exists
          if (typeof AppUtils === 'undefined' || typeof AppUtils.fetchData !== 'function') {
            throw new Error('AppUtils.fetchData is not available');
          }

          // Check if AppConfig exists
          if (typeof AppConfig === 'undefined' || !AppConfig.API || !AppConfig.API.REPORTS) {
            throw new Error('AppConfig.API.REPORTS is not defined');
          }

          const data = await AppUtils.fetchData(AppConfig.API.REPORTS);

          if (!Array.isArray(data) || data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No reports available.</td></tr>`;
            return;
          }

          tableBody.innerHTML = '';

          data.forEach(report => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            row.innerHTML = `
              <td class="px-4 py-3">${this.escapeHtml(report.campaign || '—')}</td>
              <td class="px-4 py-3">${this.escapeHtml(report.month)} ${this.escapeHtml(report.year)}</td>
              <td class="px-4 py-3">${this.escapeHtml(report.description || '—')}</td>
              <td class="px-4 py-3">
                ${report.link ? `
                  <a href="${this.escapeHtml(report.link)}" target="_blank" rel="noopener noreferrer" title="Open in Google Drive">
                    <span class="material-symbols-outlined" style="color:#4285F4; font-size:20px;">drive_file_move</span>
                  </a>` : `
                  <span class="material-symbols-outlined" style="color:gray; font-size:20px; opacity:0.4;">drive_file_move</span>`
                }
              </td>
              <td class="px-4 py-3">
                ${report.link ? `
                  <a href="${this.escapeHtml(report.link)}" target="_blank" rel="noopener noreferrer" class="text-brandPrimary hover:underline inline-flex items-center gap-1">
                    <span class="material-symbols-outlined text-base">download</span>
                    Download
                  </a>` : '—'}
              </td>
            `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("Error fetching reports:", error);
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">Error loading reports: ${error.message}</td></tr>`;
        }
      },

      async fetchKPIData() {
        const body = document.getElementById('kpiBody');
        if (!body) return;

        body.innerHTML = '<tr><td colspan="18" class="text-center p-4 text-gray-500">Fetching data...</td></tr>';
        
        try {
          // Check if AppUtils exists
          if (typeof AppUtils === 'undefined' || typeof AppUtils.fetchData !== 'function') {
            throw new Error('AppUtils.fetchData is not available');
          }

          // Check if AppConfig exists
          if (typeof AppConfig === 'undefined' || !AppConfig.API || !AppConfig.API.KPI) {
            throw new Error('AppConfig.API.KPI is not defined');
          }

          const data = await AppUtils.fetchData(AppConfig.API.KPI);
          
          if (!data || typeof data !== 'object') {
            throw new Error('Invalid KPI data format');
          }

          this.rawKPIData = data;
          this.renderKPITable(data);
        } catch (error) {
          console.error("Error fetching KPI data:", error);
          body.innerHTML = `<tr><td colspan="18" class="text-center p-4 text-red-500">Error fetching data: ${error.message}</td></tr>`;
        }
      },

      renderKPITable(data) {
        const body = document.getElementById('kpiBody');
        if (!body) return;

        body.innerHTML = '';
        
        let totalKPIs = 0;
        let passCount = 0;
        let failCount = 0;

        Object.entries(data).forEach(([campaign, kpis]) => {
          if (!Array.isArray(kpis)) return;

          kpis.forEach(kpi => {
            if (!kpi || !kpi.monthly) return;

            totalKPIs++;
            const months = Object.keys(kpi.monthly);
            let monthsPassed = 0;
            let monthsFailed = 0;
            
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50 cursor-pointer';
            
            let html = `
              <td class="px-3 py-2 font-medium sticky left-0 bg-white">${this.escapeHtml(campaign)}</td>
              <td class="px-3 py-2">${this.escapeHtml(kpi.name || '')}</td>
              <td class="px-3 py-2 text-right">${this.formatNum(kpi.target)}</td>
              <td class="px-3 py-2 text-right">${this.formatNum(kpi.threshold)}</td>
            `;
            
            months.forEach(month => {
              const val = kpi.monthly[month];
              const num = parseFloat(val);
              const target = parseFloat(kpi.target);
              
              if (!isNaN(num) && !isNaN(target)) {
                if (num >= target) {
                  monthsPassed++;
                } else {
                  monthsFailed++;
                }
              }
              
              html += `<td class="px-3 py-2 text-right">${this.colorize(val, kpi.target)}</td>`;
            });
            
            html += `
              <td class="px-3 py-2 text-right text-green-600 font-semibold">${monthsPassed}</td>
              <td class="px-3 py-2 text-right text-red-600 font-semibold">${monthsFailed}</td>
            `;
            
            if (monthsPassed > monthsFailed) {
              passCount++;
            } else {
              failCount++;
            }
            
            row.innerHTML = html;
            row.addEventListener('click', () => this.drawChart(kpi));
            body.appendChild(row);
          });
        });

        // Update summary cards
        this.updateCard('cardCampaigns', Object.keys(data).length);
        this.updateCard('cardTotalKPI', totalKPIs);
        this.updateCard('cardPassed', passCount);
        this.updateCard('cardFailed', failCount);
      },

      updateCard(id, value) {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        }
      },

      formatNum(value) {
        const num = parseFloat(value);
        return isNaN(num) ? '—' : num.toFixed(1);
      },

      colorize(value, target) {
        const num = parseFloat(value);
        const tgt = parseFloat(target);
        
        if (isNaN(num) || isNaN(tgt)) {
          return this.escapeHtml(value) || '—';
        }
        
        if (num >= tgt) {
          return `<span class='text-green-600 font-semibold'>${num.toFixed(1)}</span>`;
        } else {
          return `<span class='text-red-600 font-semibold'>${num.toFixed(1)}</span>`;
        }
      },

      drawChart(kpi) {
        if (!this.googleChartsReady) {
          console.warn('Google Charts not ready yet');
          // Retry after a delay
          setTimeout(() => this.drawChart(kpi), 500);
          return;
        }

        if (!kpi || !kpi.monthly) {
          console.warn('No KPI data to display');
          return;
        }

        try {
          const data = new google.visualization.DataTable();
          data.addColumn('string', 'Month');
          data.addColumn('number', kpi.name || 'Value');
          data.addColumn('number', 'Target');
          data.addColumn('number', 'Threshold');

          const months = Object.keys(kpi.monthly);
          const values = Object.values(kpi.monthly).map(x => parseFloat(x) || 0);
          const target = parseFloat(kpi.target) || 0;
          const threshold = parseFloat(kpi.threshold) || 0;

          data.addRows(months.map((month, i) => [month, values[i], target, threshold]));

          const options = {
            height: 400,
            curveType: 'function',
            legend: { position: 'bottom' },
            backgroundColor: 'transparent',
            hAxis: { title: 'Month' },
            vAxis: { title: 'Value', minValue: 0 },
            colors: ['#4285F4', '#34A853', '#FBBC05'],
            series: {
              1: { lineDashStyle: [5, 5] },
              2: { lineDashStyle: [2, 4] }
            }
          };

          const chartDiv = document.getElementById('chart_div');
          if (!chartDiv) {
            console.error('Chart container not found');
            return;
          }

          const chart = new google.visualization.LineChart(chartDiv);
          chart.draw(data, options);
          this.chartDrawn = true;
        } catch (error) {
          console.error('Error drawing chart:', error);
        }
      },

      escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
      }
    };

    // Make init function globally accessible
    window.init_kpi = function() {
      KPIModule.init();
    };

    // Auto-initialize if DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('page-kpi')) {
          window.init_kpi();
        }
      });
    } else {
      if (document.getElementById('page-kpi')) {
        window.init_kpi();
      }
    }
  })();
</script>