<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unified Attendance Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Roboto', 'sans-serif'] },
          colors: {
            'brand-accent': '#CBEB33',
            'bg-dark': '#0f172a',
            'text-dark': '#f1f5f9',
            'card-dark': '#1e293b',
            'border-dark': '#334155',
            'bg-light': '#f8fafc',
            'text-light': '#1e293b',
          }
        }
      }
    }
  </script>

  <style>
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48; }
    @media (min-width: 1280px) { .max-w-9xl { max-width: 1440px; } }

    .table-fixed { table-layout: fixed; }
    .table-fixed th, .table-fixed td { min-width: 1rem; }
    .table-fixed td { height: 1rem; line-height: 1; font-size: 0.75rem; }

    .status-p  { background-color: #38761D; }
    .status-a  { background-color: #EF4444; }
    .status-off{ background-color: #9CA3AF; }
    .status-l  { background-color: #F59E0B; }
    .status-vl { background-color: #0000FF; color: white; }
    .status-t  { background-color: #8E7CC3; }
    .status-sus{ background-color: #00FFFF; }
    .status-hd { background-color: #00FF00; }
    .status-l15{ background-color: #FACC15; }
    .status-l30{ background-color: #FB923C; }
    .status-l45{ background-color: #F97316; }
    .status-l60{ background-color: #EA580C; }
    .status-sl { background-color: #6FA8DC; }

    .sticky-left {
      position: sticky;
      left: 0;
      z-index: 10;
    }

    #global-loader {
      display: none;
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 1rem;
      color: white;
      backdrop-filter: blur(5px);
    }
    #global-loader.show { display: flex; }
    
    .loader {
      width: 64px;
      height: 64px;
      position: relative;
      animation: rotate 1.5s ease-in infinite alternate;
    }
    .loader::before {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      color: #CBEB33;
      background: currentColor;
      width: 64px;
      height: 32px;
      border-radius: 0 0 50px 50px;
    }
    .loader::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 10%;
      background: #FFF;
      width: 8px;
      height: 64px;
      animation: rotate 1.2s linear infinite alternate-reverse;
    }
    @keyframes rotate {
      100% { transform: rotate(360deg) }
    }

    #notesModal {
      display: none;
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    #notesModal.show { display: flex; }
    
    .has-notes {
      cursor: pointer;
      position: relative;
    }
    .has-notes::after {
      content: '';
      position: absolute;
      top: 2px;
      right: 2px;
      width: 4px;
      height: 4px;
      background: #CBEB33;
      border-radius: 50%;
    }
  </style>
</head>

<body class="min-h-screen bg-bg-light dark:bg-bg-dark text-text-light dark:text-text-dark font-sans transition-colors duration-300">

  <div id="global-loader">
    <span class="loader"></span>
    <p class="text-lg font-semibold">Loading Attendance Data...</p>
  </div>

  <!-- Notes Modal -->
  <div id="notesModal" onclick="closeNotesModal()">
    <div class="bg-white dark:bg-card-dark rounded-2xl p-6 max-w-lg w-full mx-4 shadow-2xl border border-gray-200 dark:border-border-dark" onclick="event.stopPropagation()">
      <div class="flex items-start justify-between mb-4">
        <div>
          <h3 class="text-xl font-bold text-gray-900 dark:text-text-dark" id="modalEmployeeName">Employee Name</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-1" id="modalDateInfo">Date Info</p>
        </div>
        <button onclick="closeNotesModal()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-border-dark transition-colors">
          <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">close</span>
        </button>
      </div>
      
      <div class="mb-4">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium" id="modalStatusBadge">
          <span id="modalStatusText">Status</span>
        </div>
      </div>
      
      <div class="bg-gray-50 dark:bg-border-dark rounded-xl p-4">
        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Notes:</h4>
        <p class="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap" id="modalNotes">No notes available</p>
      </div>
    </div>
  </div>

  <header class="flex flex-col md:flex-row items-start md:items-center gap-4 bg-white dark:bg-card-dark p-4 sticky top-0 z-40 border-b border-gray-200 dark:border-border-dark">
    <div class="flex items-center gap-3 w-full md:w-auto pb-2 md:pb-0">
      <img src="https://digitalmindsbpo.com/storage/2018/11/cropped-dm-favicon.png" alt="Logo" class="w-8 h-8 rounded-full object-cover">
      <h1 id="pageTitle" class="text-xl font-extrabold text-gray-900 dark:text-text-dark">Call Center Attendance</h1>

      <button id="themeToggle" aria-label="Toggle theme" class="md:hidden ml-auto p-2 rounded-full bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition-all">
        <span id="themeIcon" class="material-symbols-outlined">light_mode</span>
      </button>
    </div>

    <div class="hidden md:flex items-center gap-4 ml-auto">
      <button id="themeToggleDesktop" aria-label="Toggle theme" class="p-2 rounded-full bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition-all">
        <span id="themeIconDesktop" class="material-symbols-outlined text-gray-700 dark:text-gray-200">light_mode</span>
      </button>
    </div>
  </header>

  <main class="max-w-9xl mx-auto px-4 md:px-6 py-6">

    <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
      <div class="flex items-center gap-3 flex-wrap">
        <div class="relative">
          <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-base">calendar_month</span>
          <select id="monthSelector" class="pl-10 pr-4 py-2 rounded-xl border border-gray-200 dark:border-border-dark bg-white dark:bg-card-dark dark:text-text-dark text-sm focus:ring-2 focus:ring-brand-accent">
            <option value="" disabled selected>Select Month</option>
            <option value="1">January</option><option value="2">February</option><option value="3">March</option>
            <option value="4">April</option><option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option><option value="9">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
        </div>

        <div class="relative">
          <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-base">groups</span>
          <select id="rosterSelector" class="pl-10 pr-4 py-2 rounded-xl border border-gray-200 dark:border-border-dark bg-white dark:bg-card-dark dark:text-text-dark text-sm focus:ring-2 focus:ring-brand-accent">
            <option value=""></option>
          </select>
        </div>

        <button id="refreshBtn" class="px-4 py-2 rounded-xl text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700">Refresh</button>
      </div>

      <div id="attendanceLoadingSpinner" class="hidden flex items-center gap-2 text-brand-accent font-semibold">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        Loading Data...
      </div>
    </div>

    <div id="kpi-cards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8"></div>

    <div class="grid grid-cols-1 lg:grid-cols-6 gap-6 mb-8">
      <section class="lg:col-span-4 bg-white dark:bg-card-dark rounded-2xl p-6 border border-gray-200 dark:border-border-dark shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-gray-800 dark:text-text-dark">Campaign Summary</h3>
          <div id="status-indicator" class="flex items-center gap-2 text-sm">
            <span class="relative flex h-3 w-3">
              <span id="status-ping" class="hidden animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span id="status-dot" class="relative inline-flex rounded-full h-3 w-3 bg-gray-400"></span>
            </span>
            <span id="status-text" class="font-medium text-gray-500 dark:text-gray-400">Idle</span>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 dark:bg-border-dark">
              <tr class="text-xs text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                <th class="px-4 py-3 text-left">Campaign / Team</th>
                <th class="px-4 py-3 text-center">Present</th>
                <th class="px-4 py-3 text-center">Late</th>
                <th class="px-4 py-3 text-center">Half Day</th>
                <th class="px-4 py-3 text-center">Absent</th>
                <th class="px-4 py-3 text-center">Score</th>
              </tr>
            </thead>
            <tbody id="campaign-summary-body" class="divide-y divide-gray-100 dark:divide-border-dark"></tbody>
          </table>
        </div>
      </section>

      <aside class="lg:col-span-2 bg-white dark:bg-card-dark rounded-2xl p-6 border border-gray-200 dark:border-border-dark shadow-sm">
        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-text-dark">Legend</h3>
        <div class="grid grid-cols-2 gap-3 text-sm text-gray-700 dark:text-gray-300">
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#38761D] rounded-sm"></span><span>P – Present</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#EF4444] rounded-sm"></span><span>A – Absent</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#9CA3AF] rounded-sm"></span><span>Off – Day Off</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#F59E0B] rounded-sm"></span><span>L – Late</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#0000FF] rounded-sm"></span><span>VL – Vacation Leave</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#6FA8DC] rounded-sm"></span><span>SL – Sick Leave</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#8E7CC3] rounded-sm"></span><span>T – Training</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#00FFFF] rounded-sm"></span><span>SUS – Suspension</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#00FF00] rounded-sm"></span><span>HD – Half Day</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#FACC15] rounded-sm"></span><span>L15 – Late 15min</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#FB923C] rounded-sm"></span><span>L30 – Late 30min</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#F97316] rounded-sm"></span><span>L45 – Late 45min</span></div>
          <div class="flex items-center gap-2"><span class="h-3 w-3 block bg-[#EA580C] rounded-sm"></span><span>L60 – Late 60min</span></div>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-border-dark">
          <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
            <span class="h-3 w-3 block bg-brand-accent rounded-full"></span>
            <span>Yellow dot = Has notes (click to view)</span>
          </div>
        </div>
      </aside>
    </div>

    <section>
      <h2 class="text-2xl font-bold mb-4">Employee Calendar View</h2>
      <div id="campaign-feed" class="space-y-6">
        <p class="text-center py-12 text-gray-500 dark:text-gray-400">Select a Month and Roster then click Refresh to load calendars.</p>
      </div>
    </section>

    <footer class="py-6 text-center text-sm text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-border-dark mt-12">
      &copy; 2025 Digital Minds BPO. All rights reserved.
    </footer>
  </main>

  <script>
    const BASE_URL = "https://script.google.com/macros/s/AKfycbz9NfHBUhRkI5BCYPsJjV05qBYETJImPOjuXUZQf9hY2VWF2ZuQ9tmafvDjdMgVnLWE/exec";

    const statusColors = {
      P: "status-p", A: "status-a", Off: "status-off",
      L: "status-l", VL: "status-vl", T: "status-t",
      SUS: "status-sus", HD: "status-hd",
      L15: "status-l15", L30: "status-l30", L45: "status-l45", L60: "status-l60",
      SL: "status-sl", NA: ""
    };

    const statusLabels = {
      P: "Present", A: "Absent", Off: "Day Off",
      L: "Late", VL: "Vacation Leave", T: "Training",
      SUS: "Suspension", HD: "Half Day",
      L15: "Late 15min", L30: "Late 30min", L45: "Late 45min", L60: "Late 60min",
      SL: "Sick Leave"
    };

    const statusBadgeColors = {
      P: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400",
      A: "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",
      Off: "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300",
      L: "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400",
      VL: "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400",
      T: "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400",
      SUS: "bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-400",
      HD: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400",
      L15: "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400",
      L30: "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400",
      L45: "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400",
      L60: "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",
      SL: "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400"
    };

    const monthNames = ["", "January", "February", "March", "April", "May", "June", 
                        "July", "August", "September", "October", "November", "December"];

    let notesData = {};
    let _loadingCount = 0;

    function showLoading() {
      _loadingCount++;
      const el = document.getElementById("global-loader");
      if (el) el.classList.add('show');
    }
    
    function hideLoading() {
      _loadingCount = Math.max(0, _loadingCount - 1);
      if (_loadingCount === 0) {
        const el = document.getElementById("global-loader");
        if (el) el.classList.remove('show');
      }
    }

    async function fetchJson(url) {
      const resp = await fetch(url, {cache: "no-store"});
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.json();
    }

    async function loadClusters() {
      showLoading();
      try {
        const res = await fetchJson(BASE_URL + "?api=clusters");
        const select = document.getElementById("rosterSelector");
        select.innerHTML = `<option value=""></option>`;
        if (Array.isArray(res)) {
          res.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c; opt.textContent = c;
            select.appendChild(opt);
          });
        }
      } catch (err) {
        console.error("loadClusters error:", err);
      } finally {
        hideLoading();
      }
    }

    async function loadAll() {
      const month = document.getElementById("monthSelector").value || "";
      const cluster = document.getElementById("rosterSelector").value || "";

      showLoading();
      setStatus("Loading...");

      try {
        const summaryParams = new URLSearchParams({ api: "summary", month, cluster });
        const summary = await fetchJson(BASE_URL + "?" + summaryParams.toString());
        renderKPIs(summary);
        renderCampaignSummary(summary);

        const calParams = new URLSearchParams({ api: "calendars", month, cluster });
        const calendars = await fetchJson(BASE_URL + "?" + calParams.toString());
        
        // Try to fetch notes, but don't fail if endpoint doesn't exist
        try {
          const notesParams = new URLSearchParams({ api: "notes", month, cluster });
          const notes = await fetchJson(BASE_URL + "?" + notesParams.toString());
          notesData = notes || {};
          console.log("Notes loaded:", Object.keys(notesData).length, "entries");
        } catch (notesErr) {
          console.warn("Notes API not available or failed:", notesErr);
          notesData = {};
        }
        
        renderCalendars(calendars);

        setStatus("Loaded");
      } catch (err) {
        console.error("loadAll error:", err);
        setStatus("Error loading data");
        const feed = document.getElementById("campaign-feed");
        if (feed) feed.innerHTML = `<p class="text-center py-8 text-red-500">Failed to load attendance data.</p>`;
      } finally {
        hideLoading();
      }
    }

    function renderKPIs(summary) {
        const s = summary && summary.overall ? summary.overall : {};
        const present = s.P || 0;
        const absent = s.A || 0;
        const late = (s.L || 0) + (s.L15 || 0) + (s.L30 || 0) + (s.L45 || 0) + (s.L60 || 0);
        const planned = (s.VL || 0) + (s.SL || 0) + (s.T || 0) + (s.SUS || 0);
        const totalForScore = present + absent + (s.HD || 0) + late;
        const numericScore = totalForScore > 0 ? (present / totalForScore) * 100 : 0;
        const score = numericScore.toFixed(1) + "%";

        let scoreColorClass = "text-gray-900 dark:text-brand-accent";
        if (numericScore < 95) {
            scoreColorClass = "text-red-600 dark:text-red-500";
        }

        const cards = [
            { label: "Present", value: present, colorClass: "text-green-600" },
            { label: "Absent", value: absent, colorClass: "text-red-600" },
            { label: "Tardiness", value: late, colorClass: "text-yellow-600" },
            { label: "Planned Leave", value: planned, colorClass: "text-blue-600" },
            { label: "Attendance Score", value: score, colorClass: scoreColorClass }
        ];

        const container = document.getElementById("kpi-cards");
        container.innerHTML = cards.map(card => `
            <div class="bg-white dark:bg-card-dark rounded-2xl p-6 border border-gray-200 dark:border-border-dark shadow-sm">
                <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">${card.label}</h2>
                <p class="text-3xl font-extrabold mt-4 ${card.colorClass}">${card.value}</p>
            </div>
        `).join("");
    }

    function renderCampaignSummary(summary) {
      const tbody = document.getElementById("campaign-summary-body");
      tbody.innerHTML = "";
      const campaigns = summary && summary.campaigns ? summary.campaigns : {};
      const entries = Object.entries(campaigns).map(([name, stats]) => {
        const totalLate = (stats.L || 0) + (stats.L15 || 0) + (stats.L30 || 0) + (stats.L45 || 0) + (stats.L60 || 0);
        const totalScheduled = (stats.P || 0) + totalLate + (stats.HD || 0) + (stats.A || 0);
        const numericScore = totalScheduled > 0 ? (stats.P / totalScheduled) * 100 : 0;
        return { name, stats, numericScore, totalLate, totalScheduled };
      });

      entries.sort((a, b) => a.numericScore - b.numericScore);

      entries.forEach(entry => {
        const s = entry.stats;
        let scoreClass = 'text-gray-900 dark:text-brand-accent';
        if (entry.numericScore < 95) {
          scoreClass = 'text-red-600 dark:text-red-500';
        }
        const scText = entry.numericScore.toFixed(1) + "%";
        const row = `
          <tr class="hover:bg-gray-50 dark:hover:bg-border-dark/50 transition-colors">
            <td class="px-4 py-3 font-medium text-gray-800 dark:text-text-dark">${entry.name}</td>
            <td class="px-4 py-3 text-center text-green-600 dark:text-green-400">${s.P || 0}</td>
            <td class="px-4 py-3 text-center text-yellow-600 dark:text-yellow-400">${entry.totalLate}</td>
            <td class="px-4 py-3 text-center text-blue-600 dark:text-blue-400">${s.HD || 0}</td>
            <td class="px-4 py-3 text-center text-red-600 dark:text-red-400">${s.A || 0}</td>
            <td class="px-4 py-3 text-center font-bold ${scoreClass}">${scText}</td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    function renderCalendars(data) {
        const feed = document.getElementById("campaign-feed");
        feed.innerHTML = "";
        if (!data || Object.keys(data).length === 0) {
            feed.innerHTML = '<p class="text-center py-12 text-red-500 dark:text-red-400">No attendance data found for the selected filter(s).</p>';
            return;
        }

        const selectedMonth = document.getElementById("monthSelector").value;
        const currentYear = new Date().getFullYear();

        Object.entries(data).forEach(([campaign, employees]) => {
            const dayLengths = Object.values(employees).map(arr => Array.isArray(arr) ? arr.length : 0);
            const maxDays = dayLengths.length ? Math.max(...dayLengths) : 0;
            const daysCount = Math.min(Math.max(maxDays, 1), 31);

            let campaignP = 0, campaignA = 0, campaignHD = 0, campaignLate = 0;
            Object.values(employees || {}).forEach(arr => {
                if (!Array.isArray(arr)) return;
                arr.forEach(s => {
                    if (!s || s === 'NA' || s === 'Off') return;
                    if (s === 'P') campaignP++;
                    else if (s === 'A') campaignA++;
                    else if (s === 'HD') campaignHD++;
                    else if (/^L/.test(s)) campaignLate++;
                });
            });

            const totalForCampaignScore = campaignP + campaignA + campaignHD + campaignLate;
            const scoreNum = totalForCampaignScore > 0 ? (campaignP / totalForCampaignScore) * 100 : 0;
            const scoreText = scoreNum.toFixed(1) + "%";
            const scoreClass = scoreNum < 95 ? 'text-red-600 dark:text-red-400 font-bold' : 'text-gray-900 dark:text-text-dark font-bold';

            let html = `
              <div class="bg-white dark:bg-card-dark border border-gray-100 dark:border-border-dark rounded-2xl shadow-sm p-4">
                <div class="p-2 pb-4 border-b border-gray-100 dark:border-border-dark flex justify-between items-center">
                  <h3 class="text-lg font-semibold text-gray-700 dark:text-text-dark">${campaign}</h3>
                  <div class="text-sm ${scoreClass}">${scoreText}</div>
                </div>

                <div class="mt-4 overflow-x-auto">
                  <table class="table-fixed border-collapse w-full text-xs">
                    <thead class="bg-gray-100 dark:bg-border-dark sticky top-0">
                      <tr class="text-gray-600 dark:text-gray-300">
                        <th class="px-2 py-1 text-left w-40 sticky-left bg-gray-100 dark:bg-border-dark text-gray-600 dark:text-gray-300">Employee</th>`;

            for (let d = 1; d <= daysCount; d++) html += `<th class='px-1 py-1 w-6 text-center'>${d}</th>`;

            html += `</tr></thead><tbody>`;

            Object.entries(employees).forEach(([name, statuses]) => {
                html += `<tr class="hover:bg-gray-50 dark:hover:bg-border-dark/50 transition-colors"><td class="sticky-left bg-white dark:bg-card-dark px-2 py-1 font-medium text-gray-700 dark:text-gray-300">${name}</td>`;
                for (let i = 0; i < daysCount; i++) {
                    const dayNum = i + 1;
                    const s = (Array.isArray(statuses) && typeof statuses[i] !== 'undefined') ? statuses[i] : '';
                    const noteKey = `${name}|${selectedMonth}/${dayNum}/${currentYear}`;
                    const hasNote = notesData[noteKey] && notesData[noteKey].trim() !== '';
                    
                    if (!s || s === '') {
                        html += `<td class="border w-6 h-6 dark:border-border-dark"></td>`;
                    } else if (s === 'NA') {
                        html += `<td class="border w-6 h-6 dark:border-border-dark" style="background:repeating-linear-gradient(45deg,#E5E7EB 0px,#E5E7EB 2px,#D1D5DB 2px,#D1D5DB 4px);"></td>`;
                    } else {
                        const c = statusColors[s] || '';
                        const noteClass = hasNote ? 'has-notes' : '';
                        const dataAttrs = hasNote ? `data-employee="${name}" data-date="${selectedMonth}/${dayNum}/${currentYear}" data-status="${s}" data-campaign="${campaign}"` : '';
                        html += `<td class="border w-6 h-6 dark:border-border-dark ${c} ${noteClass}" ${dataAttrs} title="${s}"></td>`;
                    }
                }
                html += `</tr>`;
            });

            html += `</tbody></table></div></div>`;
            feed.insertAdjacentHTML("beforeend", html);
        });

        // Add click handlers for cells with notes
        document.querySelectorAll('.has-notes').forEach(cell => {
            cell.addEventListener('click', function(e) {
                e.stopPropagation();
                const employee = this.dataset.employee;
                const date = this.dataset.date;
                const status = this.dataset.status;
                const campaign = this.dataset.campaign;
                const noteKey = `${employee}|${date}`;
                const note = notesData[noteKey] || 'No notes available';
                
                console.log("Cell clicked:", { employee, date, status, campaign, noteKey, note });
                showNotesModal(employee, date, status, note, campaign);
            });
        });
    }

    function showNotesModal(employee, date, status, notes, campaign) {
        document.getElementById('modalEmployeeName').textContent = employee;
        document.getElementById('modalDateInfo').textContent = `${campaign} • ${date}`;
        document.getElementById('modalStatusText').textContent = statusLabels[status] || status;
        document.getElementById('modalNotes').textContent = notes;
        
        const badge = document.getElementById('modalStatusBadge');
        badge.className = `inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium ${statusBadgeColors[status] || 'bg-gray-100 text-gray-800'}`;
        
        document.getElementById('notesModal').classList.add('show');
    }

    function closeNotesModal() {
        document.getElementById('notesModal').classList.remove('show');
    }

    function setStatus(text) {
      const el = document.getElementById("status-text");
      if (el) el.textContent = text;
      const ping = document.getElementById("status-ping");
      const dot  = document.getElementById("status-dot");
      if (text === "Loaded") { 
        if (ping) ping.classList.remove("hidden"); 
        if (dot) { dot.classList.remove("bg-gray-400"); dot.classList.add("bg-green-400"); }
      } else { 
        if (ping) ping.classList.add("hidden"); 
        if (dot) { dot.classList.remove("bg-green-400"); dot.classList.add("bg-gray-400"); }
      }
    }

    const themeToggle = () => {
      const isDark = document.body.classList.toggle("dark");
      updateThemeIcon(isDark);
      localStorage.setItem("theme", isDark ? "dark" : "light");
    };

    function updateThemeIcon(isDark) {
      const iconName = isDark ? "dark_mode" : "light_mode";
      const mobile = document.getElementById("themeIcon");
      const desk = document.getElementById("themeIconDesktop");
      if (mobile) mobile.textContent = iconName;
      if (desk) desk.textContent = iconName;
    }

    document.getElementById("refreshBtn").addEventListener("click", loadAll);
    const themeBtn = document.getElementById("themeToggle");
    const themeBtnDesktop = document.getElementById("themeToggleDesktop");
    if (themeBtn) themeBtn.addEventListener("click", themeToggle);
    if (themeBtnDesktop) themeBtnDesktop.addEventListener("click", themeToggle);

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeNotesModal();
    });

    (function initTheme() {
      const saved = localStorage.getItem("theme");
      if (saved === "light") { 
        document.body.classList.remove("dark"); 
        updateThemeIcon(false); 
      } else { 
        document.body.classList.add("dark"); 
        updateThemeIcon(true); 
      }
    })();

    window.addEventListener("load", async () => {
      if (typeof feather !== 'undefined') feather.replace();
      const msel = document.getElementById("monthSelector");
      if (msel && !msel.value) {
        const now = new Date();
        msel.value = (now.getMonth() + 1).toString();
      }

      await loadClusters();
      document.getElementById("rosterSelector").value = "Admin";
      await loadAll();
    });
  </script>
</body>
</html>