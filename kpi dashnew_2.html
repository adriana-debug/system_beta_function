<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KPI Dashboard - Digital Minds</title>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
        <span class="material-symbols-outlined text-google-blue">insights</span>
        KPI Dashboard
      </h1>
      <button id="refreshBtn"
        class="flex items-center gap-2 px-3 py-2 bg-google-blue text-white text-sm rounded-lg shadow hover:bg-blue-700 transition">
        <span class="material-symbols-outlined text-sm">refresh</span> Refresh
      </button>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div
        class="bg-white dark:bg-gray-800 shadow rounded-xl p-6 flex flex-col border-t-4 border-blue-500 transition">
        <span class="material-symbols-outlined text-blue-500 text-3xl mb-2">groups</span>
        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">Total Headcount</p>
        <p id="totalHeadcount" class="text-3xl font-bold mt-1">0</p>
      </div>

      <div
        class="bg-white dark:bg-gray-800 shadow rounded-xl p-6 flex flex-col border-t-4 border-green-500 transition">
        <span class="material-symbols-outlined text-green-500 text-3xl mb-2">checklist</span>
        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">No. of KPIs</p>
        <p id="totalKPIs" class="text-3xl font-bold mt-1">0</p>
      </div>

      <div
        class="bg-white dark:bg-gray-800 shadow rounded-xl p-6 flex flex-col border-t-4 border-yellow-500 transition">
        <span class="material-symbols-outlined text-yellow-500 text-3xl mb-2">verified</span>
        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">Passed KPIs</p>
        <p id="passedKPIs" class="text-3xl font-bold mt-1">0</p>
      </div>

      <div
        class="bg-white dark:bg-gray-800 shadow rounded-xl p-6 flex flex-col border-t-4 border-red-500 transition">
        <span class="material-symbols-outlined text-red-500 text-3xl mb-2">cancel</span>
        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase">Failed KPIs</p>
        <p id="failedKPIs" class="text-3xl font-bold mt-1">0</p>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="flex flex-wrap items-center justify-between gap-3 mb-4 bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
      <div class="flex flex-wrap gap-3 items-center">
        <select id="monthFilter" class="p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 text-sm"></select>
        <select id="clusterFilter" class="p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 text-sm"></select>
        <select id="campaignFilter" class="p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 text-sm"></select>
        <button onclick="applyFilters()" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
          Apply Filters
        </button>
      </div>

      <div class="flex items-center gap-2">
        <div class="relative">
          <span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-sm">search</span>
          <input id="searchInput" type="text" placeholder="Search campaign..."
            class="pl-8 pr-3 py-2 text-sm border rounded-lg bg-gray-50 dark:bg-gray-700 w-40 sm:w-56 focus:ring-2 focus:ring-blue-400 outline-none" />
        </div>

        <button id="sortPassed" title="Highest Passed KPIs"
          class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition">
          <span class="material-symbols-outlined text-green-500">trending_up</span>
        </button>
        <button id="sortFailed" title="Highest Failed KPIs"
          class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition">
          <span class="material-symbols-outlined text-red-500">trending_down</span>
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl overflow-hidden transition">
      <h3 class="text-lg font-semibold p-4 border-b text-gray-700 dark:text-gray-300 dark:border-gray-700">
        Campaign Performance Snapshot
      </h3>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left">
          <thead class="bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 uppercase text-xs border-b">
            <tr>
              <th class="px-6 py-3 font-medium">Campaign</th>
              <th class="px-6 py-3 font-medium">Cluster</th>
              <th class="px-6 py-3 font-medium">Supervisor</th>
              <th class="px-6 py-3 font-medium">KPI</th>
              <th class="px-6 py-3 font-medium">Value</th>
              <th class="px-6 py-3 font-medium">Month</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxfGTghnULUQotHTHD_UqxL5F_ht_GLHeLkTFJNeNaaohcLKuzMinSYSHzwAb-i99km/exec"; // ðŸ”¹ Replace with your Apps Script Web App URL
  let allData = [];

  document.addEventListener("DOMContentLoaded", async () => {
    await loadDashboardData();
    document.getElementById("refreshBtn").addEventListener("click", loadDashboardData);
    document.getElementById("sortPassed").addEventListener("click", () => sortTable("Passed"));
    document.getElementById("sortFailed").addEventListener("click", () => sortTable("Failed"));
    document.getElementById("searchInput").addEventListener("input", searchCampaign);
  });

  async function loadDashboardData() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      allData = data;
      populateFilters(data);
      renderTable(data);
      updateSummary(data);
    } catch (err) {
      console.error("Error loading data:", err);
    }
  }

  function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition";
      tr.innerHTML = `
        <td class="px-6 py-3 font-semibold">${row.Campaign}</td>
        <td class="px-6 py-3">${row.Cluster || "-"}</td>
        <td class="px-6 py-3">${row.Supervisor || "-"}</td>
        <td class="px-6 py-3">${row.KPI || "-"}</td>
        <td class="px-6 py-3">${row.Value || "-"}</td>
        <td class="px-6 py-3">${row.Month || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function populateFilters(data) {
    const months = [...new Set(data.map(d => d.Month))];
    const clusters = [...new Set(data.map(d => d.Cluster))];
    const campaigns = [...new Set(data.map(d => d.Campaign))];

    const monthSel = document.getElementById("monthFilter");
    const clusterSel = document.getElementById("clusterFilter");
    const campaignSel = document.getElementById("campaignFilter");

    [monthSel, clusterSel, campaignSel].forEach(sel => (sel.innerHTML = "<option value=''>All</option>"));
    months.forEach(m => (monthSel.innerHTML += `<option value="${m}">${m}</option>`));
    clusters.forEach(c => (clusterSel.innerHTML += `<option value="${c}">${c}</option>`));
    campaigns.forEach(c => (campaignSel.innerHTML += `<option value="${c}">${c}</option>`));
  }

  async function applyFilters() {
    const month = document.getElementById("monthFilter").value;
    const cluster = document.getElementById("clusterFilter").value;
    const campaign = document.getElementById("campaignFilter").value;

    let url = new URL(API_URL);
    if (month) url.searchParams.append("month", month);
    if (cluster) url.searchParams.append("cluster", cluster);
    if (campaign) url.searchParams.append("campaign", campaign);

    const res = await fetch(url);
    const filtered = await res.json();
    renderTable(filtered);
    updateSummary(filtered);
  }

  function updateSummary(data) {
    const totalHeadcount = new Set(data.map(d => d.Supervisor)).size;
    const totalKPIs = data.length;
    const passed = data.filter(d => Number(d.Value) >= 90).length;
    const failed = data.filter(d => Number(d.Value) < 90).length;

    document.getElementById("totalHeadcount").innerText = totalHeadcount;
    document.getElementById("totalKPIs").innerText = totalKPIs;
    document.getElementById("passedKPIs").innerText = passed;
    document.getElementById("failedKPIs").innerText = failed;
  }

  function searchCampaign() {
    const query = document.getElementById("searchInput").value.toLowerCase();
    const filtered = allData.filter(d => d.Campaign.toLowerCase().includes(query));
    renderTable(filtered);
  }

  function sortTable(type) {
    const sorted = [...allData].sort((a, b) => {
      const aVal = Number(a.Value);
      const bVal = Number(b.Value);
      return type === "Passed" ? bVal - aVal : aVal - bVal;
    });
    renderTable(sorted);
  }
  </script>
</body>
</html>
