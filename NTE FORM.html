
function emailIncidentReportPDF() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Incident_Logs");
  if (!sheet) throw new Error("Incident_Logs sheet not found.");

  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();

  const folder = DriveApp.getFoldersByName("incident_reports").hasNext()
    ? DriveApp.getFoldersByName("incident_reports").next()
    : DriveApp.createFolder("incident_reports");

  for (let row = 2; row <= values.length; row++) {
    const data = values[row - 1];
    if (data.length < 9) continue;

    const [
      employeeNumber, employeeNameRaw, dateIssued, department,
      supervisor, dateOfIncident, placeOfIncident, narration,
      printAction
    ] = data;

    if (printAction.toString().trim().toUpperCase() !== "PRINT") {
      sheet.getRange(row, 10).setValue("Skipped: DONT PRINT");
      continue;
    }

    // Format
    const employeeName = employeeNameRaw?.toString().replace(/[^\w\s\-]/g, '') || 'Unknown';
    const issuedDate = new Date(dateIssued);

    // --- Reference Code (IR) ---
    const yy = issuedDate.getFullYear().toString().slice(-2);
    const mm = String(issuedDate.getMonth() + 1).padStart(2, "0");
    const generatedCode = `DMI-IR-NETCAP-${yy}-${mm}-0003`;

    let finalReferenceId = (typeof data[10] !== "undefined" && data[10].toString().trim() !== "")
      ? data[10]
      : generatedCode;

    // --- Unified Styling like NTE ---
    const htmlContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    @page {
      size: 8.5in 14in;
      margin: 1in 0.5in 0.5in 0.5in;
    }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      font-size: 11px;
      color: #222;
      margin: 0;
    }
    .document { padding: 60px 20px 20px 20px; }
    h1 {
      text-align: center;
      font-size: 18px;
      text-transform: uppercase;
      margin-bottom: 8px;
      color: #222;
      border-bottom: 2px solid #444;
      padding-bottom: 6px;
      letter-spacing: 1px;
    }
    .reference {
      text-align: center;
      margin: 10px 0 20px 0;
      font-size: 12px;
    }
    .reference strong { color: #333; }
    .reference span { color: #b30000; font-weight: bold; }
    .details {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 18px;
      font-size: 10px;
      table-layout: fixed;
    }
    .details td {
      padding: 6px 8px;
      border: 1px solid #bbb;
      vertical-align: top;
      word-wrap: break-word;
    }
    .details .label {
      font-weight: bold;
      background: #f5f5f5;
      width: 25%;
    }
    .section-title {
      font-weight: bold;
      font-size: 12px;
      margin: 20px 0 8px 0;
      text-transform: uppercase;
      color: #333;
      border-left: 3px solid #444;
      padding-left: 6px;
    }
    .content-box {
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 80px;
      background: #fcfcfc;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .ack-table {
      width: 100%;
      margin-top: 35px;
      table-layout: fixed;
      border-collapse: collapse;
    }
    .ack-table td {
      text-align: center;
      vertical-align: bottom;
      padding: 35px 20px 10px 20px;
      font-size: 11px;
      width: 50%;
    }
    .ack-table .name-line {
      border-top: 1px solid #000;
      padding-top: 4px;
      font-weight: bold;
    }
    .ack-table .title-line {
      font-size: 10px;
      color: #555;
    }
    footer {
      border-top: 1px solid #bbb;
      margin-top: 30px;
      padding-top: 8px;
      font-size: 9px;
      display: flex;
      justify-content: space-between;
      color: #444;
    }
  </style>
</head>
<body>
  <div class="document">

    <h1>Incident Report</h1>

    <div class="reference">
      <strong>IR Reference Code:</strong> <span>${finalReferenceId}</span>
    </div>

    <table class="details">
      <tr>
        <td class="label">Employee Name:</td><td>${employeeName}</td>
        <td class="label">Employee No.:</td><td>${employeeNumber || ''}</td>
      </tr>
      <tr>
        <td class="label">Date Issued:</td><td>${issuedDate.toLocaleDateString('en-US')}</td>
        <td class="label">Supervisor:</td><td>${supervisor || ''}</td>
      </tr>
      <tr>
        <td class="label">Position / Department:</td><td colspan="3">${department || ''}</td>
      </tr>
      <tr>
        <td class="label">Date of Incident:</td><td>${dateOfIncident || ''}</td>
        <td class="label">Place of Incident:</td><td>${placeOfIncident || ''}</td>
      </tr>
    </table>

    <div class="section-title">Narration of Incident</div>
    <div class="content-box">${narration || ''}</div>

    <div class="section-title">Acknowledgment</div>
    <p>I acknowledge that I have read and understood the contents of this Incident Report.</p>

    <table class="ack-table">
      <tr>
        <td>
          <div class="name-line">${employeeName}</div>
          <div class="title-line">${department}</div>
        </td>
        <td>
          <div class="name-line">${supervisor}</div>
          <div class="title-line">Supervisor</div>
        </td>
      </tr>
    </table>

    <footer>
      <div><strong>IR Code:</strong> <span style="color:#b30000;font-weight:bold;">${finalReferenceId}</span></div>
      <div>Digital Minds BPO Services Inc. | Confidential</div>
    </footer>
  </div>
</body>
</html>`;

    // Convert to PDF & Save
    const blob = Utilities.newBlob(htmlContent, 'text/html').getAs('application/pdf');
    const fileName = `IncidentReport_${employeeName}_${issuedDate.toLocaleString('en-US', { month: 'long' })}_${issuedDate.getFullYear()}.pdf`;
    blob.setName(fileName);

    const savedFile = folder.createFile(blob);
    sheet.getRange(row, 10).setValue(`Saved: ${savedFile.getName()}`);
    sheet.getRange(row, 11).setValue(finalReferenceId);
  }
}



function emailNTEPDF() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("NTE_Logs");
  if (!sheet) throw new Error("NTE_Logs sheet not found.");

  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();

  const folder = DriveApp.getFoldersByName("nte_reports").hasNext()
    ? DriveApp.getFoldersByName("nte_reports").next()
    : DriveApp.createFolder("nte_reports");

  for (let row = 2; row <= values.length; row++) {
    const data = values[row - 1];
    if (data.length < 9) continue;

    const [
      employeeNumber, employeeNameRaw, dateIssued, department,
      supervisor, subject, explanation, consequence,
      printAction
    ] = data;

    if (printAction.toString().trim().toUpperCase() !== "PRINT") {
      sheet.getRange(row, 10).setValue("Skipped: DONT PRINT");
      continue;
    }

    // Format
    const employeeName = employeeNameRaw?.toString().replace(/[^\w\s\-]/g, '') || 'Unknown';
    const issuedDate = new Date(dateIssued);

    // --- Reference Code (NTE) ---
    const yy = issuedDate.getFullYear().toString().slice(-2);
    const mm = String(issuedDate.getMonth() + 1).padStart(2, "0");
    const generatedCode = `DMI-NTE-NETCAP-${yy}-${mm}-0003`;

    let finalReferenceId = (typeof data[10] !== "undefined" && data[10].toString().trim() !== "")
      ? data[10]
      : generatedCode;

    // --- Document Styling (similar to IR) ---
    const htmlContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    @page {
      size: 8.5in 14in;
      margin: 1in 0.5in 0.5in 0.5in;
    }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      font-size: 11px;
      color: #222;
      margin: 0;
    }
    .document { padding: 60px 20px 20px 20px; }
    h1 {
      text-align: center;
      font-size: 18px;
      text-transform: uppercase;
      margin-bottom: 8px;
      color: #222;
      border-bottom: 2px solid #444;
      padding-bottom: 6px;
      letter-spacing: 1px;
    }
    .reference {
      text-align: center;
      margin: 10px 0 20px 0;
      font-size: 12px;
    }
    .reference strong { color: #333; }
    .reference span { color: #b30000; font-weight: bold; }
    .details {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 18px;
      font-size: 10px;
      table-layout: fixed;
    }
    .details td {
      padding: 6px 8px;
      border: 1px solid #bbb;
      vertical-align: top;
      word-wrap: break-word;
    }
    .details .label {
      font-weight: bold;
      background: #f5f5f5;
      width: 25%;
    }
    .section-title {
      font-weight: bold;
      font-size: 12px;
      margin: 20px 0 8px 0;
      text-transform: uppercase;
      color: #333;
      border-left: 3px solid #444;
      padding-left: 6px;
    }
    .content-box {
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 80px;
      background: #fcfcfc;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .ack-table {
      width: 100%;
      margin-top: 35px;
      table-layout: fixed;
      border-collapse: collapse;
    }
    .ack-table td {
      text-align: center;
      vertical-align: bottom;
      padding: 35px 20px 10px 20px;
      font-size: 11px;
      width: 50%;
    }
    .ack-table .name-line {
      border-top: 1px solid #000;
      padding-top: 4px;
      font-weight: bold;
    }
    .ack-table .title-line {
      font-size: 10px;
      color: #555;
    }
    footer {
      border-top: 1px solid #bbb;
      margin-top: 30px;
      padding-top: 8px;
      font-size: 9px;
      display: flex;
      justify-content: space-between;
      color: #444;
    }
  </style>
</head>
<body>
  <div class="document">

    <h1>Notice to Explain</h1>

    <div class="reference">
      <strong>NTE Reference Code:</strong> <span>${finalReferenceId}</span>
    </div>

    <table class="details">
      <tr>
        <td class="label">Employee Name:</td><td>${employeeName}</td>
        <td class="label">Employee No.:</td><td>${employeeNumber || ''}</td>
      </tr>
      <tr>
        <td class="label">Date Issued:</td><td>${issuedDate.toLocaleDateString('en-US')}</td>
        <td class="label">Supervisor:</td><td>${supervisor || ''}</td>
      </tr>
      <tr>
        <td class="label">Position / Department:</td><td colspan="3">${department || ''}</td>
      </tr>
      <tr>
        <td class="label">Subject:</td><td colspan="3">${subject || ''}</td>
      </tr>
    </table>

    <div class="section-title">Details / Explanation</div>
    <div class="content-box">${explanation || ''}</div>

    <div class="section-title">Possible Consequence</div>
    <div class="content-box">${consequence || ''}</div>

    <div class="section-title">Acknowledgment</div>
    <p>I acknowledge that I have read and understood the contents of this Notice to Explain.</p>

    <table class="ack-table">
      <tr>
        <td>
          <div class="name-line">${employeeName}</div>
          <div class="title-line">${department}</div>
        </td>
        <td>
          <div class="name-line">${supervisor}</div>
          <div class="title-line">Supervisor</div>
        </td>
      </tr>
    </table>

    <footer>
      <div><strong>NTE Code:</strong> <span style="color:#b30000;font-weight:bold;">${finalReferenceId}</span></div>
      <div>Digital Minds BPO Services Inc. | Confidential</div>
    </footer>
  </div>
</body>
</html>`;

    // Convert to PDF & Save
    const blob = Utilities.newBlob(htmlContent, 'text/html').getAs('application/pdf');
    const fileName = `NTE_${employeeName}_${issuedDate.toLocaleString('en-US', { month: 'long' })}_${issuedDate.getFullYear()}.pdf`;
    blob.setName(fileName);

    const savedFile = folder.createFile(blob);
    sheet.getRange(row, 10).setValue(`Saved: ${savedFile.getName()}`);
    sheet.getRange(row, 11).setValue(finalReferenceId);
  }
}