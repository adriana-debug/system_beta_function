<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BPO Dashboard â€” Coaching</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: { extend: { colors: { brand: '#CBEB33', brandlight: '#D9F25A' } } }
    };
  </script>
  <style>
    .page-section { display: none; }
    .page-section.active { display: block; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">
  <div class="flex min-h-screen">
    <aside class="w-64 bg-white shadow-xl flex flex-col">
      <div class="p-6 flex flex-col items-center gap-2">
        <img src="dmi_logo.jpg" alt="Logo" class="w-20 h-20 rounded-full object-cover mb-2">
        <h1 class="text-xl font-bold">Digital Minds BPO</h1>
      </div>
      <nav class="flex-1 px-4 space-y-2">
        <a href="#" data-page="dashboard" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-brandlight">Dashboard</a>
        <a href="#" data-page="coaching" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-brandlight">Coaching Log</a>
      </nav>
      <div class="p-4"><button class="w-full py-2 bg-brand hover:bg-brandlight rounded-lg">Logout</button></div>
    </aside>

    <main class="flex-1 p-6">
      <section id="dashboard" class="page-section active">
        <h1 class="text-3xl font-bold mb-4">Dashboard</h1>
        <div class="bg-white rounded-xl shadow-md p-6 h-96 flex items-center justify-center text-gray-400">KPIs here</div>
      </section>

      <section id="coaching" class="page-section">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold">Coaching Log</h1>
          <button id="addCoachingBtn" class="bg-brand px-4 py-2 rounded-lg">Add Coaching Session</button>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 relative">
          <h2 class="text-xl font-semibold mb-4">Past Coaching Sessions</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-100 text-gray-700">
                <tr>
                  <th class="text-left px-4 py-3">Date</th>
                  <th class="text-left px-4 py-3">Coach</th>
                  <th class="text-left px-4 py-3">Employee</th>
                  <th class="text-left px-4 py-3">Employee No.</th>
                  <th class="text-left px-4 py-3">Focus Area</th>
                  <th class="text-left px-4 py-3">Acknowledge</th>
                  <th class="text-left px-4 py-3">Actions</th>
                </tr>
              </thead>
              <tbody id="coachingSessionsTable" class="divide-y divide-gray-200">
                <tr><td colspan="7" class="p-6 text-center text-gray-500">Loading coaching data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div id="coachingModalBg" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[1050]">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-6 relative">
      <div class="flex justify-between items-center mb-4 border-b pb-2">
        <h3 id="coachingModalTitle" class="text-xl font-semibold">Add Coaching Session</h3>
        <button id="closeModalBtn" class="text-gray-500 text-2xl leading-none">&times;</button>
      </div>

      <form id="coachingForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" name="id" value="">

        <div>
          <label class="block text-sm font-medium mb-1">Employee Number</label>
          <input type="text" id="employeeNumber" name="employeenumber" required class="w-full border rounded px-3 py-2 text-sm">
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Session Date</label>
          <input type="date" id="sessionDate" name="date" required class="w-full border rounded px-3 py-2 text-sm">
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Employee Name</label>
          <input type="text" id="employeeName" name="employee" required class="w-full border rounded px-3 py-2 text-sm">
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Coach Name</label>
          <input type="text" id="coachName" name="coach" required class="w-full border rounded px-3 py-2 text-sm">
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1">Performance/Behavior Observed (Focus Area)</label>
          <textarea id="performanceObserved" name="performance" rows="3" required class="w-full border rounded px-3 py-2 text-sm"></textarea>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1">Coaching Provided</label>
          <textarea id="coachingProvided" name="coachingprovided" rows="3" required class="w-full border rounded px-3 py-2 text-sm"></textarea>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1">Agreed Action Plan</label>
          <textarea id="actionPlan" name="actionplan" rows="3" required class="w-full border rounded px-3 py-2 text-sm"></textarea>
        </div>

        <!-- Acknowledge container: hide during create -->
        <div id="acknowledgeContainer">
          <label class="block text-sm font-medium mb-1">Acknowledge</label>
          <select id="acknowledgeStatus" name="acknowledge" class="w-full border rounded px-3 py-2 text-sm">
            <option value="Pending">Pending</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>

        <div class="md:col-span-2 flex justify-end space-x-3 pt-4">
          <button type="button" id="cancelBtn" class="px-4 py-2 rounded bg-gray-200">Cancel</button>
          <button type="submit" id="saveBtn" class="px-6 py-2 rounded bg-brand">Save</button>
        </div>
      </form>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  initializePageNavigation();
  document.getElementById('addCoachingBtn').addEventListener('click', () => openCoachingModal({ mode: 'create' }));
  document.getElementById('closeModalBtn').addEventListener('click', closeCoachingModal);
  document.getElementById('cancelBtn').addEventListener('click', closeCoachingModal);
  document.getElementById('coachingForm').addEventListener('submit', onCoachingFormSubmit);
  loadSessions();
});

const API_URL_COACHING = "https://script.google.com/macros/s/AKfycbyn9CG1Lk3S5bXtfEEbvH5H-8GfBBOvY4OGSJPyIM5RZSDBCOf4fwkXVvnKjzZGvqUL/exec";

function initializePageNavigation() {
  const navLinks = document.querySelectorAll('.nav-link');
  const pageSections = document.querySelectorAll('.page-section');
  const defaultPageId = 'dashboard';
  function navigateTo(pageId) {
    navLinks.forEach(link => link.classList.toggle('bg-brandlight', link.dataset.page === pageId));
    pageSections.forEach(section => section.classList.toggle('active', section.id === pageId));
    if (pageId === 'coaching') loadSessions();
  }
  navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(link.dataset.page); }));
  navigateTo(defaultPageId);
}

/* -------------------------
   Modal open / close
--------------------------*/
const modalBg = document.getElementById('coachingModalBg');
const coachingForm = document.getElementById('coachingForm');
const acknowledgeContainer = document.getElementById('acknowledgeContainer');

function openCoachingModal({ mode = 'create', session = null } = {}) {
  // mode: 'create' | 'edit' | 'view'
  modalBg.classList.remove('hidden');
  coachingForm.reset();
  delete coachingForm.dataset.editId;

  if (mode === 'create') {
    document.getElementById('coachingModalTitle').innerText = 'Add Coaching Session';
    // hide acknowledge for create (server will default to Pending)
    acknowledgeContainer.style.display = 'none';
    // ensure submit visible and enabled
    document.getElementById('saveBtn').style.display = '';
    enableFormFields(true);
  } else {
    // show acknowledge for edit/view
    acknowledgeContainer.style.display = '';
    if (session) {
      populateFormFromSession(session);
      if (mode === 'view') {
        document.getElementById('coachingModalTitle').innerText = 'View Coaching Session';
        enableFormFields(false);
        document.getElementById('saveBtn').style.display = 'none';
      } else {
        document.getElementById('coachingModalTitle').innerText = 'Edit Coaching Session';
        enableFormFields(true);
        coachingForm.dataset.editId = String(session.id || session.ID || '');
        document.getElementById('saveBtn').style.display = '';
      }
    }
  }
}

function closeCoachingModal() {
  modalBg.classList.add('hidden');
  coachingForm.reset();
  delete coachingForm.dataset.editId;
  acknowledgeContainer.style.display = ''; // restore default
  enableFormFields(true);
}

function enableFormFields(enabled) {
  Array.from(coachingForm.elements).forEach(el => {
    // keep the hidden id unaffected
    if (el.type !== 'hidden') el.disabled = !enabled;
  });
}

/* -------------------------
   Load & Render sessions
--------------------------*/
const coachingTableBody = document.getElementById('coachingSessionsTable');

async function loadSessions() {
  coachingTableBody.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-gray-500">Loading coaching data...</td></tr>';
  try {
    const res = await fetch(API_URL_COACHING);
    if (!res.ok) throw new Error(`API status ${res.status}`);
    const sessions = await res.json();
    renderSessions(sessions || []);
  } catch (err) {
    console.error('Load sessions error', err);
    coachingTableBody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-red-500">Failed to load sessions. ${err.message}</td></tr>`;
  }
}

function renderSessions(sessions) {
  coachingTableBody.innerHTML = '';
  if (!sessions.length) {
    coachingTableBody.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-gray-500">No coaching sessions found.</td></tr>';
    return;
  }

  sessions.forEach(session => {
    // normalize keys
    const s = normalizeSession(session);

    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50';

    const tdDate = document.createElement('td'); tdDate.className = 'px-4 py-2'; tdDate.textContent = s.date || '-';
    const tdCoach = document.createElement('td'); tdCoach.className = 'px-4 py-2'; tdCoach.textContent = s.coach || '-';
    const tdEmployee = document.createElement('td'); tdEmployee.className = 'px-4 py-2'; tdEmployee.textContent = s.employee || '-';
    const tdEmpNo = document.createElement('td'); tdEmpNo.className = 'px-4 py-2'; tdEmpNo.textContent = s.employeenumber || '-';
    const tdFocus = document.createElement('td'); tdFocus.className = 'px-4 py-2'; tdFocus.textContent = (s.performance || '').substring(0,50) + ((s.performance || '').length > 50 ? '...' : '');
    const tdAck = document.createElement('td'); tdAck.className = 'px-4 py-2'; tdAck.textContent = s.acknowledge || 'Pending';

    const tdActions = document.createElement('td'); tdActions.className = 'px-4 py-2 flex space-x-2';

    const viewBtn = document.createElement('button');
    viewBtn.className = 'text-blue-500 hover:underline';
    viewBtn.textContent = 'View';
    viewBtn.addEventListener('click', () => openCoachingModal({ mode: 'view', session: s }));

    const editBtn = document.createElement('button');
    editBtn.className = 'text-green-500 hover:underline';
    editBtn.textContent = 'Edit';
    editBtn.addEventListener('click', () => openCoachingModal({ mode: 'edit', session: s }));

    const delBtn = document.createElement('button');
    delBtn.className = 'text-red-500 hover:underline';
    delBtn.textContent = 'Delete';
    delBtn.addEventListener('click', () => {
      if (!s.id) return alert('Missing session id');
      if (!confirm('Delete this coaching session?')) return;
      deleteSession(s.id);
    });

    tdActions.appendChild(viewBtn);
    tdActions.appendChild(editBtn);
    tdActions.appendChild(delBtn);

    tr.appendChild(tdDate);
    tr.appendChild(tdCoach);
    tr.appendChild(tdEmployee);
    tr.appendChild(tdEmpNo);
    tr.appendChild(tdFocus);
    tr.appendChild(tdAck);
    tr.appendChild(tdActions);

    coachingTableBody.appendChild(tr);
  });
}

function normalizeSession(session) {
  // API returns lowercase keys per GAS doGet; but be defensive
  const s = {};
  s.id = (session.id || session.ID || session.Id || session['ID'] || '');
  s.date = (session.date || session.Date || '');
  s.coach = (session.coach || session.Coach || '');
  s.employee = (session.employee || session.Employee || '');
  s.employeenumber = (session.employeenumber || session.EmployeeNumber || session['Employee No.'] || '');
  s.performance = (session.performance || session.Performance || '');
  s.coachingprovided = (session.coachingprovided || session.CoachingProvided || '');
  s.actionplan = (session.actionplan || session.ActionPlan || '');
  s.acknowledge = (session.acknowledge || session.Acknowledge || 'Pending');
  return s;
}

/* -------------------------
   Populate form & submit
--------------------------*/
function populateFormFromSession(session) {
  const s = normalizeSession(session);
  coachingForm.elements['id'].value = s.id || '';
  coachingForm.elements['employeenumber'].value = s.employeenumber || '';
  // convert date to yyyy-mm-dd for input[type=date] if possible
  if (s.date) {
    const d = new Date(s.date);
    if (!isNaN(d)) {
      const iso = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      coachingForm.elements['date'].value = iso;
    } else {
      coachingForm.elements['date'].value = '';
    }
  } else {
    coachingForm.elements['date'].value = '';
  }
  coachingForm.elements['employee'].value = s.employee || '';
  coachingForm.elements['coach'].value = s.coach || '';
  coachingForm.elements['performance'].value = s.performance || '';
  coachingForm.elements['coachingprovided'].value = s.coachingprovided || '';
  coachingForm.elements['actionplan'].value = s.actionplan || '';
  if (coachingForm.elements['acknowledge']) coachingForm.elements['acknowledge'].value = s.acknowledge || 'Pending';
}

async function onCoachingFormSubmit(e) {
  e.preventDefault();
  const isEditing = !!coachingForm.dataset.editId;
  const fd = new FormData(coachingForm);
  const formObj = Object.fromEntries(fd.entries());

  // convert date to a consistent format (ISO) so GAS can parse
  if (formObj.date) {
    // If user provided yyyy-mm-dd input, keep it
    // let GAS handle formatting to M/d/yyyy
  }

  let body;
  if (isEditing) {
    // include acknowledge when editing
    body = { _method: 'PUT', id: coachingForm.dataset.editId, ...formObj };
  } else {
    // creating: do not send id or acknowledge (server will set Pending)
    delete formObj.id;
    delete formObj.acknowledge;
    body = { ...formObj };
  }

  try {
    const res = await fetch(API_URL_COACHING, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`API status ${res.status}`);
    const json = await res.json();
    // basic success handling
    closeCoachingModal();
    await loadSessions();
  } catch (err) {
    console.error('Save error', err);
    alert('Error saving session: ' + (err.message || err));
  }
}

/* -------------------------
   Delete
--------------------------*/
async function deleteSession(id) {
  try {
    const res = await fetch(API_URL_COACHING, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ _method: 'DELETE', id: String(id) })
    });
    if (!res.ok) throw new Error(`API status ${res.status}`);
    await loadSessions();
  } catch (err) {
    console.error('Delete error', err);
    alert('Error deleting session: ' + (err.message || err));
  }
}
</script>
</body>
</html>
