<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance Dashboard</title>

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Roboto', 'sans-serif'] },
          colors: {
            'google-blue': '#4285F4',
            'google-green': '#34A853',
            'google-red': '#EA4335',
            'google-yellow': '#FBBC05',
            'brand-accent': '#CBEB33',
            'brand-dark': '#B5D12F',
            'bg-dark': '#0f172a',
            'text-dark': '#f1f5f9',
            'card-dark': '#1e293b',
            'border-dark': '#334155',
            'danger': '#ef4444',
            'bg-light': '#f8fafc',
            'text-light': '#1e293b'
          }
        }
      }
    }
  </script>

  <style>
    /* small helpers */
    .kpi-card { transition: box-shadow 0.25s ease, transform 0.18s ease; }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(16,24,40,0.08); }
    .table-head { background-color: rgba(247,250,252,1); }
    /* ensure material symbol color uses currentColor when needed */
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48; }
    /* small responsive tweaks */
    @media (min-width: 1280px) {
      .max-w-9xl { max-width: 1440px; }
    }
    /* keep session-only dark mode; no localStorage */
  </style>
</head>

<body class="min-h-screen bg-gray-100 text-gray-800 font-sans transition-colors duration-300">

  <!-- Header (KB-style flat header) -->
  <header class="flex items-center gap-4 bg-white dark:bg-card-dark p-4 shadow sticky top-0 z-30 border-b border-gray-100 dark:border-border-dark">
    <div class="flex items-center gap-3">
      <img src="dmi_logo.jpg" alt="Logo" class="w-8 h-8 rounded-full object-cover shadow-sm">
      <h1 id="pageTitle" class="text-xl font-extrabold text-gray-900 dark:text-text-dark">Attendance Dashboard</h1>
    </div>

    <!-- Filters area -->
    <div class="flex-1 flex items-center justify-center md:justify-start px-4">
      <div class="w-full max-w-3xl flex gap-3 items-center">
        <!-- Search-like wrapper for Month -->
        <div class="relative flex-1">
          <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">calendar_month</span>
          <select id="monthSelector" class="w-full pl-11 pr-4 py-2 rounded-full border border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-accent bg-white dark:bg-card-dark dark:border-border-dark dark:text-text-dark">
            <option value="" disabled selected>Select Month</option>
            <option value="1">January</option><option value="2">February</option><option value="3">March</option>
            <option value="4">April</option><option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option><option value="9">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
        </div>

        <!-- Team/Roster -->
        <div class="relative w-64">
          <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">groups</span>
          <select id="rosterSelector" class="w-full pl-11 pr-4 py-2 rounded-full border border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-accent bg-white dark:bg-card-dark dark:border-border-dark dark:text-text-dark">
            <option value="">All Teams</option>
          </select>
        </div>

        <!-- Refresh / Loading hint -->
        <button id="refreshBtn" title="Reload" class="ml-2 p-2 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-border-dark dark:hover:bg-gray-700 transition">
          <i class="material-symbols-outlined">refresh</i>
        </button>
      </div>
    </div>

    <!-- Dark mode toggle (session only) -->
    <div class="ml-auto">
      <button id="themeToggle" aria-label="Toggle dark mode" class="p-2 rounded-full bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition-all duration-200">
        <span id="themeIcon" class="material-symbols-outlined text-xl">dark_mode</span>
      </button>
    </div>
  </header>

  <!-- Main container -->
  <main class="max-w-9xl mx-auto px-6 -mt-6 relative z-10">

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div class="bg-white dark:bg-card-dark rounded-2xl p-6 kpi-card border border-gray-100 dark:border-border-dark">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">Present</h2>
          <i data-feather="user-check" class="text-green-500"></i>
        </div>
        <p id="kpi-present" class="text-3xl font-extrabold mt-4 text-green-600 dark:text-green-400">0</p>
      </div>

      <div class="bg-white dark:bg-card-dark rounded-2xl p-6 kpi-card border border-gray-100 dark:border-border-dark">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">Absent</h2>
          <i data-feather="user-x" class="text-red-500"></i>
        </div>
        <p id="kpi-absent" class="text-3xl font-extrabold mt-4 text-red-600 dark:text-red-400">0</p>
      </div>

      <div class="bg-white dark:bg-card-dark rounded-2xl p-6 kpi-card border border-gray-100 dark:border-border-dark">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">Tardiness</h2>
          <i data-feather="clock" class="text-yellow-500"></i>
        </div>
        <p id="kpi-tardy" class="text-3xl font-extrabold mt-4 text-yellow-600 dark:text-yellow-400">0</p>
      </div>

      <div class="bg-white dark:bg-card-dark rounded-2xl p-6 kpi-card border border-gray-100 dark:border-border-dark">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">Planned Leave</h2>
          <i data-feather="activity" class="text-blue-500"></i>
        </div>
        <p id="kpi-leave" class="text-3xl font-extrabold mt-4 text-blue-600 dark:text-blue-400">0</p>
      </div>

      <div class="bg-white dark:bg-card-dark rounded-2xl p-6 kpi-card border border-gray-100 dark:border-border-dark">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-medium text-gray-600 dark:text-gray-300">Attendance Score</h2>
          <i data-feather="pie-chart" class="text-purple-500"></i>
        </div>
        <p id="kpi-score" class="text-3xl font-extrabold mt-4 text-purple-600 dark:text-purple-400">0%</p>
      </div>
    </div>

    <!-- Loading spinner (overlay) -->
    <div id="loading-spinner" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/30">
      <div class="bg-white dark:bg-card-dark rounded-xl p-6 flex items-center gap-4 shadow-lg">
        <svg class="animate-spin h-8 w-8 text-google-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <div class="text-sm text-gray-700 dark:text-text-dark">Loading attendance data…</div>
      </div>
    </div>

    <!-- Main grid: Campaign summary + Legend -->
    <div class="grid grid-cols-1 lg:grid-cols-6 gap-6 mb-8">
      <section class="lg:col-span-4 bg-white dark:bg-card-dark rounded-2xl p-6 border border-gray-100 dark:border-border-dark shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-text-dark">Campaign Summary</h3>
          <div class="text-sm text-gray-500 dark:text-gray-400">Updated live</div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="table-head dark:bg-border-dark">
              <tr class="text-xs text-gray-600 dark:text-gray-300 uppercase">
                <th class="px-4 py-2 text-left">Campaign</th>
                <th class="px-4 py-2 text-center">Present</th>
                <th class="px-4 py-2 text-center">Late</th>
                <th class="px-4 py-2 text-center">Half Day</th>
                <th class="px-4 py-2 text-center">Absent</th>
                <th class="px-4 py-2 text-center">Score</th>
              </tr>
            </thead>
            <tbody id="campaign-summary-body" class="divide-y divide-gray-100 dark:divide-border-dark">
              <!-- injected rows -->
            </tbody>
          </table>
        </div>
      </section>

      <aside class="lg:col-span-2 bg-white dark:bg-card-dark rounded-2xl p-6 border border-gray-100 dark:border-border-dark shadow-sm">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-text-dark mb-4">Legend</h3>
        <div class="grid grid-cols-1 gap-3 text-sm text-gray-700 dark:text-gray-300">
          <div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full bg-[#38761D]"></span><span>P – Present</span></div>
          <div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full bg-[#00FF00]"></span><span>HD – Half Day</span></div>
          <div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full bg-[#F59E0B]"></span><span>L – Late</span></div>
          <div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full bg-[#6FA8DC]"></span><span>SL – Sick Leave</span></div>
          <div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full bg-[#8E7CC3]"></span><span>T – Training</span></div>
          <div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full bg-[#0000FF]"></span><span>VL – Vacation Leave</span></div>
          <div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full bg-[#00FFFF]"></span><span>SUS – Suspended</span></div>
          <div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full bg-[#9CA3AF]"></span><span>Off – Day Off</span></div>
          <div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full bg-[#EF4444]"></span><span>A – Absent</span></div>
          <div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full bg-[#14B8A6]"></span><span>H – Holiday</span></div>
        </div>
      </aside>
    </div>

    <!-- Attendance Calendars (Campaign Feed) -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-text-dark">Campaign Feed</h2>
      <div id="campaign-feed" class="space-y-6"></div>
    </section>

    <!-- Footer -->
    <footer class="py-6 text-center text-sm text-gray-500 dark:text-gray-400 border-t border-gray-100 dark:border-border-dark">
      &copy; 2025 Digital Minds BPO. All rights reserved.
    </footer>
  </main>

  <!-- Scripts (kept original logic, only adapted minor IDs/classes) -->
  <script>
    // Feather icons
    feather.replace();

    // Keep your BASE_URL intact
    const BASE_URL = "https://script.google.com/macros/s/AKfycbzrN_zWK3AtRd5gO5XG-nA5WYIvcDPnlUJ73PFmNghOzRfXs8r6he97FYxzmcoYXHihwg/exec";

    // color map preserved
    const statusColors = {
      P: "bg-[#38761D]", HD: "bg-[#00FF00]", L: "bg-[#F59E0B]",
      SL: "bg-[#6FA8DC]", T: "bg-[#8E7CC3]", VL: "bg-[#0000FF]",
      SUS: "bg-[#00FFFF]", Off: "bg-[#9CA3AF]", A: "bg-[#EF4444]",
      H: "bg-[#14B8A6]", NA: ""
    };

    /* ---------- Loading / Cluster / Summary functions (kept logic) ---------- */

    async function loadClusters() {
      try {
        const res = await fetch(BASE_URL + "?api=clusters");
        const clusters = await res.json();
        const select = document.getElementById("rosterSelector");
        select.innerHTML = `<option value="">All Teams</option>`;
        clusters.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("Failed to load clusters:", err);
      }
    }

    async function loadAll() {
      const spinner = document.getElementById("loading-spinner");
      spinner.classList.remove("hidden");

      const monthVal = document.getElementById("monthSelector").value;
      const clusterVal = document.getElementById("rosterSelector").value;

      try {
        const params = new URLSearchParams({ api:"summary", month:monthVal, cluster:clusterVal });
        const summary = await (await fetch(BASE_URL + "?" + params.toString())).json();
        renderKPIs(summary);
        renderCampaignSummary(summary);

        const calParams = new URLSearchParams({ api:"calendars", month:monthVal, cluster:clusterVal });
        const calData = await (await fetch(BASE_URL + "?" + calParams.toString())).json();
        renderCalendars(calData);
      } catch (err) {
        console.error(err);
      } finally {
        spinner.classList.add("hidden");
      }
    }

    function renderKPIs(summary) {
      const present = summary.overall.P || 0;
      const absent = summary.overall.A || 0;
      const halfDay = summary.overall.HD || 0;
      const late = summary.overall.L || 0;
      const vacation = summary.overall.VL || 0;
      const total = present + absent + halfDay + late + vacation;
      document.getElementById("kpi-present").textContent = present;
      document.getElementById("kpi-absent").textContent = absent;
      document.getElementById("kpi-tardy").textContent = late;
      document.getElementById("kpi-leave").textContent = vacation;
      document.getElementById("kpi-score").textContent =
        (total > 0 ? Math.round((present / total) * 100) : 0) + "%";
    }

    function renderCampaignSummary(summary) {
      const rows = Object.entries(summary.campaigns || {}).map(([campaign, stats]) => {
        const total = (stats.P||0) + (stats.A||0) + (stats.HD||0) + (stats.L||0);
        const score = total > 0 ? Math.round((stats.P / total) * 100) : 0;
        return { campaign, P:stats.P||0, L:stats.L||0, HD:stats.HD||0, A:stats.A||0, score };
      });
      rows.sort((a,b)=>a.score-b.score);

      const tbody = document.getElementById("campaign-summary-body");
      tbody.innerHTML = rows.map(r=>`
        <tr class="hover:bg-gray-50 dark:hover:bg-border-dark">
          <td class="px-4 py-3 font-medium text-gray-700 dark:text-text-dark">${r.campaign}</td>
          <td class="px-4 py-3 text-center">${r.P}</td>
          <td class="px-4 py-3 text-center text-yellow-600">${r.L}</td>
          <td class="px-4 py-3 text-center text-blue-600">${r.HD}</td>
          <td class="px-4 py-3 text-center text-red-600">${r.A}</td>
          <td class="px-4 py-3 text-center font-semibold ${r.score<70?'text-red-600':r.score<90?'text-yellow-600':'text-green-600'}">${r.score}%</td>
        </tr>`).join("");
    }

    function renderCalendars(campaigns) {
      const feed = document.getElementById("campaign-feed");
      feed.innerHTML = "";
      Object.entries(campaigns || {}).forEach(([campaign, employees])=>{
        const card=document.createElement("div");
        card.className="bg-white dark:bg-card-dark rounded-2xl shadow-sm border border-gray-100 dark:border-border-dark";
        card.innerHTML=`
          <div class="p-5 border-b dark:border-border-dark flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-full bg-google-blue flex items-center justify-center text-white font-semibold">
                ${campaign.slice(0,2).toUpperCase()}
              </div>
              <div>
                <p class="font-semibold text-slate-900 dark:text-text-dark">${campaign}</p>
                <p class="text-sm text-slate-500 dark:text-gray-400">Attendance Calendar</p>
              </div>
            </div>
          </div>
          <div class="p-4 overflow-x-auto">
            <table class="table-fixed border-collapse text-xs w-full">
              <thead class="bg-gray-50 dark:bg-border-dark">
                <tr>
                  <th class="border px-2 py-1 text-left w-40">Employee</th>
                  ${[...Array(31).keys()].map(d=>`<th class="border px-1 py-1 w-6 text-center">${d+1}</th>`).join("")}
                </tr>
              </thead>
              <tbody>
                ${Object.entries(employees).map(([name,days])=>`
                  <tr>
                    <td class="border px-2 py-1 font-medium text-gray-700 dark:text-text-dark">${name}</td>
                    ${days.map(st=>{
                      if(st==="NA"){
                        return `<td class="border w-6 h-6" style="background:repeating-linear-gradient(45deg,#E5E7EB 0px,#E5E7EB 2px,#D1D5DB 2px,#D1D5DB 4px);"></td>`;
                      }
                      return `<td class="border w-6 h-6 ${statusColors[st]||""}" title="${st}"></td>`;
                    }).join("")}
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `;
        feed.appendChild(card);
      });
      feather.replace();
    }

    /* ---------- Event wiring ---------- */
    document.getElementById("monthSelector").addEventListener("change", loadAll);
    document.getElementById("rosterSelector").addEventListener("change", loadAll);
    document.getElementById("refreshBtn").addEventListener("click", loadAll);

    // Theme toggle (session-only)
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');

    function updateThemeIcon(isDark) {
      themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
    }

    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark');
      // Session-only: do not persist to localStorage
      updateThemeIcon(isDark);
    }

    themeToggle.addEventListener('click', toggleTheme);

    // Initialize default month and clusters on load
    window.onload = async () => {
      await loadClusters();
      const now = new Date();
      document.getElementById("monthSelector").value = (now.getMonth()+1);
      // initialize icon according to current body state (no persistence)
      updateThemeIcon(document.body.classList.contains('dark'));
      loadAll();
    };
  </script>

</body>
</html>
