<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Applicant Intake Portal</title>
  <!-- Load Roboto Font -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Load Material Symbols for icons -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <!-- Load Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind Configuration for Dark Mode and Custom Colors
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Roboto', 'sans-serif'],
          },
          colors: {
            'google-blue': '#4285F4',
            'brand-accent': '#CBEB33', // Accent color for highlights
            'brand-dark': '#B5D12F',
            'bg-dark': '#0f172a',
            'text-dark': '#f1f5f9',
            'card-dark': '#1e293b',
            'border-dark': '#334155',
            'danger': '#ef4444',
            'primary-applicant': '#4285F4', // Primary color for the app
            'primary-applicant-hover': '#1a73e8',
          },
        },
      },
    }
  </script>
  <style>
    /* Custom utility classes */
    .btn-primary {
      @apply bg-primary-applicant text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 hover:bg-primary-applicant-hover focus:outline-none focus:ring-2 focus:ring-primary-applicant/50 focus:ring-offset-2;
    }

    .btn-secondary {
      @apply bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 hover:bg-gray-300 dark:bg-card-dark dark:text-text-dark dark:hover:bg-border-dark;
    }

    .input-field {
      @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-applicant focus:border-primary-applicant dark:bg-card-dark dark:border-border-dark dark:text-text-dark;
    }

    /* Dark Mode Styling */
    .dark .bg-white { background-color: #1e293b; }
    .dark .text-gray-800 { color: #f1f5f9; }
    .dark .border-gray-200 { border-color: #334155; }
    .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2); }
    .dark body { background-color: #0f172a; }

    /* Custom scrollbar for better visual appeal in dark mode */
    ::-webkit-scrollbar {
        width: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }
    .dark ::-webkit-scrollbar-track {
        background: #1e293b;
    }
    ::-webkit-scrollbar-thumb {
        background: #a0aec0;
        border-radius: 10px;
    }
    .dark ::-webkit-scrollbar-thumb {
        background: #475569;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #718096;
    }

    /* Table styling */
    .table-header-cell {
        @apply px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400;
    }

    .table-data-cell {
        @apply px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-text-dark;
    }
  </style>
</head>
<body class="font-sans bg-gray-50 dark:bg-bg-dark transition-colors duration-300 min-h-screen">

  <!-- Header/Navigation Bar -->
  <header class="shadow-md bg-white dark:bg-card-dark sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex-shrink-0">
          <h1 class="text-xl font-bold text-primary-applicant flex items-center">
            <i class="fas fa-user-tie mr-2"></i> Applicant Intake
          </h1>
        </div>
        <div class="flex items-center space-x-4">
          <!-- Toggle View Button -->
          <button id="toggle-view-btn" class="text-gray-600 dark:text-gray-300 hover:text-primary-applicant dark:hover:text-brand-accent transition duration-150 p-2 rounded-full" onclick="toggleView()">
            <span class="material-symbols-outlined text-2xl" id="view-icon">dashboard</span>
          </button>
          <!-- Dark Mode Toggle -->
          <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 hover:text-primary-applicant dark:hover:text-brand-accent transition duration-150 p-2 rounded-full">
            <i class="fas fa-sun text-xl dark:hidden"></i>
            <i class="fas fa-moon text-xl hidden dark:inline"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 dark:bg-bg-dark dark:bg-opacity-90 z-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary-applicant dark:border-brand-accent"></div>
            <p id="loading-message" class="mt-4 text-white text-lg font-medium">Processing...</p>
        </div>
    </div>

    <!-- Message Box (Alert/Confirmation replacement) -->
    <div id="message-box" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-gray-900 opacity-50 dark:bg-bg-dark dark:opacity-70"></div>
        <div class="bg-white dark:bg-card-dark rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all duration-300 scale-100">
            <h3 id="message-title" class="text-xl font-semibold mb-4 text-gray-900 dark:text-text-dark"></h3>
            <p id="message-body" class="mb-6 text-gray-600 dark:text-gray-300"></p>
            <div class="flex justify-end space-x-3">
                <button id="message-cancel" class="btn-secondary hidden">Cancel</button>
                <button id="message-ok" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Application Form View -->
    <section id="applicant-form-view" class="w-full max-w-4xl mx-auto p-6 bg-white dark:bg-card-dark shadow-xl rounded-xl transition-all duration-300">
      <h2 class="text-3xl font-bold text-center mb-6 text-gray-800 dark:text-text-dark">Job Application Form</h2>
      <p class="text-center text-gray-500 dark:text-gray-400 mb-8">Please fill out the form accurately. Fields marked with * are required.</p>

      <form id="applicant-form" class="space-y-6">

        <!-- Section: Personal Information -->
        <fieldset class="border border-gray-300 dark:border-border-dark p-4 rounded-lg">
          <legend class="text-lg font-semibold px-2 text-primary-applicant dark:text-brand-accent">Personal Information</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label for="firstName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">First Name *</label>
              <input type="text" id="firstName" name="firstName" class="input-field" required>
            </div>
            <div>
              <label for="lastName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Last Name *</label>
              <input type="text" id="lastName" name="lastName" class="input-field" required>
            </div>
            <div>
              <label for="nickname" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nickname</label>
              <input type="text" id="nickname" name="nickname" class="input-field">
            </div>
            <div>
              <label for="age" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Age</label>
              <input type="number" id="age" name="age" class="input-field">
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Address *</label>
              <input type="email" id="email" name="email" class="input-field" required>
            </div>
            <div>
              <label for="phoneNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phone Number *</label>
              <input type="tel" id="phoneNumber" name="phoneNumber" class="input-field" required>
            </div>
            <div class="md:col-span-2">
              <label for="address" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Full Address</label>
              <textarea id="address" name="address" rows="2" class="input-field"></textarea>
            </div>
            <div>
              <label for="civilStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Civil Status</label>
              <select id="civilStatus" name="civilStatus" class="input-field">
                <option value="">Select Status</option>
                <option value="Single">Single</option>
                <option value="Married">Married</option>
                <option value="Divorced">Divorced</option>
                <option value="Widowed">Widowed</option>
              </select>
            </div>
          </div>
        </fieldset>

        <!-- Section: Job Details -->
        <fieldset class="border border-gray-300 dark:border-border-dark p-4 rounded-lg">
          <legend class="text-lg font-semibold px-2 text-primary-applicant dark:text-brand-accent">Job Details</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label for="positionApplied" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Position Applied For *</label>
              <select id="positionApplied" name="positionApplied" class="input-field" required>
                <option value="">Select a position</option>
                <option value="Customer Service Representative">Customer Service Representative</option>
                <option value="Technical Support Specialist">Technical Support Specialist</option>
                <option value="Sales Agent">Sales Agent</option>
                <option value="Team Leader">Team Leader</option>
                <option value="IT Support">IT Support</option>
                <option value="Other">Other (Please specify in Notes)</option>
              </select>
            </div>
            <div>
              <label for="source" class="block text-sm font-medium text-gray-700 dark:text-gray-300">How did you hear about us? *</label>
              <select id="source" name="source" class="input-field" required>
                <option value="">Select a source</option>
                <option value="Referral">Referral</option>
                <option value="Job Board (e.g., Indeed)">Job Board (e.g., Indeed)</option>
                <option value="Social Media">Social Media</option>
                <option value="Company Website">Company Website</option>
                <option value="Walk-in">Walk-in</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label for="salaryExpectation" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Salary Expectation (Monthly, in currency)</label>
              <input type="text" id="salaryExpectation" name="salaryExpectation" class="input-field" placeholder="e.g., 25,000 PHP">
            </div>
          </div>
        </fieldset>

        <!-- Section: Other Details -->
        <fieldset class="border border-gray-300 dark:border-border-dark p-4 rounded-lg">
          <legend class="text-lg font-semibold px-2 text-primary-applicant dark:text-brand-accent">Work/Location Details</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label for="travelTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Estimated Travel Time (One Way)</label>
              <input type="text" id="travelTime" name="travelTime" class="input-field" placeholder="e.g., 45 minutes">
            </div>
            <div>
              <label for="vehicle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vehicle Owned (If any)</label>
              <input type="text" id="vehicle" name="vehicle" class="input-field" placeholder="e.g., Car, Motorbike, None">
            </div>
            <div class="md:col-span-2">
              <label for="workExperience" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Relevant Work Experience Summary</label>
              <textarea id="workExperience" name="workExperience" rows="3" class="input-field" placeholder="Briefly describe your most relevant experience."></textarea>
            </div>
            <div class="md:col-span-2">
              <label for="education" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Highest Educational Attainment</label>
              <input type="text" id="education" name="education" class="input-field" placeholder="e.g., Bachelor of Science in IT">
            </div>
            <div class="md:col-span-2">
              <label for="languages" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Languages Spoken (and fluency level)</label>
              <input type="text" id="languages" name="languages" class="input-field" placeholder="e.g., English (Fluent), Spanish (Basic)">
            </div>
            <div class="md:col-span-2">
              <label for="skills" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Key Skills</label>
              <input type="text" id="skills" name="skills" class="input-field" placeholder="e.g., Data Entry, Excel, Communication, Teamwork">
            </div>
            <div class="md:col-span-2">
              <label for="referral" class="block text-sm font-medium text-gray-700 dark:text-gray-300">If referred, by whom?</label>
              <input type="text" id="referral" name="referral" class="input-field" placeholder="Full name of the referrer">
            </div>
          </div>
        </fieldset>

        <!-- Section: Resume Upload -->
        <fieldset class="border border-gray-300 dark:border-border-dark p-4 rounded-lg">
          <legend class="text-lg font-semibold px-2 text-primary-applicant dark:text-brand-accent">Resume/CV Upload *</legend>
          <div class="mt-4">
            <label for="resume" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Upload your Resume (PDF only, max 5MB)</label>
            <input type="file" id="resume" name="resume" accept="application/pdf" class="w-full text-gray-700 dark:text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-applicant/10 file:text-primary-applicant hover:file:bg-primary-applicant/20 dark:file:bg-brand-accent/20 dark:file:text-brand-accent dark:hover:file:bg-brand-accent/30" required>
            <p id="file-error" class="text-sm text-danger mt-1 hidden">File too large or incorrect format.</p>
          </div>
        </fieldset>

        <!-- Final Notes (Admin fields hidden from applicant view) -->
        <input type="hidden" id="account" name="account" value="">
        <input type="hidden" id="finalInterview" name="finalInterview" value="">
        <input type="hidden" id="clientInterview" name="clientInterview" value="">
        <input type="hidden" id="comment" name="comment" value="">
        <input type="hidden" id="background" name="background" value="">
        <input type="hidden" id="notes" name="notes" value="">
        <input type="hidden" id="dateApplied" name="dateApplied" value="<?= Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyy-MM-dd") ?>">


        <div class="flex justify-end pt-4">
          <button type="submit" class="btn-primary w-full md:w-auto flex items-center justify-center">
            <i class="fas fa-paper-plane mr-2"></i> Submit Application
          </button>
        </div>
      </form>
    </section>

    <!-- Administrator Dashboard View -->
    <section id="admin-dashboard-view" class="hidden w-full max-w-7xl mx-auto">
      <h2 class="text-3xl font-bold text-gray-800 dark:text-text-dark mb-6 flex items-center">
        <span class="material-symbols-outlined mr-2">analytics</span> Applicant Dashboard
      </h2>

      <!-- Stats Cards -->
      <div id="stats-container" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
        <!-- Stats will be dynamically inserted here -->
      </div>

      <!-- Controls and Export -->
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
        <input type="text" id="search-input" placeholder="Search by name, position, or status..." class="input-field max-w-full md:max-w-md">
        <button id="export-btn" class="btn-primary flex items-center w-full md:w-auto">
          <span class="material-symbols-outlined mr-2">download</span> Export Data (CSV)
        </button>
      </div>

      <!-- Applicant Table -->
      <div class="overflow-x-auto bg-white dark:bg-card-dark shadow-xl rounded-xl">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-border-dark">
          <thead class="bg-gray-50 dark:bg-card-dark/50">
            <tr>
              <th class="table-header-cell">Name</th>
              <th class="table-header-cell">Position</th>
              <th class="table-header-cell">Status</th>
              <th class="table-header-cell">Email / Phone</th>
              <th class="table-header-cell">Date Applied</th>
              <th class="table-header-cell">Resume</th>
              <th class="table-header-cell">Actions</th>
            </tr>
          </thead>
          <tbody id="applicant-table-body" class="divide-y divide-gray-200 dark:divide-border-dark">
            <!-- Data will be dynamically inserted here -->
          </tbody>
        </table>
        <div id="no-applicants-message" class="p-6 text-center text-gray-500 dark:text-gray-400 hidden">No applicants found.</div>
      </div>
    </section>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-gray-900 opacity-50 dark:bg-bg-dark dark:opacity-70" onclick="closeEditModal()"></div>
        <div class="bg-white dark:bg-card-dark rounded-xl shadow-2xl p-6 w-full max-w-2xl transform transition-all duration-300 scale-100 relative">
            <h3 class="text-2xl font-semibold mb-6 text-gray-900 dark:text-text-dark">Edit Applicant Details</h3>
            <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-text-dark">
                <span class="material-symbols-outlined">close</span>
            </button>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-row-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                      <label for="edit-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                      <input type="text" id="edit-name" class="input-field" disabled>
                  </div>
                  <div>
                      <label for="edit-position-applied" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Position Applied</label>
                      <select id="edit-position-applied" name="positionApplied" class="input-field">
                        <option value="Customer Service Representative">Customer Service Representative</option>
                        <option value="Technical Support Specialist">Technical Support Specialist</option>
                        <option value="Sales Agent">Sales Agent</option>
                        <option value="Team Leader">Team Leader</option>
                        <option value="IT Support">IT Support</option>
                        <option value="Other">Other</option>
                      </select>
                  </div>
                  <div>
                      <label for="edit-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                      <select id="edit-status" name="status" class="input-field">
                          <option value="New Applicant">New Applicant</option>
                          <option value="Interview Stage">Interview Stage</option>
                          <option value="Offer Stage">Offer Stage</option>
                          <option value="Hired">Hired</option>
                          <option value="Rejected">Rejected</option>
                      </select>
                  </div>
                  <div>
                      <label for="edit-account" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Account / Team</label>
                      <input type="text" id="edit-account" name="account" class="input-field">
                  </div>
                  <div>
                      <label for="edit-final-interview" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Final Interview Date (YYYY-MM-DD)</label>
                      <input type="date" id="edit-final-interview" name="finalInterview" class="input-field">
                  </div>
                  <div>
                      <label for="edit-client-interview" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Client Interview Date (YYYY-MM-DD)</label>
                      <input type="date" id="edit-client-interview" name="clientInterview" class="input-field">
                  </div>
                </div>
                <div>
                    <label for="edit-comment" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Admin Comment / Notes</label>
                    <textarea id="edit-comment" name="comment" rows="3" class="input-field"></textarea>
                </div>
                <div class="flex justify-end pt-4 space-x-3">
                    <button type="button" onclick="closeEditModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

  </main>

  <script>
    // Global state
    let currentView = 'form'; // 'form' or 'dashboard'
    let allApplicants = [];
    const APP_VERSION = '1.0.0';

    // =========================================================================
    // UI HELPER FUNCTIONS (Message Box, Loading, Theme)
    // =========================================================================

    /**
     * Shows a custom message box instead of window.alert/confirm.
     * @param {string} title - The title of the box.
     * @param {string} body - The message body.
     * @param {boolean} isConfirmation - If true, shows a Cancel button.
     * @returns {Promise<boolean>} Resolves true for OK, false/cancel.
     */
    function customMessageBox(title, body, isConfirmation = false) {
      return new Promise(resolve => {
        const modal = document.getElementById('message-box');
        document.getElementById('message-title').textContent = title;
        document.getElementById('message-body').textContent = body;
        const okBtn = document.getElementById('message-ok');
        const cancelBtn = document.getElementById('message-cancel');

        okBtn.onclick = () => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          resolve(true);
        };

        if (isConfirmation) {
          cancelBtn.classList.remove('hidden');
          cancelBtn.onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            resolve(false);
          };
        } else {
          cancelBtn.classList.add('hidden');
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      });
    }

    /**
     * Shows the loading overlay with a custom message.
     * @param {string} message - The message to display.
     */
    function showLoading(message = 'Processing request...') {
      document.getElementById('loading-message').textContent = message;
      document.getElementById('loading-overlay').classList.remove('hidden');
      document.getElementById('loading-overlay').classList.add('flex');
    }

    /**
     * Hides the loading overlay.
     */
    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
      document.getElementById('loading-overlay').classList.remove('flex');
    }

    /**
     * Toggles between light and dark mode and saves preference.
     */
    function toggleTheme() {
      const isDarkMode = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    }

    /**
     * Initializes the theme based on user preference or system default.
     */
    function initTheme() {
      const storedTheme = localStorage.getItem('theme');
      if (storedTheme === 'dark' || (!storedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    }

    // =========================================================================
    // CORE APP LOGIC (View Toggling, Form Submission, Dashboard)
    // =========================================================================

    /**
     * Toggles between the applicant form and the admin dashboard.
     */
    function toggleView() {
      currentView = currentView === 'form' ? 'dashboard' : 'form';
      const formView = document.getElementById('applicant-form-view');
      const dashboardView = document.getElementById('admin-dashboard-view');
      const viewIcon = document.getElementById('view-icon');

      if (currentView === 'dashboard') {
        formView.classList.add('hidden');
        dashboardView.classList.remove('hidden');
        viewIcon.textContent = 'list_alt'; // Icon for form/list view
        fetchApplicantsData();
      } else {
        dashboardView.classList.add('hidden');
        formView.classList.remove('hidden');
        viewIcon.textContent = 'dashboard'; // Icon for dashboard/stats view
      }
    }

    /**
     * Event listener for the form submission.
     * @param {Event} e - The submit event.
     */
    async function handleFormSubmit(e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => data[key] = value);

      const fileInput = document.getElementById('resume');
      const file = fileInput.files[0];

      if (!file) {
        await customMessageBox('Error', 'Please upload a resume file.', false);
        return;
      }

      // Check file size and type (Client-side validation)
      if (file.size > 5 * 1024 * 1024) { // 5MB limit
        document.getElementById('file-error').textContent = 'File size exceeds 5MB limit.';
        document.getElementById('file-error').classList.remove('hidden');
        return;
      }
      if (file.type !== 'application/pdf') {
        document.getElementById('file-error').textContent = 'Only PDF files are allowed.';
        document.getElementById('file-error').classList.remove('hidden');
        return;
      }
      document.getElementById('file-error').classList.add('hidden');

      showLoading('Uploading resume and submitting application...');

      // Read file as Base64 for transport to Apps Script
      const reader = new FileReader();
      reader.onloadend = function() {
        const fileData = reader.result.split(',')[1];
        
        // Call Apps Script backend function
        google.script.run
          .withSuccessHandler(async (response) => {
            hideLoading();
            if (response.success) {
              await customMessageBox('Success!', 'Your application has been submitted successfully. Thank you!', false);
              form.reset(); // Clear the form
            } else {
              await customMessageBox('Submission Failed', 'An error occurred: ' + response.message, false);
            }
          })
          .withFailureHandler(async (error) => {
            hideLoading();
            await customMessageBox('System Error', 'An error occurred during submission: ' + error.message, false);
          })
          .submitApplication(data, fileData, file.name);
      };
      reader.readAsDataURL(file);
    }

    /**
     * Fetches all applicant data and statistics for the dashboard.
     */
    function fetchApplicantsData() {
      showLoading('Loading applicant data...');

      google.script.run
        .withSuccessHandler((response) => {
          hideLoading();
          if (response.success) {
            allApplicants = response.data;
            renderApplicantTable(allApplicants);
          } else {
            customMessageBox('Data Error', 'Could not load applicant data: ' + response.message, false);
            renderApplicantTable([]);
          }
        })
        .withFailureHandler((error) => {
          hideLoading();
          customMessageBox('Network Error', 'Failed to connect to backend: ' + error.message, false);
          renderApplicantTable([]);
        })
        .getAllApplicants();

      // Also fetch stats
      google.script.run
        .withSuccessHandler(renderStats)
        .withFailureHandler((error) => {
          console.error('Failed to load stats:', error);
        })
        .getStatistics();
    }

    // =========================================================================
    // DASHBOARD RENDERING & INTERACTION
    // =========================================================================

    /**
     * Renders the statistics cards.
     * @param {object} stats - The statistics object from the backend.
     */
    function renderStats(stats) {
      if (!stats.success) return;

      const container = document.getElementById('stats-container');
      container.innerHTML = '';
      
      const statCards = [
        { title: 'Total Applicants', icon: 'group', value: stats.total, color: 'primary-applicant' },
        { title: 'New Applicants', icon: 'person_add', value: stats.byStatus['New Applicant'] || 0, color: 'brand-accent' },
        { title: 'Hired', icon: 'military_tech', value: stats.byStatus['Hired'] || 0, color: 'emerald' },
        { title: 'Interview Stage', icon: 'pending_actions', value: stats.byStatus['Interview Stage'] || 0, color: 'yellow' }
      ];

      statCards.forEach(card => {
        const cardHtml = `
          <div class="bg-white dark:bg-card-dark p-4 rounded-xl shadow-lg border-t-4 border-${card.color}-500 dark:border-${card.color}-400">
            <div class="flex items-center">
              <span class="material-symbols-outlined text-4xl text-${card.color}-500 mr-4 dark:text-${card.color}-400">${card.icon}</span>
              <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">${card.title}</p>
                <p class="text-3xl font-bold text-gray-900 dark:text-text-dark">${card.value}</p>
              </div>
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', cardHtml);
      });
    }

    /**
     * Renders the main applicant data table.
     * @param {Array<object>} applicants - Array of applicant objects.
     * @param {string} filterText - Optional filter string.
     */
    function renderApplicantTable(applicants, filterText = '') {
      const tableBody = document.getElementById('applicant-table-body');
      const noApplicantsMessage = document.getElementById('no-applicants-message');
      tableBody.innerHTML = '';

      const filteredApplicants = applicants.filter(app => {
        if (!filterText) return true;
        const search = filterText.toLowerCase();
        return (
          app.firstName.toLowerCase().includes(search) ||
          app.lastName.toLowerCase().includes(search) ||
          app.positionApplied.toLowerCase().includes(search) ||
          app.status.toLowerCase().includes(search) ||
          app.email.toLowerCase().includes(search)
        );
      });

      if (filteredApplicants.length === 0) {
        noApplicantsMessage.classList.remove('hidden');
        return;
      } else {
        noApplicantsMessage.classList.add('hidden');
      }

      filteredApplicants.forEach(app => {
        const statusClass = getStatusClass(app.status);

        const row = document.createElement('tr');
        row.classList.add('hover:bg-gray-50', 'dark:hover:bg-card-dark/70', 'transition-colors');
        row.innerHTML = `
          <td class="table-data-cell font-medium">${app.firstName} ${app.lastName}</td>
          <td class="table-data-cell">${app.positionApplied}</td>
          <td class="table-data-cell">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
              ${app.status}
            </span>
          </td>
          <td class="table-data-cell">
            <a href="mailto:${app.email}" class="text-primary-applicant hover:underline dark:text-brand-accent">${app.email}</a>
            <br>
            <span class="text-xs text-gray-500 dark:text-gray-400">${app.phoneNumber}</span>
          </td>
          <td class="table-data-cell">${app.dateApplied}</td>
          <td class="table-data-cell">
            ${app.resumeLink ? 
              `<a href="${app.resumeLink}" target="_blank" class="text-primary-applicant hover:underline flex items-center dark:text-brand-accent">
                <span class="material-symbols-outlined text-base mr-1">picture_as_pdf</span> View
              </a>` : 'N/A'}
          </td>
          <td class="table-data-cell text-right font-medium">
            <button onclick="openEditModal('${app.rowId}')" class="text-primary-applicant hover:text-primary-applicant-hover dark:text-brand-accent dark:hover:text-brand-dark mr-3" title="Edit Details">
              <span class="material-symbols-outlined text-lg">edit</span>
            </button>
            <button onclick="handleDeleteApplicant('${app.rowId}', '${app.firstName} ${app.lastName}')" class="text-danger hover:text-red-700" title="Delete Applicant">
              <span class="material-symbols-outlined text-lg">delete</span>
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    /**
     * Filters the table content based on search input.
     */
    function handleSearch() {
      const filterText = document.getElementById('search-input').value;
      renderApplicantTable(allApplicants, filterText);
    }

    // =========================================================================
    // ADMIN ACTIONS (Edit, Delete, Export)
    // =========================================================================

    /**
     * Opens the edit modal and populates it with applicant data.
     * @param {string} rowId - The ID of the applicant to edit.
     */
    function openEditModal(rowId) {
      const app = allApplicants.find(a => a.rowId === rowId);
      if (!app) return customMessageBox('Error', 'Applicant data not found.', false);

      document.getElementById('edit-row-id').value = rowId;
      document.getElementById('edit-name').value = `${app.firstName} ${app.lastName}`;
      document.getElementById('edit-status').value = app.status;
      document.getElementById('edit-comment').value = app.comment || '';
      document.getElementById('edit-account').value = app.account || '';
      document.getElementById('edit-final-interview').value = app.finalInterview || '';
      document.getElementById('edit-client-interview').value = app.clientInterview || '';
      document.getElementById('edit-position-applied').value = app.positionApplied;
      
      document.getElementById('edit-modal').classList.remove('hidden');
      document.getElementById('edit-modal').classList.add('flex');
    }

    /**
     * Closes the edit modal.
     */
    function closeEditModal() {
      document.getElementById('edit-modal').classList.add('hidden');
      document.getElementById('edit-modal').classList.remove('flex');
    }

    /**
     * Handles the form submission for the edit modal.
     * @param {Event} e - The submit event.
     */
    function handleEditSubmit(e) {
      e.preventDefault();
      
      const rowId = document.getElementById('edit-row-id').value;
      const status = document.getElementById('edit-status').value;
      const comment = document.getElementById('edit-comment').value;
      const account = document.getElementById('edit-account').value;
      const finalInterview = document.getElementById('edit-final-interview').value;
      const clientInterview = document.getElementById('edit-client-interview').value;
      const positionApplied = document.getElementById('edit-position-applied').value;
      
      const updates = {
          status,
          comment,
          account,
          finalInterview,
          clientInterview,
          positionApplied
      };

      closeEditModal();
      showLoading('Saving changes...');

      google.script.run
        .withSuccessHandler(async (response) => {
          hideLoading();
          if (response.success) {
            await customMessageBox('Saved', response.message, false);
            fetchApplicantsData(); // Refresh data
          } else {
            await customMessageBox('Update Failed', response.message, false);
          }
        })
        .withFailureHandler(async (error) => {
          hideLoading();
          await customMessageBox('System Error', 'Update failed: ' + error.message, false);
        })
        .updateApplicant(rowId, updates);
    }

    /**
     * Handles the deletion of an applicant after confirmation.
     * @param {string} rowId - The ID of the applicant to delete.
     * @param {string} name - The name of the applicant for confirmation message.
     */
    async function handleDeleteApplicant(rowId, name) {
      const confirmed = await customMessageBox(
        'Confirm Deletion',
        `Are you sure you want to permanently delete the application for ${name}? This action cannot be undone.`,
        true
      );

      if (confirmed) {
        showLoading('Deleting applicant...');
        google.script.run
          .withSuccessHandler(async (response) => {
            hideLoading();
            if (response.success) {
              await customMessageBox('Deleted', response.message, false);
              fetchApplicantsData(); // Refresh data
            } else {
              await customMessageBox('Deletion Failed', response.message, false);
            }
          })
          .withFailureHandler(async (error) => {
            hideLoading();
            await customMessageBox('System Error', 'Deletion failed: ' + error.message, false);
          })
          .deleteApplicant(rowId);
      }
    }

    /**
     * Exports all applicant data to a CSV file.
     */
    function handleExportCSV() {
      showLoading('Generating CSV file...');

      google.script.run
        .withSuccessHandler(async (response) => {
          hideLoading();
          if (response.success && response.csv) {
            const csvData = atob(response.csv); // Decode Base64
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            // Create a temporary link and click it to trigger download
            const a = document.createElement('a');
            a.href = url;
            a.download = `applicants_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
          } else if (response.success && !response.csv) {
             await customMessageBox('Export Complete', 'No data to export.', false);
          }
          else {
             await customMessageBox('Export Error', 'Error exporting data: ' + response.message, false);
          }
        })
        .withFailureHandler(async (error) => {
          hideLoading();
          await customMessageBox('Export Failed', 'Export failed: ' + error.message, false);
        })
        .exportToCSV();
    }

    // =========================================================================
    // INITIALIZATION & HELPERS
    // =========================================================================
    
    /**
     * Helper to get Tailwind classes for status badges.
     * @param {string} status - The applicant status.
     * @returns {string} Tailwind CSS classes.
     */
    function getStatusClass(status) {
      // Define colors based on the status in a map
      const statusMap = {
        'New Applicant': 'bg-primary-applicant/10 text-primary-applicant dark:bg-primary-applicant/30 dark:text-blue-200',
        'Interview Stage': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
        'Offer Stage': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
        'Hired': 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200',
        'Rejected': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
      };
      return statusMap[status] || 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
    }


    /**
     * Runs once the page is fully loaded.
     */
    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      
      // Setup form listeners
      document.getElementById('applicant-form').addEventListener('submit', handleFormSubmit);
      document.getElementById('edit-form').addEventListener('submit', handleEditSubmit);

      // Setup dashboard listeners
      document.getElementById('search-input').addEventListener('input', handleSearch);
      document.getElementById('export-btn').addEventListener('click', handleExportCSV);
    });
  </script>
</body>
</html>