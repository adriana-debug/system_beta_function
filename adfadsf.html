<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Knowledge Hub - SOPs & Tutorials</title>

<script src="https://cdn.tailwindcss.com"></script>
<script>
Â  tailwind.config = {
Â  Â  darkMode: 'media',
Â  Â  theme: {
Â  Â  Â  extend: {
Â  Â  Â  Â  // Using a strong blue accent and deep slate dark mode background
Â  Â  Â  Â  colors: { 
            brandAccent: '#3b82f6', // blue-500
            brandDark: '#0f172a' // slate-900
        },
Â  Â  Â  Â  fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
Â  Â  Â  }
Â  Â  }
Â  }
</script>

<style>
/* --------------------
Â  Â Base layout & utilities
Â  Â -------------------- */
html, body {height:100%;margin:0;font-size:11pt;}
body {display:flex;flex-direction:column;min-height:100vh;}
main {flex:1 0 auto;}
footer {flex-shrink:0;}

/* Custom table styling for compactness and neatness */
.data-table {
Â  width: 100%;
Â  border-collapse: collapse;
Â  table-layout: auto;
}
.data-table th {
Â  padding: 0.75rem 1rem;
Â  text-align: left;
Â  font-weight: 600;
Â  font-size: 0.75rem;
Â  text-transform: uppercase;
Â  letter-spacing: 0.05em;
Â  color: #4b5563; /* gray-600 */
Â  background: #f9fafb; /* gray-50 */
}
.data-table td {
Â  padding: 0.75rem 1rem; /* Slightly reduced padding */
Â  text-align: left;
Â  font-size: 0.875rem; /* sm */
Â  border-bottom: 1px solid #e5e7eb; /* gray-200 */
}
.data-table tbody tr:last-child td {
Â  border-bottom: none;
}
.data-table tbody tr:hover {
Â  background: #f3f4f6; /* gray-100 hover */
}

/* Compact action buttons */
.action-btn {
Â  padding: 0.25rem 0.5rem; /* Very compact */
Â  font-size: 0.75rem;
Â  border-radius: 0.375rem;
Â  border: 1px solid;
Â  transition: all 0.2s ease;
Â  cursor: pointer;
Â  font-weight: 500;
}
.action-btn-view { border-color: #9ca3af; color: #4b5563; background: white; }
.action-btn-view:hover { background: #f3f4f6; }
.action-btn-edit { border-color: #3b82f6; color: #3b82f6; background: #eff6ff; /* blue-50 */ }
.action-btn-edit:hover { background: #dbeafe; }
.action-btn-delete { border-color: #fca5a5; color: #dc2626; background: #fee2e2; /* red-50 */ }
.action-btn-delete:hover { background: #fecaca; }


/* Global loader */
#globalLoader {
Â  display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);
Â  z-index:60;align-items:center;justify-content:center;backdrop-filter:blur(2px);
}
.spinner {
Â  width:45px;height:45px;border:4px solid #eee;border-top:4px solid #3b82f6;
Â  border-radius:50%;animation:spin 1s linear infinite;
}
@keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

/* Simple in-place editor used for KB (contenteditable) */
.editor { 
Â  min-height: 240px; 
Â  border: 1px solid #e5e7eb; 
Â  padding: .75rem; 
Â  border-radius: .5rem; 
Â  background: white; 
Â  box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
}
.editor:focus { 
Â  outline: 3px solid rgba(59,130,246,.12); 
Â  border-color: #3b82f6;
}

/* --------------------
Â  Â Document preview & print styles (A4/Letter friendly)
Â  Â -------------------- */
.paper {
Â  background:#fff;
Â  width:8.27in; 
Â  height:11.69in; 
Â  margin:2rem auto;
Â  padding:0;
Â  box-shadow:0 0 8px rgba(0,0,0,0.15);
Â  border-radius: 4px;
Â  page-break-after: always;
Â  font-family: 'Calibri', 'Inter', 'Arial', sans-serif;
Â  font-size: 11pt;
Â  line-height: 1.3;
Â  color: #000;
Â  position: relative;
Â  overflow: hidden;
}
.paper.first-page {
Â  padding: 0.6in 0.75in 0.75in 0.75in; 
}
.paper.content-page {
Â  padding: 0.4in 0.75in 0.75in 0.75in;
}
.paper-content { min-height: 8.5in; max-height: 9.2in; overflow: hidden; padding-bottom: 0.6in; }

.title-header { text-align:center; border-bottom:1px solid #ccc; padding-bottom:2px; margin-bottom:0.1in; }
.title-header img { display:block; margin:0 auto 3px; width:100px; }
.title-header h1 { font-size:14pt; font-weight:bold; margin:2px 0 2px; color:#000; }
.title-details { font-size:9pt; color:#555; line-height:1.2; display:flex; justify-content:center; gap:15px; flex-wrap:wrap; }

.page-footer {
Â  position: absolute;
Â  bottom: 0.4in;
Â  left: 0.75in;
Â  right: 0.75in;
Â  padding-top: 5px;
Â  border-top: 1px solid #ccc;
Â  font-size:8pt;
Â  color:#666;
Â  display:flex; justify-content:space-between;
}

/* Print-specific rules to ensure KB preview prints only the document */
@media print {
Â  .no-print, header, nav, footer, #globalLoader, main > div:not(#kbPreviewView) { display: none !important; }
Â  body { background: none !important; padding: 0 !important; margin: 0 !important; }
Â  #kbPreviewView { display:block !important; position:static !important; width:100% !important; padding:0 !important; margin:0 !important; }
Â  #kbPreviewContainer { background:none !important; padding:0 !important; margin:0 !important; box-shadow:none !important; }
Â  .paper { margin:0 !important; box-shadow:none !important; page-break-after: always !important; width:100% !important; height:11.69in !important; }
Â  .paper.last-page { page-break-after: avoid !important; }
}
</style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">
<header class="bg-brandDark text-white shadow sticky top-0 z-50 no-print">
Â  <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  <img src="https://americanrangewalls.com/wp-content/uploads/logo-white-text-on-clear-1.png" class="w-32" alt="Logo">
Â  Â  Â  <h1 class="text-2xl font-bold">Knowledge Hub</h1>
Â  Â  </div>
Â  </div>
</header>

<nav class="bg-white border-b sticky top-[64px] z-40 no-print shadow-sm">
Â  <div class="max-w-7xl mx-auto px-6 flex space-x-6">
Â  Â  <button class="tab-btn px-4 py-3 border-b-2 border-transparent text-gray-600 hover:text-brandAccent transition" data-tab="home">Home</button>
Â  Â  <button class="tab-btn px-4 py-3 border-b-2 border-transparent text-gray-600 hover:text-brandAccent transition" data-tab="kb">Knowledge Base</button>
Â  Â  <button class="tab-btn px-4 py-3 border-b-2 border-transparent text-gray-600 hover:text-brandAccent transition" data-tab="tutorials">Tutorial Videos</button>
Â  </div>
</nav>

<main class="max-w-7xl mx-auto px-6 py-8 w-full">

Â  Â  <section id="tab-home" class="tab-content">
Â  Â  <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200">
Â  Â  Â  <h1 class="text-3xl font-bold mb-4 text-brandDark">Welcome to the Knowledge Hub ðŸ‘‹</h1>
Â  Â  Â  <p class="text-lg text-gray-600">Access **Standard Operating Procedures (SOPs)** and **Tutorial Videos** easily from one centralized, searchable location.</p>
Â  Â  </div>
Â  </section>

Â  Â  <section id="tab-kb" class="tab-content hidden">
Â  Â  Â  Â  <div id="kbListView">
Â  Â  Â  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-5 gap-4">
Â  Â  Â  Â  <div class="flex gap-3">
Â  Â  Â  Â  Â  <button id="addDocBtn" class="px-5 py-2 bg-brandAccent text-white rounded-lg font-semibold hover:bg-blue-600 transition shadow-md flex items-center gap-1">
Â  Â  Â  Â  Â  Â  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
Â  Â  Â  Â  Â  Â  New Document
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <input id="kbSearchInput" placeholder="Search Title, ID, Category..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brandAccent focus:border-brandAccent transition w-full sm:w-64" />
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
Â  Â  Â  Â  <div class="overflow-x-auto">
Â  Â  Â  Â  Â  <table class="data-table">
Â  Â  Â  Â  Â  Â  <thead class="bg-gray-100 border-b">
Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[10%]">Doc ID</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[30%]">Title</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[15%]">Category</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[15%]">Process</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[10%]">Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[20%] text-right no-print">Actions</th>
Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="kbDocsTable">
Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="6" class="text-center p-6 text-gray-500">Loading documents...</td></tr>
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="kbPreviewView" class="hidden">
Â  Â  Â  <div class="mb-6 flex justify-between items-center no-print">
Â  Â  Â  Â  <button id="kbBackBtn" class="px-5 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold transition flex items-center gap-2">
Â  Â  Â  Â  Â  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
Â  Â  Â  Â  Â  Back to List
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <h2 id="kbPreviewTitle" class="text-2xl font-bold text-brandDark truncate">Document Preview</h2>
Â  Â  Â  Â  <button id="kbPrintBtn" class="px-5 py-2 rounded-lg bg-brandAccent text-white font-semibold hover:bg-blue-600 transition shadow-md flex items-center gap-2 no-print">
Â  Â  Â  Â  Â  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
Â  Â  Â  Â  Â  Print/Download
Â  Â  Â  Â  </button>
Â  Â  Â  </div>

Â  Â  Â  <div id="kbPreviewContainer" class="bg-slate-100 p-4 sm:p-8 rounded-2xl min-h-[50vh]">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  Â  <section id="tab-tutorials" class="tab-content hidden">
Â  Â  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-5 gap-4">
Â  Â  Â  <div class="flex gap-3">
Â  Â  Â  Â  <button id="addTutBtn" class="px-5 py-2 bg-brandAccent text-white rounded-lg font-semibold hover:bg-blue-600 transition shadow-md flex items-center gap-1">
Â  Â  Â  Â  Â  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
Â  Â  Â  Â  Â  New Tutorial
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <input id="tutSearchInput" placeholder="Search Title or Description..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brandAccent focus:border-brandAccent transition w-full sm:w-64" />
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
Â  Â  Â  <div class="overflow-x-auto">
Â  Â  Â  Â  <table class="data-table">
Â  Â  Â  Â  Â  <thead class="bg-gray-100 border-b">
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[10%]">ID</th>
Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[25%]">Title</th>
Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[40%]">Description</th>
Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[10%]">Video Link</th>
Â  Â  Â  Â  Â  Â  Â  <th class="px-4 w-[15%] text-right">Actions</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="tutorialTable">
Â  Â  Â  Â  Â  Â  <tr><td colspan="5" class="text-center p-6 text-gray-500">Loading tutorials...</td></tr>
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>
</main>

<div id="kbModal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 no-print">
Â  <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-slate-200 shadow-2xl">
Â  Â  <div class="sticky top-0 bg-gray-50 border-b border-gray-200 p-6 flex justify-between items-center z-10">
Â  Â  Â  <h2 id="kbModalTitle" class="text-2xl font-bold text-brandDark">New Document</h2>
Â  Â  Â  <button type="button" id="kbCloseModal" class="text-gray-400 hover:text-brandDark hover:bg-gray-200 p-2 rounded-lg transition-all">
Â  Â  Â  Â  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <form id="kbForm" class="p-6 space-y-5">
Â  Â  Â  <div class="grid md:grid-cols-2 gap-4">
Â  Â  Â  Â  <div><label class="block text-sm font-semibold text-brandDark mb-2">Title *</label><input name="Title" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-brandAccent focus:border-brandAccent" required></div>
Â  Â  Â  Â  <div><label class="block text-sm font-semibold text-brandDark mb-2">Category</label><select name="Category" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-brandAccent focus:border-brandAccent"></select></div>
Â  Â  Â  Â  <div><label class="block text-sm font-semibold text-brandDark mb-2">Process</label><select name="Process" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-brandAccent focus:border-brandAccent"></select></div>
Â  Â  Â  Â  <div><label class="block text-sm font-semibold text-brandDark mb-2">Owner</label><select name="Owner" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-brandAccent focus:border-brandAccent"></select></div>
Â  Â  Â  Â  <div><label class="block text-sm font-semibold text-brandDark mb-2">Approved By</label><select name="Approved_By" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-brandAccent focus:border-brandAccent"></select></div>
Â  Â  Â  Â  <div><label class="block text-sm font-semibold text-brandDark mb-2">Status</label><select name="Status" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-brandAccent focus:border-brandAccent"></select></div>
Â  Â  Â  </div>

Â  Â  Â  <div>
Â  Â  Â  Â  <label class="block text-sm font-semibold text-brandDark mb-2">Document Content (HTML)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="kbPolicyEditor" class="editor" contenteditable="true"></div>
Â  Â  Â  Â  <input type="hidden" name="Policy_Body">
Â  Â  Â  </div>

Â  Â  Â  <div class="flex justify-end gap-3 pt-4">
Â  Â  Â  Â  <button type="button" id="kbCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium transition">Cancel</button>
Â  Â  Â  Â  <button type="submit" class="px-6 py-2 bg-brandAccent text-white rounded-lg font-semibold hover:bg-blue-600 transition shadow-md">Save Document</button>
Â  Â  Â  </div>
Â  Â  </form>
Â  </div>
</div>

<div id="tutorialModal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
Â  <div class="bg-white rounded-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto shadow-2xl border border-gray-200">
Â  Â  <div class="sticky top-0 p-6 border-b flex justify-between items-center bg-gray-50 z-10">
Â  Â  Â  <h2 id="tutorialModalTitle" class="text-xl font-bold text-gray-800">New Tutorial Video</h2>
Â  Â  Â  <button type="button" id="tutorialCloseModal" class="text-gray-400 hover:text-gray-600 hover:bg-gray-200 p-2 rounded-lg transition">
Â  Â  Â  Â  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
Â  Â  Â  </button>
Â  Â  </div>
Â  Â  <form id="tutorialForm" class="p-6 space-y-4">
Â  Â  Â  <input type="hidden" name="Tutorial_ID" value="">
Â  Â  Â  <div><label class="block text-sm font-semibold mb-2">Title *</label><input name="Title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brandAccent" required></div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label class="block text-sm font-semibold mb-2">Video/Drive Link (YouTube URL/Drive Link) *</label>
Â  Â  Â  Â  <input name="Drive_Link" type="url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brandAccent" required>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label class="block text-sm font-semibold mb-2">Description</label>
Â  Â  Â  Â  <textarea name="Description" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brandAccent" rows="3"></textarea>
Â  Â  Â  </div>
Â  Â  Â  <div class="grid grid-cols-2 gap-4">
Â  Â  Â  Â  <div><label class="block text-sm font-semibold mb-2">Related Doc ID</label><input name="Doc_ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brandAccent"></div>
Â  Â  Â  Â  <div><label class="block text-sm font-semibold mb-2">Created By</label><input name="Created_By" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brandAccent"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="flex justify-end gap-3 pt-4">
Â  Â  Â  Â  <button type="button" id="tutorialCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium transition">Cancel</button>
Â  Â  Â  Â  <button type="submit" class="px-6 py-2 bg-brandAccent text-white rounded-lg font-semibold hover:bg-blue-600 transition shadow-md">Save Tutorial</button>
Â  Â  Â  </div>
Â  Â  </form>
Â  </div>
</div>

<div id="globalLoader">
Â  <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center gap-2">
Â  Â  <div class="spinner"></div>
Â  Â  <p class="text-gray-700 text-sm font-medium">Loading...</p>
Â  </div>
</div>

<footer class="bg-brandDark text-white text-sm py-4 text-center mt-auto no-print">
Â  Â© 2025 Knowledge Hub | All Rights Reserved
</footer>

<script>
/* ======= Configuration ======= */
/* IMPORTANT: Replace API_URL with your Google Apps Script web app URL if different */
const API_URL = "https://script.google.com/macros/s/AKfycby0pX8Y3Oe2fC8NFePBFsso0GDwVJIVR42uMqz-X9K_yV75tgvf2-wuRxtWdIZSmK4PcQ/exec";

let kbDocs = [], tutorials = [], kbConfig = {}, editingKbDoc = null, editingTutorial = null;

/* Simple loader helper */
const showLoader = (s) => document.getElementById('globalLoader').style.display = s ? 'flex' : 'none';

/* ======= Utility helpers ======= */
function escHtml(s){
Â  if(s===null||s===undefined) return "";
Â  return String(s)
Â  Â  .replace(/&/g,'&amp;')
Â  Â  .replace(/</g,'&lt;')
Â  Â  .replace(/>/g,'&gt;')
Â  Â  .replace(/"/g,'&quot;')
Â  Â  .replace(/'/g,'&#039;');
}

/* Date formatting helper */
function formatDate(isoString) {
Â  if (!isoString) return 'N/A';
Â  try {
Â  Â  if (isoString.includes('/')) return isoString;
Â  Â  const date = new Date(isoString);
Â  Â  if (isNaN(date)) return isoString;
Â  Â  const month = String(date.getMonth() + 1).padStart(2, '0');
Â  Â  const day = String(date.getDate()).padStart(2, '0');
Â  Â  const year = date.getFullYear();
Â  Â  const hours = String(date.getHours()).padStart(2, '0');
Â  Â  const minutes = String(date.getMinutes()).padStart(2, '0');
Â  Â  return `${month}/${day}/${year} ${hours}:${minutes}`;
Â  } catch(e) {
Â  Â  return isoString;
Â  }
}

/* Status badge helper (Updated to use Tailwind classes for pill design) */
function statusBadge(status) {
Â  const s = (status || '').toLowerCase();
Â  let cls = 'bg-gray-200 text-gray-800';
Â  if (s === 'active') cls = 'bg-green-100 text-green-800';
Â  else if (s === 'pending review') cls = 'bg-yellow-100 text-yellow-800';
Â  else if (s === 'draft') cls = 'bg-gray-100 text-gray-600';
Â  else if (s === 'archived') cls = 'bg-red-100 text-red-800';
Â  return `<span class="px-2.5 py-0.5 rounded-full text-xs font-semibold ${cls} inline-block">${escHtml(status || 'N/A')}</span>`;
}


/* ======= Tabs ======= */
document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
function switchTab(tab){
Â  document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
Â  const el = document.getElementById('tab-' + tab);
Â  if (el) el.classList.remove('hidden');

Â  document.querySelectorAll('.tab-btn').forEach(b => {
Â  Â  b.classList.remove('text-brandAccent','border-brandAccent');
Â  Â  b.classList.add('border-transparent', 'text-gray-600');
Â  });
Â  const activeBtn = document.querySelector(`[data-tab="${tab}"]`);
Â  if (activeBtn) { activeBtn.classList.add('text-brandAccent','border-brandAccent'); activeBtn.classList.remove('border-transparent', 'text-gray-600'); }

Â  // lazy-load data when tabs first activated
Â  if(tab === 'kb' && kbDocs.length === 0){ loadKbConfig(); loadKbDocs(); }
Â  if(tab === 'tutorials' && tutorials.length === 0){ loadTutorials(); }
}

/* Default open home on load */
switchTab('home');

/* ======= KB Config & Select population ======= */
async function loadKbConfig(){
Â  try {
Â  Â  const res = await fetch(API_URL + "?config=1");
Â  Â  if (!res.ok) throw new Error("Config fetch failed");
Â  Â  kbConfig = await res.json();
Â  } catch(err) {
Â  Â  kbConfig = {
Â  Â  Â  DEFAULT_OWNER_LIST:["CEO","COO","HR Manager"],
Â  Â  Â  CATEGORIES_LIST:["Process","Technical","Training"],
Â  Â  Â  PROCESS_LIST:["Operations","Quality","Production"],
Â  Â  Â  DEFAULT_APPROVER_LIST:["CEO","Director"],
Â  Â  Â  DEFAULT_STATUS_LIST:["Draft","Active","Archived"]
Â  Â  };
Â  }
Â  populateKbSelects();
}

function populateKbSelects(){
Â  const lists = {
Â  Â  Category: kbConfig.CATEGORIES_LIST,
Â  Â  Process: kbConfig.PROCESS_LIST,
Â  Â  Owner: kbConfig.DEFAULT_OWNER_LIST,
Â  Â  Approved_By: kbConfig.DEFAULT_APPROVER_LIST,
Â  Â  Status: kbConfig.DEFAULT_STATUS_LIST
Â  };
Â  const form = document.getElementById('kbForm');
Â  for (const name in lists){
Â  Â  const sel = form.elements[name];
Â  Â  if (!sel || !lists[name]) continue;
Â  Â  sel.innerHTML = "";
Â  Â  lists[name].forEach(v => {
Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  opt.value = v; opt.text = v;
Â  Â  Â  sel.appendChild(opt);
Â  Â  });
Â  }
}

/* ======= KB CRUD & List Rendering ======= */
async function loadKbDocs(){
Â  showLoader(true);
Â  try {
Â  Â  const res = await fetch(API_URL);
Â  Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â  Â  kbDocs = await res.json();
Â  Â  renderKB();
Â  } catch(e) {
Â  Â  console.error(e);
Â  Â  document.getElementById('kbDocsTable').innerHTML = `<tr><td colspan="6" class="text-center p-6 text-red-600">Error: ${e.message}</td></tr>`;
Â  }
Â  showLoader(false);
}

function renderKB(){
Â  const q = (document.getElementById('kbSearchInput').value || '').toLowerCase();
Â  const tbody = document.getElementById('kbDocsTable');
Â  const f = kbDocs.filter(r =>
Â  Â  !q ||
Â  Â  (r.Title||'').toLowerCase().includes(q) ||
Â  Â  (r.Category||'').toLowerCase().includes(q) ||
Â  Â  (r.Process||'').toLowerCase().includes(q) ||
Â  Â  (r.Doc_ID||'').toLowerCase().includes(q)
Â  );

Â  tbody.innerHTML = f.length ? f.map(r => `
Â  Â  <tr class="hover:bg-gray-50 transition-colors">
Â  Â  Â  <td class="font-medium text-gray-700">${escHtml(r.Doc_ID||'')}</td>
Â  Â  Â  <td class="truncate">${escHtml(r.Title||'')}</td>
Â  Â  Â  <td>${escHtml(r.Category||'')}</td>
Â  Â  Â  <td>${escHtml(r.Process||'')}</td>
Â  Â  Â  <td>${statusBadge(r.Status)}</td>
Â  Â  Â  <td class="text-right space-x-2 no-print">
Â  Â  Â  Â  <button class="view action-btn action-btn-view">View</button>
Â  Â  Â  Â  <button class="edit action-btn action-btn-edit">Edit</button>
Â  Â  Â  Â  <button class="del action-btn action-btn-delete">Delete</button>
Â  Â  Â  </td>
Â  Â  </tr>`).join('') : `<tr><td colspan="6" class="text-center p-4 text-gray-500">No records found.</td></tr>`;

Â  tbody.querySelectorAll('.view').forEach((b,i) => b.onclick = () => openKbPreview(f[i]));
Â  tbody.querySelectorAll('.edit').forEach((b,i) => b.onclick = () => openKbEdit(f[i]));
Â  tbody.querySelectorAll('.del').forEach((b,i) => b.onclick = () => deleteKB(f[i]));
}

/* KB search input */
document.getElementById('kbSearchInput').addEventListener('input', renderKB);


/* ======= KB Preview (Print-ready, pagination split logic is retained) ======= */
function openKbPreview(d){
Â  document.getElementById('kbListView').classList.add('hidden');
Â  document.getElementById('kbPreviewView').classList.remove('hidden');

Â  const container = document.getElementById('kbPreviewContainer');
Â  container.innerHTML = "";
Â  document.getElementById('kbPreviewTitle').textContent = d.Title || "Document Preview";

Â  let bodyHtml = d.Policy_Body && d.Policy_Body.trim() ? d.Policy_Body : "<p><em>No content available</em></p>";
Â  const pages = splitIntoPages(bodyHtml, d);

Â  pages.forEach((pageContent, index) => {
Â  Â  const page = document.createElement('div');
Â  Â  page.className = index === 0 ? "paper first-page" : (index === pages.length - 1 ? "paper content-page last-page" : "paper content-page");
Â  Â  let pageHtml = "";

Â  Â  if (index === 0) {
Â  Â  Â  pageHtml = `
Â  Â  Â  Â  <header class="title-header">
Â  Â  Â  Â  Â  <img src="https://americanrangewalls.com/wp-content/uploads/logo-white-text-on-clear-1.png" alt="Logo">
Â  Â  Â  Â  Â  <h1>${escHtml(d.Title || "Untitled")}</h1>
Â  Â  Â  Â  Â  <div class="title-details">
Â  Â  Â  Â  Â  Â  <span>ID: ${escHtml(d.Doc_ID||'N/A')}</span> |
Â  Â  Â  Â  Â  Â  <span>Category: ${escHtml(d.Category||'N/A')}</span> |
Â  Â  Â  Â  Â  Â  <span>Process: ${escHtml(d.Process||'N/A')}</span> |
Â  Â  Â  Â  Â  Â  <span>Status: ${escHtml(d.Status||'N/A')}</span>
Â  Â  Â  Â  Â  Â  ${d.Version?`| <span>Ver: ${escHtml(d.Version)}</span>`:''}
Â  Â  Â  Â  Â  Â  ${d.Last_Updated?`| <span>Updated: ${formatDate(d.Last_Updated)}</span>`:''}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>
Â  Â  Â  `;
Â  Â  } else {
Â  Â  Â  pageHtml = `
Â  Â  Â  Â  <header style="display:flex;align-items:center;justify-content:space-between;padding-bottom:4px;margin-bottom:0.15in;border-bottom:1px solid #333;height:0.3in;">
Â  Â  Â  Â  Â  <div style="font-size:8pt;font-weight:bold;color:#333;">${escHtml(d.Title || "Untitled")}</div>
Â  Â  Â  Â  Â  <img src="https://americanrangewalls.com/wp-content/uploads/logo-white-text-on-clear-1.png" style="width:60px;">
Â  Â  Â  Â  </header>
Â  Â  Â  `;
Â  Â  }

Â  Â  pageHtml += `<div class="paper-content">${pageContent}</div>`;
Â  Â  pageHtml += `
Â  Â  Â  <footer class="page-footer">
Â  Â  Â  Â  <span>Doc ID: ${escHtml(d.Doc_ID||'N/A')}</span>
Â  Â  Â  Â  <span>Page ${index+1} of ${pages.length}</span>
Â  Â  Â  Â  <span>${formatDate(new Date().toISOString())}</span>
Â  Â  Â  </footer>
Â  Â  `;
Â  Â  page.innerHTML = pageHtml;
Â  Â  container.appendChild(page);
Â  });
}

/* Splitting content into page-sized chunks (retained logic) */
function splitIntoPages(htmlContent, d){
Â  const DPI = 96;
Â  const CONTENT_WIDTH = 6.77 * DPI;
Â  const REGULAR_PAGE_MAX_H = 9.2 * DPI;
Â  const FIRST_PAGE_HEADER_H = 1.6 * DPI;
Â  const FIRST_PAGE_MAX_H = REGULAR_PAGE_MAX_H - FIRST_PAGE_HEADER_H;

Â  const tempContainer = document.createElement('div');
Â  tempContainer.style.cssText = `
Â  Â  position:absolute;visibility:hidden;width:${CONTENT_WIDTH}px;
Â  Â  font-family:'Calibri','Inter','Arial',sans-serif;
Â  Â  font-size:11pt;line-height:1.3;box-sizing:border-box;
Â  Â  overflow:hidden;padding:0;margin:0;
Â  `;
Â  document.body.appendChild(tempContainer);

Â  const contentEl = document.createElement('div');
Â  contentEl.innerHTML = htmlContent.trim();
Â  if(!contentEl.children.length){
Â  Â  document.body.removeChild(tempContainer);
Â  Â  return [htmlContent || ""];
Â  }

Â  const elements = Array.from(contentEl.children);
Â  const pages = [];
Â  let currentPageElements = [];
Â  let maxHeight = FIRST_PAGE_MAX_H;

Â  for(let i=0; i<elements.length; i++){
Â  Â  const el = elements[i];
Â  Â  const trialElements = [...currentPageElements, el];
Â  Â  tempContainer.innerHTML = trialElements.map(e => e.outerHTML).join('');
Â  Â  const trialHeight = tempContainer.scrollHeight;

Â  Â  if(trialHeight > maxHeight && currentPageElements.length > 0){
Â  Â  Â  pages.push(currentPageElements.map(e => e.outerHTML).join(''));
Â  Â  Â  currentPageElements = [el];
Â  Â  Â  maxHeight = REGULAR_PAGE_MAX_H;
Â  Â  Â  tempContainer.innerHTML = el.outerHTML;
Â  Â  Â  if(tempContainer.scrollHeight > maxHeight){
Â  Â  Â  Â  pages.push(el.outerHTML);
Â  Â  Â  Â  currentPageElements = [];
Â  Â  Â  }
Â  Â  } else if(trialHeight > maxHeight && currentPageElements.length === 0){
Â  Â  Â  pages.push(el.outerHTML);
Â  Â  Â  currentPageElements = [];
Â  Â  Â  maxHeight = REGULAR_PAGE_MAX_H;
Â  Â  } else {
Â  Â  Â  currentPageElements = trialElements;
Â  Â  }
Â  }

Â  if(currentPageElements.length > 0) pages.push(currentPageElements.map(e => e.outerHTML).join(''));
Â  document.body.removeChild(tempContainer);
Â  return pages.length > 0 ? pages : [htmlContent];
}


/* ======= KB Edit/Delete/Form handling (retained logic) ======= */
function openKbEdit(d) {
Â  editingKbDoc = d || {};
Â  const modal = document.getElementById('kbModal');
Â  const form = document.getElementById('kbForm');
Â  const editor = document.getElementById('kbPolicyEditor');

Â  if (!form || !modal) return;

Â  document.getElementById('kbModalTitle').textContent = d ? "Edit Document" : "New Document";

Â  ["Title", "Category", "Process", "Owner", "Approved_By", "Status"].forEach(k => {
Â  Â  if (form.elements[k]) form.elements[k].value = d[k] || "";
Â  });

Â  if (!d.Doc_ID && d.id) d.Doc_ID = d.id;

Â  const content = d.Policy_Body || d.policy_body || d.Body || "";
Â  editor.innerHTML = content.trim() || "<p>Enter document content here...</p>";

Â  modal.classList.remove('hidden');
}

async function deleteKB(r){
Â  if(!confirm(`Are you sure you want to delete "${r.Title}"?`)) return;
Â  showLoader(true);
Â  try {
Â  Â  const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({_method:'DELETE', Doc_ID: r.Doc_ID, id: r.Doc_ID}) });
Â  Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â  Â  const result = await res.json();
Â  Â  if (result.success === false) throw new Error(result.error || "Delete failed");
Â  Â  await loadKbDocs();
Â  Â  alert('Document deleted successfully.');
Â  } catch(err) {
Â  Â  console.error(err);
Â  Â  alert("Error deleting document: " + err.message);
Â  }
Â  showLoader(false);
}

document.getElementById('addDocBtn').onclick = () => {
Â  editingKbDoc = null;
Â  document.getElementById('kbModalTitle').textContent = "New Document";
Â  document.getElementById('kbForm').reset();
Â  document.getElementById('kbPolicyEditor').innerHTML = "<p>Enter document content here...</p>";
Â  document.getElementById('kbModal').classList.remove('hidden');
};

document.getElementById('kbCloseModal').onclick = () => { document.getElementById('kbModal').classList.add('hidden'); editingKbDoc = null; };
document.getElementById('kbCancelBtn').onclick = () => { document.getElementById('kbModal').classList.add('hidden'); editingKbDoc = null; };
document.getElementById('kbBackBtn').onclick = () => {
Â  document.getElementById('kbPreviewView').classList.add('hidden');
Â  document.getElementById('kbListView').classList.remove('hidden');
};
document.getElementById('kbPrintBtn').onclick = () => { window.print(); };

document.getElementById('kbForm').onsubmit = async (e) => {
Â  e.preventDefault();
Â  const formEl = e.target;
Â  formEl.elements["Policy_Body"].value = document.getElementById('kbPolicyEditor').innerHTML;

Â  const data = Object.fromEntries(new FormData(formEl).entries());

if (editingKbDoc) {
Â  const docId = editingKbDoc.Doc_ID || editingKbDoc.id || editingKbDoc.ID;
Â  if (!docId) {
Â  Â  alert("Error: Missing document ID for update.");
Â  Â  showLoader(false);
Â  Â  return;
Â  }
Â  data._method = "PUT";
Â  data.id = docId;
Â  data.Doc_ID = docId;
}


Â  try {
Â  Â  showLoader(true);
Â  Â  const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(data) });
Â  Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â  Â  const result = await res.json();
Â  Â  if (result.success === false) throw new Error(result.error || "Save failed");

Â  Â  document.getElementById('kbModal').classList.add('hidden');
Â  Â  editingKbDoc = null;
Â  Â  await loadKbDocs();
Â  Â  alert(data._method === "PUT" ? "Document updated successfully!" : "Document created successfully!");
Â  } catch(err) {
Â  Â  console.error("Save error:", err);
Â  Â  alert("Error saving document: " + err.message);
Â  } finally {
Â  Â  showLoader(false);
Â  }
};


/* ======= Tutorials CRUD (retained logic) ======= */
async function loadTutorials(){
Â  showLoader(true);
Â  try {
Â  Â  const res = await fetch(API_URL + '?tutorials=1');
Â  Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â  Â  const data = await res.json();
Â  Â  tutorials = data;
Â  Â  renderTutorials();
Â  } catch(e) {
Â  Â  document.getElementById('tutorialTable').innerHTML = `<tr><td colspan="5" class="text-center p-6 text-red-600">Error loading tutorials.</td></tr>`;
Â  }
Â  showLoader(false);
}

function renderTutorials(){
Â  const q = (document.getElementById('tutSearchInput').value || '').toLowerCase();
Â  const tbody = document.getElementById('tutorialTable');
Â  const f = tutorials.filter(r => (r.Title||'').toLowerCase().includes(q) || (r.Description||'').toLowerCase().includes(q));

Â  tbody.innerHTML = f.length ? f.map(r => `
Â  Â  <tr class="hover:bg-gray-50 transition-colors">
Â  Â  Â  <td class="font-medium text-gray-700">${escHtml(r.Tutorial_ID||'')}</td>
Â  Â  Â  <td class="truncate">${escHtml(r.Title||'')}</td>
Â  Â  Â  <td class="truncate">${escHtml(r.Description||'')}</td>
Â  Â  Â  <td><a href="${escHtml(r.Video_URL||r.Drive_Link||'#')}" target="_blank" class="text-brandAccent underline hover:text-blue-700">Open Link</a></td>
Â  Â  Â  <td class="text-right space-x-2">
Â  Â  Â  Â  <button class="edit action-btn action-btn-edit">Edit</button>
Â  Â  Â  Â  <button class="del action-btn action-btn-delete">Delete</button>
Â  Â  Â  </td>
Â  Â  </tr>`).join('') : `<tr><td colspan="5" class="text-center p-4 text-gray-500">No tutorials found.</td></tr>`;

Â  tbody.querySelectorAll('.edit').forEach((b,i) => b.onclick = () => editTut(f[i]));
Â  tbody.querySelectorAll('.del').forEach((b,i) => b.onclick = () => deleteTut(f[i]));
}

function handleAddTut(){
Â  editingTutorial = null;
Â  document.getElementById('tutorialModalTitle').textContent = "New Tutorial Video";
Â  document.getElementById('tutorialForm').reset();
Â  document.getElementById('tutorialForm').elements["Tutorial_ID"].value = "";
Â  document.getElementById('tutorialModal').classList.remove('hidden');
}

function editTut(r){
Â  editingTutorial = r;
Â  document.getElementById('tutorialModalTitle').textContent = "Edit Tutorial Video";
Â  const form = document.getElementById('tutorialForm');

Â  form.elements["Tutorial_ID"].value = r.Tutorial_ID || '';
Â  form.elements["Title"].value = r.Title || '';
Â  form.elements["Drive_Link"].value = r.Video_URL || r.Drive_Link || '';
Â  form.elements["Description"].value = r.Description || '';
Â  form.elements["Doc_ID"].value = r.Doc_ID || '';
Â  form.elements["Created_By"].value = r.Created_By || '';

Â  document.getElementById('tutorialModal').classList.remove('hidden');
}

async function deleteTut(r){
Â  if(!confirm(`Are you sure you want to delete the tutorial "${r.Title}"?`)) return;
Â  showLoader(true);
Â  try {
Â  Â  const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({_method:'DELETE', Tutorial_ID: r.Tutorial_ID, id: r.Tutorial_ID}) });
Â  Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â  Â  const result = await res.json();
Â  Â  if (result.success === false) throw new Error(result.error || "Delete failed");
Â  Â  await loadTutorials();
Â  Â  alert('Tutorial deleted successfully.');
Â  } catch(err) {
Â  Â  console.error(err);
Â  Â  alert("Error deleting tutorial: " + err.message);
Â  }
Â  showLoader(false);
}

/* Tutorial modal wiring */
document.getElementById('addTutBtn').onclick = handleAddTut;
document.getElementById('tutorialCloseModal').onclick = () => { document.getElementById('tutorialModal').classList.add('hidden'); editingTutorial = null; };
document.getElementById('tutorialCancelBtn').onclick = () => { document.getElementById('tutorialModal').classList.add('hidden'); editingTutorial = null; };

/* Tutorial form submission */
document.getElementById('tutorialForm').onsubmit = async (e) => {
Â  e.preventDefault();
Â  const form = e.target;
Â  const data = Object.fromEntries(new FormData(form).entries());

Â  let method = "POST";
Â  if (editingTutorial) {
Â  Â  method = "PUT";
Â  Â  data._method = "PUT";
Â  Â  data.id = editingTutorial.Tutorial_ID;
Â  Â  data.Tutorial_ID = editingTutorial.Tutorial_ID;
Â  } else {
Â  Â  data.Tutorial_ID = data.Tutorial_ID || "NEW";
Â  }

Â  try {
Â  Â  showLoader(true);
Â  Â  const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(data) });
Â  Â  if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â  Â  const result = await res.json();
Â  Â  if (result.success === false) throw new Error(result.error || "Save failed");

Â  Â  document.getElementById('tutorialModal').classList.add('hidden');
Â  Â  editingTutorial = null;
Â  Â  await loadTutorials();
Â  Â  alert(method === "PUT" ? "Tutorial updated successfully!" : "Tutorial created successfully!");
Â  } catch(err) {
Â  Â  console.error("Tutorial save error:", err);
Â  Â  alert("Error saving tutorial: " + err.message);
Â  } finally {
Â  Â  showLoader(false);
Â  }
};

document.getElementById('tutSearchInput').addEventListener('input', renderTutorials);

</script>
</body>
</html>