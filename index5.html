<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KPI Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brandPrimary: '#4285F4',
            brandSuccess: '#34A853',
            brandDanger: '#EA4335',
            brandWarning: '#FBBC05'
          }
        }
      }
    }
  </script>
</head>

<body class="font-sans bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <header class="flex items-center justify-between bg-white dark:bg-gray-800 p-4 shadow-md sticky top-0">
    <h1 class="text-2xl font-bold text-brandPrimary">KPI Dashboard</h1>
    <button id="themeToggle" class="p-2 rounded-full border dark:border-gray-600">
      <span class="material-symbols-outlined">dark_mode</span>
    </button>
  </header>

  <main class="max-w-7xl mx-auto p-6 space-y-8">

    <!-- KPI CARDS -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="kpi-card bg-white dark:bg-gray-800 shadow rounded-xl p-4 border-t-4 border-brandPrimary">
        <span class="material-symbols-outlined text-2xl text-brandPrimary mb-1">group_work</span>
        <p class="text-xs font-medium uppercase text-gray-500">Total Campaigns</p>
        <p class="text-xl font-bold mt-1" id="cardCampaigns">—</p>
      </div>

      <div class="kpi-card bg-white dark:bg-gray-800 shadow rounded-xl p-4 border-t-4 border-brandPrimary">
        <span class="material-symbols-outlined text-2xl text-brandPrimary mb-1">checklist</span>
        <p class="text-xs font-medium uppercase text-gray-500">Total KPIs</p>
        <p class="text-xl font-bold mt-1" id="cardTotalKPI">—</p>
      </div>

      <div class="kpi-card bg-white dark:bg-gray-800 shadow rounded-xl p-4 border-t-4 border-brandSuccess">
        <span class="material-symbols-outlined text-2xl text-brandSuccess mb-1">task_alt</span>
        <p class="text-xs font-medium uppercase text-gray-500">Passed</p>
        <p class="text-xl font-bold mt-1 text-brandSuccess" id="cardPassed">—</p>
      </div>

      <div class="kpi-card bg-white dark:bg-gray-800 shadow rounded-xl p-4 border-t-4 border-brandDanger">
        <span class="material-symbols-outlined text-2xl text-brandDanger mb-1">cancel</span>
        <p class="text-xs font-medium uppercase text-gray-500">Failed</p>
        <p class="text-xl font-bold mt-1 text-brandDanger" id="cardFailed">—</p>
      </div>
    </div>

    <!-- KPI TABLE -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-xl overflow-x-auto">
      <h3 class="p-4 text-lg font-semibold border-b dark:border-gray-700">Campaign KPI Targets</h3>
      <table id="kpi-table" class="w-full text-sm">
        <thead class="bg-gray-100 dark:bg-gray-700">
          <tr>
            <th class="p-2 text-left">Campaign</th>
            <th class="p-2 text-left">KPI</th>
            <th class="p-2 text-right">Target</th>
            <th class="p-2 text-right">Threshold</th>
            <th class="p-2 text-right">Jan</th>
            <th class="p-2 text-right">Feb</th>
            <th class="p-2 text-right">Mar</th>
            <th class="p-2 text-right">Apr</th>
            <th class="p-2 text-right">May</th>
            <th class="p-2 text-right">Jun</th>
            <th class="p-2 text-right">Jul</th>
            <th class="p-2 text-right">Aug</th>
            <th class="p-2 text-right">Sep</th>
            <th class="p-2 text-right">Oct</th>
            <th class="p-2 text-right">Nov</th>
            <th class="p-2 text-right">Dec</th>
            <th class="p-2 text-right text-green-600">Months Passed</th>
            <th class="p-2 text-right text-red-600">Months Failed</th>
          </tr>
        </thead>
        <tbody id="kpiBody" class="divide-y dark:divide-gray-700">
          <tr><td colspan="18" class="text-center p-4 text-gray-500">Loading data...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- GOOGLE CHART -->
    <div id="chart-container" class="bg-white dark:bg-gray-800 shadow rounded-xl p-4">
      <h3 class="text-lg font-semibold mb-4">Monthly KPI Trend</h3>
      <div id="chart_div" style="height:400px;"></div>
    </div>

  </main>

  <script>
    /* CONFIG */
    const KPI_API_URL = "https://script.google.com/macros/s/AKfycbzfwllapfajhXwJZ8gIYzlKq6mA6MRfBrm1LiiuY42QpTVAc0IL1vJ39Z59zP5Iy4Zx/exec";

    let rawData = {};
    let googleLoaded = false;

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(() => googleLoaded = true);

    function formatNumber(value) {
      const num = parseFloat(value);
      return isNaN(num) ? '—' : num.toFixed(1);
    }

    function colorize(value, target) {
      const num = parseFloat(value);
      const tgt = parseFloat(target);
      if (isNaN(num) || isNaN(tgt)) return `<span>${value || '—'}</span>`;
      const color = num >= tgt ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';
      return `<span class="${color}">${num.toFixed(1)}</span>`;
    }

    function drawGoogleChart(kpi) {
      if (!googleLoaded || !kpi) return;

      const months = Object.keys(kpi.monthly);
      const values = Object.values(kpi.monthly).map(v => parseFloat(v) || 0);
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Month');
      data.addColumn('number', kpi.name);
      data.addRows(months.map((m, i) => [m, values[i]]));

      const options = {
        height: 400,
        curveType: 'function',
        legend: { position: 'bottom' },
        colors: ['#4285F4'],
        backgroundColor: 'transparent',
        hAxis: { title: 'Month' },
        vAxis: { title: 'Value', minValue: 0 },
      };

      const chart = new google.visualization.LineChart(document.getElementById('chart_div'));
      chart.draw(data, options);
    }

    async function fetchKPIData() {
      const tbody = document.getElementById('kpiBody');
      tbody.innerHTML = '<tr><td colspan="18" class="text-center p-4 text-gray-500">Fetching data...</td></tr>';
      try {
        const res = await fetch(KPI_API_URL);
        const data = await res.json();
        rawData = data;

        renderKPITable(data);
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="18" class="text-center p-4 text-red-500">Error fetching data</td></tr>`;
        console.error(err);
      }
    }

    function renderKPITable(data) {
      const tbody = document.getElementById('kpiBody');
      tbody.innerHTML = '';
      let totalKpi = 0, passCount = 0, failCount = 0;

      Object.entries(data).forEach(([camp, kpis]) => {
        kpis.forEach(kpi => {
          totalKpi++;
          const months = Object.keys(kpi.monthly);
          let passed = 0, failed = 0;

          const row = document.createElement('tr');
          row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer";

          let rowHtml = `
            <td class="p-2 font-semibold">${camp}</td>
            <td class="p-2">${kpi.name}</td>
            <td class="p-2 text-right">${formatNumber(kpi.target)}</td>
            <td class="p-2 text-right">${formatNumber(kpi.threshold)}</td>
          `;

          months.forEach(m => {
            const val = kpi.monthly[m];
            const tgt = kpi.target;
            const num = parseFloat(val);
            const tnum = parseFloat(tgt);
            if (!isNaN(num) && !isNaN(tnum)) {
              if (num >= tnum) passed++; else failed++;
            }
            rowHtml += `<td class="p-2 text-right">${colorize(val, tgt)}</td>`;
          });

          rowHtml += `<td class="p-2 text-right text-green-600 font-semibold">${passed}</td>`;
          rowHtml += `<td class="p-2 text-right text-red-600 font-semibold">${failed}</td>`;

          passCount += passed > failed ? 1 : 0;
          failCount += failed >= passed ? 1 : 0;

          row.innerHTML = rowHtml;
          row.addEventListener('click', () => drawGoogleChart(kpi));
          tbody.appendChild(row);
        });
      });

      document.getElementById('cardCampaigns').textContent = Object.keys(data).length;
      document.getElementById('cardTotalKPI').textContent = totalKpi;
      document.getElementById('cardPassed').textContent = passCount;
      document.getElementById('cardFailed').textContent = failCount;
    }

    /* THEME */
    const themeBtn = document.getElementById('themeToggle');
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const icon = document.body.classList.contains('dark') ? 'light_mode' : 'dark_mode';
      themeBtn.innerHTML = `<span class="material-symbols-outlined">${icon}</span>`;
    });

    document.addEventListener('DOMContentLoaded', fetchKPIData);
  </script>
</body>
</html>
