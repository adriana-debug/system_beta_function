<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTE Form Log & Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#1D4ED8', // Blue-700
                        'brand-secondary': '#FBBF24', // Amber-400
                        'danger': '#EF4444', // Red-500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        };
    </script>
    <style>
        /* Custom styles for the responsive table and modal */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Responsive Table */
        @media (max-width: 768px) {
            .responsive-table tr {
                border-top: 1px solid #e5e7eb;
                margin-bottom: 0.5rem;
                display: block;
            }

            .responsive-table td {
                display: flex;
                justify-content: space-between;
                padding: 0.75rem 1rem;
                border: none !important;
                /* Remove cell borders */
            }

            .responsive-table td::before {
                /* Label the data for small screens */
                content: attr(data-label);
                font-weight: 600;
                margin-right: 1rem;
            }

            .responsive-table thead {
                display: none;
            }

            .responsive-table tbody tr:last-child {
                border-bottom: 1px solid #e5e7eb;
            }
        }

        /* Preview Modal Styles - A4 Look */
        .page-preview {
            width: 8.5in;
            height: 11in;
            margin: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: white;
            flex-shrink: 0;
            overflow: hidden;
            /* iframe will handle the content's internal scroll */
        }

        /* Responsive preview layout */
        @media (max-width: 1024px) {
            .page-preview-container {
                flex-direction: column;
                align-items: center;
            }

            .page-preview {
                width: 100%;
                max-width: 8.5in;
                height: 90vh;
                /* Allow scrolling on smaller screens */
            }
        }

        .page-preview-container {
            display: flex;
            flex-wrap: nowrap;
            /* Prevent wrapping on desktop */
            overflow-x: auto;
            /* Scroll horizontally if necessary on desktop */
            padding: 1rem;
            justify-content: center;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <!-- Message Box (Custom Alert/Toast) -->
    <div id="messageBox"
        class="fixed top-4 right-4 z-50 bg-brand-primary text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0 min-w-[200px] text-center">
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex justify-between items-center bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800">NTE Form Log</h1>
            <button id="newRecordBtn"
                class="bg-brand-primary hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                <i data-feather="plus-circle" class="w-5 h-5 mr-2"></i>
                New NTE Form
            </button>
        </header>

        <!-- Main Data Table -->
        <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
            <table class="w-full text-left responsive-table">
                <thead class="bg-gray-100 text-gray-600 uppercase text-sm">
                    <tr>
                        <th class="py-3 px-4 rounded-tl-lg">ID</th>
                        <th class="py-3 px-4">Employee</th>
                        <th class="py-3 px-4">Department</th>
                        <th class="py-3 px-4">Date Issued</th>
                        <th class="py-3 px-4">Supervisor</th>
                        <th class="py-3 px-4 rounded-tr-lg text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="recordsTableBody" class="text-gray-700 divide-y divide-gray-200">
                    <!-- Data rows will be injected here -->
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">Loading records...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ---------------------------------------------------- -->
    <!-- CREATE/UPDATE MODAL (Form Modal) -->
    <!-- ---------------------------------------------------- -->
    <div id="formModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-40 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 md:m-8 overflow-y-auto max-h-[90vh]">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="formModalTitle" class="text-2xl font-semibold text-gray-800">New NTE Form</h2>
                <button onclick="closeFormModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="nteForm" class="p-6 space-y-4">
                <input type="hidden" id="recordId">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Employee Name -->
                    <div>
                        <label for="employeeName" class="block text-sm font-medium text-gray-700">Employee Name *</label>
                        <input type="text" id="employeeName" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-brand-primary focus:border-brand-primary">
                    </div>

                    <!-- Employee Number -->
                    <div>
                        <label for="employeeNumber" class="block text-sm font-medium text-gray-700">Employee Number
                            *</label>
                        <input type="text" id="employeeNumber" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-brand-primary focus:border-brand-primary">
                    </div>

                    <!-- Date Issued -->
                    <div>
                        <label for="dateIssued" class="block text-sm font-medium text-gray-700">Date Issued *</label>
                        <input type="date" id="dateIssued" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-brand-primary focus:border-brand-primary">
                    </div>

                    <!-- Supervisor -->
                    <div>
                        <label for="supervisor" class="block text-sm font-medium text-gray-700">Supervisor *</label>
                        <input type="text" id="supervisor" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-brand-primary focus:border-brand-primary">
                    </div>
                    
                    <!-- Date of Incident -->
                    <div>
                        <label for="dateOfIncident" class="block text-sm font-medium text-gray-700">Date of Incident</label>
                        <input type="date" id="dateOfIncident"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-brand-primary focus:border-brand-primary">
                    </div>

                    <!-- Place of Incident -->
                    <div>
                        <label for="placeOfIncident" class="block text-sm font-medium text-gray-700">Place of Incident</label>
                        <input type="text" id="placeOfIncident"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-brand-primary focus:border-brand-primary">
                    </div>
                </div>
                
                <!-- Position / Department -->
                <div>
                    <label for="positionDepartment" class="block text-sm font-medium text-gray-700">Position /
                        Department *</label>
                    <input type="text" id="positionDepartment" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-brand-primary focus:border-brand-primary">
                </div>

                <!-- Narration of Incident (IR Content) -->
                <div>
                    <label for="narrationOfIncident" class="block text-sm font-medium text-gray-700">Narration of Incident
                        (IR Content) *</label>
                    <textarea id="narrationOfIncident" rows="4" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-brand-primary focus:border-brand-primary"></textarea>
                </div>
                
                <!-- Explanation (NTE Content) -->
                <div>
                    <label for="explanation" class="block text-sm font-medium text-gray-700">Explanation Details (NTE
                        Content)</label>
                    <textarea id="explanation" rows="4"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-brand-primary focus:border-brand-primary"></textarea>
                </div>

                <!-- Consequence -->
                <div>
                    <label for="consequence" class="block text-sm font-medium text-gray-700">Possible Consequence</label>
                    <textarea id="consequence" rows="2"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-brand-primary focus:border-brand-primary"></textarea>
                </div>

                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="closeFormModal()"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-200">Cancel</button>
                    <button type="submit" id="saveBtn"
                        class="bg-brand-primary hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">
                        Save Form
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- ---------------------------------------------------- -->
    <!-- PREVIEW MODAL -->
    <!-- ---------------------------------------------------- -->
    <div id="previewModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden items-center justify-center z-40 transition-opacity duration-300">
        <div class="bg-gray-100 rounded-xl shadow-2xl w-full h-full p-4 overflow-hidden flex flex-col">
            <div class="p-3 bg-white rounded-t-xl border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                <h2 id="previewModalTitle" class="text-xl font-semibold text-gray-800">Document Preview</h2>
                <button onclick="closePreviewModal()"
                    class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full transition duration-200">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="previewContent" class="flex-grow overflow-auto page-preview-container">
                <!-- Two A4 preview pages will be inserted here -->
                <p class="text-center text-gray-500 py-12">Loading preview...</p>
            </div>
        </div>
    </div>


    <script>
        // ***************************************************************
        // CRITICAL: Replace the placeholder URL below with your actual,
        // deployed Google Apps Script Web App URL (must end in /exec).
        // ***************************************************************
        const IRNTE_API_URL = 'https://script.google.com/macros/s/AKfycbyNRV6JAHmuqtjdH9j9HIHyq_qbtAx0oEgPEhr_I2eg_K6U9dFgJEXv9yYBYV_Xo_EzrA/exec'; // <--- PASTE YOUR DEPLOYED URL HERE

        // --- Custom Message Box (replacing alert()) ---
        function showMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = 'fixed top-4 right-4 z-50 p-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 min-w-[200px] text-center';

            let bgColor = 'bg-brand-primary';
            if (type === 'error') bgColor = 'bg-danger';
            if (type === 'warning') bgColor = 'bg-brand-secondary';

            box.classList.add(bgColor, 'text-white', 'block');
            setTimeout(() => box.classList.remove('opacity-0'), 10);

            setTimeout(() => {
                box.classList.add('opacity-0');
                setTimeout(() => box.classList.remove('block'), 300);
            }, 3000);
        }

        // --- Loading State ---
        function showLoading(message = "Processing...") {
            showMessage(message, 'warning');
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('saveBtn').textContent = message;
        }

        function hideLoading() {
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('saveBtn').textContent = 'Save Form';
            document.getElementById('messageBox').classList.add('hidden');
        }

        // --- Modal Control ---
        function openFormModal(record = null) {
            const modal = document.getElementById('formModal');
            const form = document.getElementById('nteForm');
            form.reset();
            document.getElementById('recordId').value = '';

            if (record) {
                document.getElementById('formModalTitle').textContent = `Edit NTE Form (ID: ${record.id})`;
                document.getElementById('recordId').value = record.id;
                document.getElementById('employeeName').value = record.employeeName || '';
                document.getElementById('employeeNumber').value = record.employeeNumber || '';
                // Format date for input[type=date]
                document.getElementById('dateIssued').value = record.dateIssued ? new Date(record.dateIssued).toISOString().split('T')[0] : '';
                document.getElementById('supervisor').value = record.supervisor || '';
                document.getElementById('positionDepartment').value = record.positionDepartment || '';
                document.getElementById('narrationOfIncident').value = record.narrationOfIncident || '';
                document.getElementById('explanation').value = record.explanation || '';
                document.getElementById('consequence').value = record.consequence || '';
                document.getElementById('dateOfIncident').value = record.dateOfIncident ? new Date(record.dateOfIncident).toISOString().split('T')[0] : '';
                document.getElementById('placeOfIncident').value = record.placeOfIncident || '';

            } else {
                document.getElementById('formModalTitle').textContent = 'New NTE Form';
                // Set default date to today
                document.getElementById('dateIssued').value = new Date().toISOString().split('T')[0];
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeFormModal() {
            const modal = document.getElementById('formModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function openPreviewModal() {
            const modal = document.getElementById('previewModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('previewContent').innerHTML = '<p class="text-center text-gray-500 py-12">Loading preview...</p>'; // Clear content
        }

        // --- API & CRUD Logic ---

        // (R) READ: Fetch all records and render the table
        async function loadRecords() {
            document.getElementById('recordsTableBody').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Loading records...</td></tr>';

            try {
                const res = await fetch(`${IRNTE_API_URL}?action=getIRNTE`);
                const result = await res.json();

                if (result.status === 'ERROR') throw new Error(result.error);

                renderRecords(result.data);

            } catch (error) {
                console.error("Error loading records:", error);
                document.getElementById('recordsTableBody').innerHTML = `<tr><td colspan="6" class="text-center py-8 text-danger font-semibold">Failed to load records: ${error.message}</td></tr>`;
                showMessage(`Failed to load records: ${error.message}`, 'error');
            }
            feather.replace();
        }

        // Render the data table
        function renderRecords(records) {
            const tbody = document.getElementById('recordsTableBody');
            if (!records || records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No NTE Forms found. Click "New NTE Form" to add one.</td></tr>';
                return;
            }

            const rows = records.map(record => {
                const dateIssued = record.dateIssued ? new Date(record.dateIssued).toLocaleDateString() : 'N/A';

                return `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="py-3 px-4" data-label="ID">${record.id}</td>
                        <td class="py-3 px-4 font-medium" data-label="Employee">${record.employeeName} (${record.employeeNumber})</td>
                        <td class="py-3 px-4" data-label="Department">${record.positionDepartment || 'N/A'}</td>
                        <td class="py-3 px-4" data-label="Date Issued">${dateIssued}</td>
                        <td class="py-3 px-4" data-label="Supervisor">${record.supervisor}</td>
                        <td class="py-3 px-4 text-right" data-label="Actions">
                            <div class="flex justify-end space-x-2">
                                <button onclick="handlePreview(${record.id})" title="Preview Document"
                                    class="text-brand-primary hover:text-blue-700 p-1 rounded-full bg-blue-50 transition">
                                    <i data-feather="eye" class="w-5 h-5"></i>
                                </button>
                                <button onclick="handleEdit(${record.id})" title="Edit Form"
                                    class="text-brand-secondary hover:text-yellow-600 p-1 rounded-full bg-yellow-50 transition">
                                    <i data-feather="edit-2" class="w-5 h-5"></i>
                                </button>
                                <button onclick="handleDelete(${record.id})" title="Delete Form"
                                    class="text-danger hover:text-red-700 p-1 rounded-full bg-red-50 transition">
                                    <i data-feather="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
            feather.replace(); // Re-render icons after DOM update
        }

        // (C/U) CREATE/UPDATE: Handle form submission
        document.getElementById('nteForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('recordId').value;
            const isUpdate = !!id;

            const data = {
                // Ensure field names match the camelCase headers expected by Code.gs
                id: isUpdate ? parseInt(id, 10) : undefined,
                employeeName: document.getElementById('employeeName').value,
                employeeNumber: document.getElementById('employeeNumber').value,
                dateIssued: document.getElementById('dateIssued').value,
                supervisor: document.getElementById('supervisor').value,
                positionDepartment: document.getElementById('positionDepartment').value,
                narrationOfIncident: document.getElementById('narrationOfIncident').value,
                explanation: document.getElementById('explanation').value,
                consequence: document.getElementById('consequence').value,
                dateOfIncident: document.getElementById('dateOfIncident').value,
                placeOfIncident: document.getElementById('placeOfIncident').value,
            };

            const action = isUpdate ? 'updateIRNTE' : 'createIRNTE';
            showLoading(isUpdate ? "Updating record..." : "Creating record...");

            try {
                const res = await fetch(IRNTE_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, data })
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ error: 'Unknown server error' }));
                    throw new Error(errorData.error || 'Server responded with an error.');
                }

                const result = await res.json();
                if (result.status === 'ERROR') throw new Error(result.error);

                closeFormModal();
                showMessage(`Record successfully ${isUpdate ? 'updated' : 'created'}!`);
                await loadRecords();

            } catch (error) {
                console.error(`Error ${isUpdate ? 'updating' : 'creating'} record:`, error);
                showMessage(`Failed to ${isUpdate ? 'update' : 'create'} record: ${error.message}.`, 'error');
            } finally {
                hideLoading();
            }
        });

        // Event handler for New Record button
        document.getElementById('newRecordBtn').addEventListener('click', () => openFormModal());

        // Event handler for Edit button
        async function handleEdit(id) {
            // Find the record locally (assuming data is already loaded in renderRecords)
            const res = await fetch(`${IRNTE_API_URL}?action=getIRNTE`);
            const result = await res.json();
            const records = result.data || [];
            const recordToEdit = records.find(r => r.id === id);

            if (recordToEdit) {
                openFormModal(recordToEdit);
            } else {
                showMessage(`Record ID ${id} not found. Please refresh.`, 'error');
            }
        }

        // (D) DELETE: Handle delete action
        function handleDelete(id) {
            // Custom confirmation logic
            const modal = document.getElementById('formModal');
            if (!modal.classList.contains('hidden')) return; // Prevent multiple modals

            if (!confirm(`Are you sure you want to permanently delete record ID ${id}?`)) {
                return;
            }
            executeDeleteRecord(id);
        }

        async function executeDeleteRecord(id) {
            showLoading("Deleting record...");

            try {
                const res = await fetch(IRNTE_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'deleteIRNTE', id: parseInt(id, 10) })
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ error: 'Unknown server error' }));
                    throw new Error(errorData.error || 'Server responded with an error.');
                }

                const result = await res.json();
                if (result.status === 'ERROR') throw new Error(result.error);

                showMessage("Record successfully deleted!");
                await loadRecords(); // Refresh data

            } catch (error) {
                console.error("Error deleting record:", error);
                showMessage(`Failed to delete record: ${error.message}.`, 'error');
            } finally {
                hideLoading();
            }
        }

        // (P) PREVIEW: Handle two-page document preview
        async function handlePreview(id) {
            openPreviewModal();
            const previewContentDiv = document.getElementById('previewContent');
            previewContentDiv.innerHTML = '<p class="text-center text-gray-500 py-12">Fetching document preview...</p>';
            document.getElementById('previewModalTitle').textContent = `Document Preview (ID: ${id})`;

            try {
                const res = await fetch(`${IRNTE_API_URL}?action=preview&id=${id}`);
                const result = await res.json();

                if (result.status === 'ERROR') throw new Error(result.error);

                const [irHtml, nteHtml] = result.pages;
                document.getElementById('previewModalTitle').textContent = `Document Preview: ${result.documentName}`;

                // Create and populate two iframe elements for a secure and true-to-print preview
                previewContentDiv.innerHTML = `
                    <div class="page-preview flex-col">
                        <iframe id="irPage" class="w-full h-full border-none"></iframe>
                        <div class="text-center text-gray-500 text-xs p-1">Page 1: Incident Report</div>
                    </div>
                    <div class="page-preview flex-col">
                        <iframe id="ntePage" class="w-full h-full border-none"></iframe>
                        <div class="text-center text-gray-500 text-xs p-1">Page 2: Notice to Explain</div>
                    </div>
                `;

                // Write the generated HTML into the iframes
                document.getElementById('irPage').srcdoc = irHtml;
                document.getElementById('ntePage').srcdoc = nteHtml;

            } catch (error) {
                console.error("Error generating preview:", error);
                previewContentDiv.innerHTML = `<p class="text-center text-danger py-12">Failed to load preview: ${error.message}</p>`;
                showMessage(`Failed to generate preview: ${error.message}`, 'error');
            }
        }
        
        // Custom confirm for better UX
        function confirm(message) {
            return window.confirm(message);
        }

        // --- INIT ---
        window.onload = () => {
            loadRecords();
            feather.replace();
        };

    </script>
</body>

</html>
