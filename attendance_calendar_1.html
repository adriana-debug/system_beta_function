<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPO Attendance Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>

    <script>
        // Configure Tailwind Colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#CBEB33',
                        brandlight: '#D9F25A'
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Modal Styling for Alerts/Loading */
        #custom-message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            min-width: 300px;
        }

        /* Essential Status Colors for Monthly Calendar Cells (Ensuring Tailwind utility classes are defined) */
        .bg-\[\#38761D\] { background-color: #38761D; } /* P (Dark Green) */
        .bg-\[\#00FF00\] { background-color: #00FF00; } /* HD (Lime Green) */
        .bg-\[\#F59E0B\] { background-color: #F59E0B; } /* L (Amber) */
        .bg-\[\#6FA8DC\] { background-color: #6FA8DC; } /* SL (Light Blue) */
        .bg-\[\#8E7CC3\] { background-color: #8E7CC3; } /* T (Purple) */
        .bg-\[\#0000FF\] { background-color: #0000FF; } /* VL (Blue) */
        .bg-\[\#00FFFF\] { background-color: #00FFFF; } /* SUS (Cyan) */
        .bg-\[\#9CA3AF\] { background-color: #9CA3AF; } /* Off (Gray) */
        .bg-\[\#EF4444\] { background-color: #EF4444; } /* A (Red) */
        .bg-\[\#14B8A6\] { background-color: #14B8A6; } /* H (Teal) */
    </style>
</head>

<body class="bg-gray-50 text-slate-800">
    <div class="flex min-h-screen">

        <aside class="w-64 bg-white shadow-xl flex flex-col">
            <div class="p-6 flex flex-col items-center gap-2">
                <img src="https://placehold.co/80x80/CBEB33/1e293b?text=DM" alt="Logo"
                    class="w-20 h-20 rounded-full object-cover mb-2">
                <h1 class="text-xl font-bold text-slate-900 text-center">Digital Minds BPO</h1>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg bg-brand font-semibold text-slate-900 transition">
                    <i data-feather="calendar" class="mr-3 text-slate-700"></i> Attendance Dashboard
                </a>
            </nav>

            <div class="p-4">
                <button
                    class="w-full py-2 bg-brand hover:bg-brandlight rounded-lg font-semibold text-slate-900 transition">Logout</button>
            </div>
        </aside>

        <main class="flex-1 p-6">

            <div id="custom-message-box" class="hidden bg-white rounded-lg shadow-2xl p-6 border-t-4 border-brand">
                <div id="message-content" class="text-slate-800 font-medium"></div>
                <button id="close-message-box"
                    class="hidden mt-4 px-4 py-2 bg-brand hover:bg-brandlight rounded-lg text-sm font-semibold">Close</button>
            </div>

            <section id="attendance-dashboard">
                <div class="bg-white rounded-xl shadow-lg p-6">

                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h1 class="text-3xl font-bold text-slate-900">Monthly Attendance Dashboard</h1>
                        <div class="flex space-x-4">
                            <select id="monthSelector"
                                class="bg-white border border-gray-300 px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-brand">
                                <option value="" disabled selected>Select Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>

                            <select id="rosterSelector"
                                class="bg-white border border-gray-300 px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-brand">
                                <option value="">All Teams</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-8 mb-12">
                        <div class="bg-white rounded-2xl shadow-lg p-6 h-40 flex flex-col justify-between border-t-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold">Present</h2>
                                <i data-feather="user-check" class="text-green-500"></i>
                            </div>
                            <p id="kpi-present" class="text-4xl font-bold text-green-500">0</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6 h-40 flex flex-col justify-between border-t-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold">Absent</h2>
                                <i data-feather="user-x" class="text-red-500"></i>
                            </div>
                            <p id="kpi-absent" class="text-4xl font-bold text-red-500">0</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6 h-40 flex flex-col justify-between border-t-4 border-yellow-500">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold">Tardiness</h2>
                                <i data-feather="clock" class="text-yellow-500"></i>
                            </div>
                            <p id="kpi-tardy" class="text-4xl font-bold text-yellow-500">0</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6 h-40 flex flex-col justify-between border-t-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold">Planned Leave</h2>
                                <i data-feather="activity" class="text-blue-500"></i>
                            </div>
                            <p id="kpi-leave" class="text-4xl font-bold text-blue-500">0</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6 h-40 flex flex-col justify-between border-t-4 border-purple-500">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold">Attendance Score</h2>
                                <i data-feather="pie-chart" class="text-purple-500"></i>
                            </div>
                            <p id="kpi-score" class="text-4xl font-bold text-purple-500">0%</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-6 gap-10">
                        <div class="lg:col-span-4 bg-white rounded-2xl shadow-lg p-8">
                            <h2 class="text-xl font-semibold mb-6">Monthly Campaign Summary</h2>
                            <div class="overflow-x-auto">
                                <table class="table-fixed border-collapse text-xs w-full min-w-[500px]">
                                    <thead>
                                        <tr class="bg-gray-100 text-gray-700">
                                            <th class="p-2 text-left">Campaign</th>
                                            <th class="p-2 text-center">Present</th>
                                            <th class="p-2 text-center">Late</th>
                                            <th class="p-2 text-center">Half Day</th>
                                            <th class="p-2 text-center">Absent</th>
                                            <th class="p-2 text-center">Score</th>
                                        </tr>
                                    </thead>
                                    <tbody id="campaign-summary-body-monthly">
                                        <tr>
                                            <td colspan="6" class="text-center py-4 text-gray-400">Select month and team to load data.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-8">
                            <h2 class="text-xl font-semibold mb-6">Legend</h2>
                            <div class="space-y-4 text-sm">
                                <div class="flex items-start space-x-3">
                                    <div class="h-2 w-2 bg-[#38761D] rounded-full mt-2"></div><span>P – Present</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="h-2 w-2 bg-[#00FF00] rounded-full mt-2"></div><span>HD – Half Day</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="h-2 w-2 bg-[#F59E0B] rounded-full mt-2"></div><span>L – Late</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="h-2 w-2 bg-[#6FA8DC] rounded-full mt-2"></div><span>SL – Sick Leave</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="h-2 w-2 bg-[#8E7CC3] rounded-full mt-2"></div><span>T – Training</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="h-2 w-2 bg-[#0000FF] rounded-full mt-2"></div><span>VL – Vacation Leave</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="h-2 w-2 bg-[#00FFFF] rounded-full mt-2"></div><span>SUS – Suspended</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="h-2 w-2 bg-[#9CA3AF] rounded-full mt-2"></div><span>Off – Day Off</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="h-2 w-2 bg-[#EF4444] rounded-full mt-2"></div><span>A – Absent</span>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <div class="h-2 w-2 bg-[#14B8A6] rounded-full mt-2"></div><span>H – Holiday</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h2 class="text-2xl font-bold mt-12 mb-6 text-gray-800">Campaign Feed (Monthly Calendar)</h2>
                    <div id="campaign-feed" class="space-y-6">
                        <p class="text-center text-gray-400 py-10">Select month and team to load attendance calendars.</p>
                    </div>

                </div>
            </section>
        </main>
    </div>

    <footer class="mt-12 py-6 bg-gray-50 border-t">
        <div class="max-w-[1440px] mx-auto px-10 text-center text-sm text-gray-500">
            &copy; 2025 Digital Minds BPO. All rights reserved.
        </div>
    </footer>


    <script>
        // --- Configuration ---
        // IMPORTANT: Ensure this BASE_URL is correct and points to your working Google Apps Script deployment.
        const BASE_URL = "https://script.google.com/macros/s/AKfycbzrN_zWK3AtRd5gO5XG-nA5WYIvcDPnlUJ73PFmNghOzRfXs8r6he97FYxzmcoYXHihwg/exec";
        
        const CAMPAIGN_SUMMARY_BODY_MONTHLY = document.getElementById('campaign-summary-body-monthly');
        const CAMPAIGN_FEED = document.getElementById("campaign-feed");
        
        // Monthly Calendar Status Colors (Matches CSS style definition)
        const statusColors = {
            P: "bg-[#38761D]", HD: "bg-[#00FF00]", L: "bg-[#F59E0B]",
            SL: "bg-[#6FA8DC]", T: "bg-[#8E7CC3]", VL: "bg-[#0000FF]",
            SUS: "bg-[#00FFFF]", Off: "bg-[#9CA3AF]", A: "bg-[#EF4444]",
            H: "bg-[#14B8A6]", NA: ""
        };


        // --- Helper Functions ---

        /** Shows a custom message box for loading/errors. */
        function showMessageBox(message, isError = false) {
            const box = document.getElementById('custom-message-box');
            const content = document.getElementById('message-content');
            const closeBtn = document.getElementById('close-message-box');

            content.textContent = message;
            box.classList.remove('hidden', 'border-brand', 'border-red-500');
            box.classList.add(isError ? 'border-red-500' : 'border-brand');
            closeBtn.classList.toggle('hidden', !isError); 

            if (isError) {
                closeBtn.onclick = hideMessageBox;
            }
        }

        /** Hides the custom message box. */
        function hideMessageBox() {
            document.getElementById('custom-message-box').classList.add('hidden');
        }


        // --- Monthly Dashboard Functions (Core Logic) ---

        /** Loads the list of available clusters/teams for the dropdown. */
        async function loadClusters() {
            try {
                const res = await fetch(BASE_URL + "?api=clusters");
                const clusters = await res.json();
                const select = document.getElementById("rosterSelector");
                
                select.innerHTML = `<option value="">All Teams</option>`; 
                
                clusters.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c;
                    opt.textContent = c;
                    opt.className = "bg-white text-gray-800";
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error("Failed to load clusters:", err);
            }
        }

        /** Fetches and renders all data for the Monthly Dashboard. */
        async function loadMonthlyDashboard() {
            showMessageBox("Loading monthly dashboard data. Please wait...");
            CAMPAIGN_FEED.innerHTML = ""; 

            const monthVal = document.getElementById("monthSelector").value;
            const clusterVal = document.getElementById("rosterSelector").value;

            // Stop if month is not selected
            if (!monthVal) {
                hideMessageBox();
                CAMPAIGN_FEED.innerHTML = `<p class="text-center text-gray-500 py-10">Please select a month to view the dashboard.</p>`;
                renderKPIs({ overall: {}, campaigns: {} });
                CAMPAIGN_SUMMARY_BODY_MONTHLY.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-400">Select month and team to load data.</td></tr>`;
                return;
            }

            try {
                // 1. Fetch Summary (KPIs and Monthly Campaign Summary)
                const summaryParams = new URLSearchParams({ api: "summary", month: monthVal, cluster: clusterVal });
                const summary = await (await fetch(BASE_URL + "?" + summaryParams.toString())).json();
                renderKPIs(summary);
                renderCampaignSummaryMonthly(summary);

                // 2. Fetch Calendars
                const calParams = new URLSearchParams({ api: "calendars", month: monthVal, cluster: clusterVal });
                const calData = await (await fetch(BASE_URL + "?" + calParams.toString())).json();
                renderCalendars(calData);

                hideMessageBox();
            } catch (err) {
                console.error("Monthly Dashboard Load Error:", err);
                renderKPIs({ overall: {}, campaigns: {} });
                CAMPAIGN_SUMMARY_BODY_MONTHLY.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Failed to load summary data. Please check BASE_URL and backend script.</td></tr>`;
                CAMPAIGN_FEED.innerHTML = `<p class="text-center text-red-500 py-10 font-medium">Failed to load monthly data. Please check the network or script URL.</p>`;
                showMessageBox(`Error: Could not retrieve monthly dashboard data. Please check the BASE_URL and backend script. Error: ${err.message}`, true);
            }
        }

        /** Renders the Key Performance Indicator (KPI) cards. */
        function renderKPIs(summary) {
            const present = (summary.overall.P || 0) + (summary.overall.T || 0) + (summary.overall.L || 0) + (summary.overall.HD || 0); 
            const absent = (summary.overall.A || 0) + (summary.overall.SUS || 0); 
            const tardy = summary.overall.L || 0; 
            const leave = (summary.overall.VL || 0) + (summary.overall.SL || 0); 

            // Attendance Score calculation logic: (Present / Total Logged Days) * 100
            const total = present + absent + leave;
            const score = total > 0 ? Math.round((present / total) * 100) : 0;

            document.getElementById("kpi-present").textContent = present;
            document.getElementById("kpi-absent").textContent = absent;
            document.getElementById("kpi-tardy").textContent = tardy;
            document.getElementById("kpi-leave").textContent = leave;
            document.getElementById("kpi-score").textContent = score + "%";
            
            feather.replace(); 
        }

        /** Renders the Monthly Campaign Summary Table. */
        function renderCampaignSummaryMonthly(summary) {
            const rows = Object.entries(summary.campaigns || {}).map(([campaign, stats]) => {
                // Calculate total entries for score calculation
                const total = Object.values(stats).reduce((a, b) => a + b, 0); 
                // Present statuses: P, T, L, HD
                const present_count = (stats.P || 0) + (stats.T || 0) + (stats.L || 0) + (stats.HD || 0);
                const score = total > 0 ? Math.round((present_count / total) * 100) : 0;
                
                return { 
                    campaign, 
                    P: stats.P || 0, 
                    L: stats.L || 0, 
                    HD: stats.HD || 0, 
                    A: stats.A || 0, 
                    score 
                };
            });
            rows.sort((a, b) => b.score - a.score); 

            const tbody = CAMPAIGN_SUMMARY_BODY_MONTHLY;
            if (rows.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-400">No campaign data available for this selection.</td></tr>`;
                 return;
            }

            tbody.innerHTML = rows.map(r => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-2 font-medium text-gray-700">${r.campaign}</td>
                    <td class="p-2 text-center">${r.P}</td>
                    <td class="p-2 text-center text-yellow-600">${r.L}</td>
                    <td class="p-2 text-center text-blue-600">${r.HD}</td>
                    <td class="p-2 text-center text-red-600">${r.A}</td>
                    <td class="p-2 text-center font-semibold ${r.score < 70 ? 'text-red-600' : r.score < 90 ? 'text-yellow-600' : 'text-green-600'}">${r.score}%</td>
                </tr>`).join("");
        }

        /** Renders the individual campaign attendance calendars. */
        function renderCalendars(campaigns) {
            CAMPAIGN_FEED.innerHTML = "";
            if (Object.keys(campaigns).length === 0) {
                CAMPAIGN_FEED.innerHTML = `<p class="text-center text-gray-500 py-10">No individual attendance calendar data found for the selected month/team.</p>`;
                return;
            }

            Object.entries(campaigns).forEach(([campaign, employees]) => {
                const card = document.createElement("div");
                card.className = "bg-white shadow-lg rounded-lg";
                
                const firstEmployeeDays = employees[Object.keys(employees)[0]];
                const numDays = firstEmployeeDays ? firstEmployeeDays.length : 31;

                card.innerHTML = `
                    <div class="p-6 border-b flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="h-10 w-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-semibold">
                                ${campaign.slice(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <p class="font-semibold text-slate-900">${campaign}</p>
                                <p class="text-sm text-slate-500">Attendance Calendar</p>
                            </div>
                        </div>
                    </div>
                    <div class="px-6 pb-6 overflow-x-auto">
                        <table class="table-fixed border-collapse text-xs w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border px-2 py-1 text-left min-w-[160px]">Employee</th>
                                    ${[...Array(numDays).keys()].map(d => `<th class="border px-1 py-1 w-6 text-center">${d + 1}</th>`).join("")}
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(employees).map(([name, days]) => `
                                    <tr>
                                        <td class="border px-2 py-1 font-medium text-gray-700">${name}</td>
                                        ${days.map(st => {
                                            if (st === "NA" || st === "Off") {
                                                // Pattern for Day Off/Non-Working Day
                                                return `<td class="border w-6 h-6" style="background:repeating-linear-gradient(45deg,#E5E7EB 0px,#E5E7EB 2px,#D1D5DB 2px,#D1D5DB 4px);" title="Day Off / N/A"></td>`;
                                            }
                                            // Status color
                                            return `<td class="border w-6 h-6 ${statusColors[st] || ""}" title="${st}"></td>`;
                                        }).join("")}
                                    </tr>
                                `).join("")}
                            </tbody>
                        </table>
                    </div>
                `;
                CAMPAIGN_FEED.appendChild(card);
            });
            feather.replace();
        }

        // --- Initialization and Event Handlers ---

        function initializeApp() {
            // Set default month to current month
            const now = new Date();
            document.getElementById("monthSelector").value = now.getMonth() + 1;
            
            // Initial render of zeros for KPIs
            renderKPIs({ overall: {}, campaigns: {} }); 

            // Load cluster options
            loadClusters();

            // Set up event listeners for filters (triggers data load)
            document.getElementById("monthSelector").addEventListener("change", loadMonthlyDashboard);
            document.getElementById("rosterSelector").addEventListener("change", loadMonthlyDashboard);

            // Initial data load 
            loadMonthlyDashboard();
            
            // Renders sidebar and KPI icons
            feather.replace(); 
        }

        // Run the initialization function when the DOM is ready
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>

</html>